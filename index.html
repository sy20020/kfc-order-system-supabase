<!DOCTYPE html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>肯德基自助点餐系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 所有样式保持不变... */
        /* 由于代码太长，这里省略CSS样式部分，保持原样 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .logo {
            font-size: 2.2rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo i {
            color: #ffcc00;
        }
        
        .header-info {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .info-item i {
            color: #ffcc00;
            font-size: 0.9rem;
        }
        
        .header-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 12px;
        }
        
        .header-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        
        .header-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.03);
        }
        
        .search-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 280px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid #e31837;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .search-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            background-color: #e31837;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .search-hint {
            font-size: 0.8rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .nav-menu {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        .nav-title {
            font-size: 1.3rem;
            color: #e31837;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meal-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #ffcc00;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        
        .meal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .meal-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #e31837;
        }
        
        .meal-price {
            font-size: 1.3rem;
            font-weight: bold;
            color: #e31837;
        }
        
        .meal-description {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }
        
        .meal-tag {
            display: inline-block;
            background-color: #ffcc00;
            color: #333;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 5px;
            margin-bottom: 4px;
        }
        
        .back-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            margin-bottom: 15px;
            text-decoration: none;
            width: fit-content;
        }
        
        .back-btn:hover {
            background-color: #c8102e;
            transform: scale(1.03);
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .menu-section {
            flex: 3;
            min-width: 280px;
        }
        
        .right-section {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
        }
        
        .delivery-form {
            background-color: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        /* 压缩购物车样式开始 */
        .cart-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #eee;
        }
        
        .cart-section .section-title {
            font-size: 1.2rem;
            margin-bottom: 12px;
            padding-bottom: 8px;
        }
        
        .cart-items {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-item-name {
            flex: 2;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .cart-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
            font-size: 0.9rem;
        }
        
        .cart-item-remove {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 8px;
            padding: 2px;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 2px solid #eee;
        }
        
        .total-price {
            color: #e31837;
        }
        
        .checkout-btn {
            background-color: #ffcc00;
            color: #333;
            border: none;
            padding: 10px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 12px;
            transition: all 0.3s;
        }
        
        .checkout-btn:hover {
            background-color: #e6b800;
            transform: scale(1.02);
        }
        
        .checkout-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        /* 压缩购物车样式结束 */
        
        .section-title {
            font-size: 1.5rem;
            color: #e31837;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ffcc00;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: #ffcc00;
        }
        
        .meal-options {
            margin-bottom: 20px;
        }
        
        .option-group {
            margin-bottom: 12px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #e31837;
        }
        
        .option-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #444;
            font-size: 1rem;
        }
        
        .option-rules {
            font-size: 0.8rem;
            color: #e31837;
            margin-bottom: 8px;
            padding: 4px 8px;
            background-color: #ffe6e6;
            border-radius: 4px;
            display: inline-block;
        }
        
        .option-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .option-item {
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 0.85rem;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 160px;
            position: relative;
        }
        
        .option-item:hover {
            background-color: #e9e9e9;
        }
        
        .option-item.selected {
            background-color: #e31837;
            color: white;
            border-color: #e31837;
        }
        
        .selection-counter {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }
        
        .counter-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: none;
            background-color: white;
            color: #e31837;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .counter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .counter-value {
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            font-size: 0.9rem;
        }
        
        .add-to-cart {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
            justify-content: center;
        }
        
        .add-to-cart:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        .add-to-cart:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .required {
            color: #e31837;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .pickup-type {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .pickup-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.3s;
            flex: 1;
            font-size: 0.9rem;
        }
        
        .pickup-type label:hover {
            border-color: #e31837;
        }
        
        .pickup-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .order-type {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .order-type label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .order-type label:hover {
            border-color: #e31837;
        }
        
        .order-type input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .delivery-fields, .pickup-fields {
            transition: all 0.3s;
        }
        
        .hidden {
            display: none;
        }
        
        .store-selection {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .store-selection .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        .info-method-selector {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        
        .method-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .method-option:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .method-option input:checked + span {
            font-weight: bold;
            color: #e31837;
        }
        
        .method-option input:checked {
            accent-color: #e31837;
        }
        
        .screenshot-upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .screenshot-upload-area:hover {
            border-color: #e31837;
            background-color: #fff5f5;
        }
        
        .screenshot-upload-area i {
            font-size: 36px;
            color: #e31837;
            margin-bottom: 8px;
        }
        
        .upload-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }
        
        .screenshot-preview {
            position: relative;
            margin-top: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background-color: #f9f9f9;
            max-width: 250px;
        }
        
        .screenshot-preview img {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 150px;
            object-fit: contain;
        }
        
        .remove-screenshot {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #e31837;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: #666;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .form-hint i {
            color: #ffcc00;
            font-size: 0.8rem;
        }
        
        .instructions {
            font-size: 0.85rem;
            color: #666;
            margin-top: 20px;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
        }
        
        .instructions li {
            margin-bottom: 4px;
            font-size: 0.85rem;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #666;
            border-top: 1px solid #eee;
            font-size: 0.85rem;
        }
        
        .highlight {
            color: #e31837;
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            background-color: #fff5f5;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #ffcc00;
            font-size: 0.9rem;
        }
        
        .highlight i {
            color: #ffcc00;
        }
        
        .selection-status {
            font-size: 0.8rem;
            color: #666;
            margin-top: 8px;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: inline-block;
        }
        
        .selection-status.valid {
            background-color: #e6f7e6;
            color: #2e7d32;
        }
        
        .selection-status.invalid {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .fixed-combo-items {
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .fixed-combo-item {
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
        }
        
        .fixed-combo-item:last-child {
            border-bottom: none;
        }
        
        .fixed-combo-item-name {
            font-weight: 500;
        }
        
        .fixed-combo-item-qty {
            color: #e31837;
            font-weight: bold;
        }
        
        .my-orders-section {
            background-color: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }
        
        .orders-search {
            margin-bottom: 15px;
        }
        
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .search-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .search-btn:hover {
            background-color: #c8102e;
        }
        
        .order-filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .order-filter-tab {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .order-filter-tab:hover {
            background-color: #e0e0e0;
        }
        
        .order-filter-tab.active {
            background-color: #e31837;
            color: white;
        }
        
        .user-order-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffcc00;
        }
        
        .user-order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .user-order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
        }
        
        .user-order-time {
            color: #666;
            font-size: 0.85rem;
        }
        
        .user-order-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .user-status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .user-status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .user-status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .user-order-items {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .user-order-item-detail {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }
        
        .user-order-item-detail:last-child {
            border-bottom: none;
        }
        
        .user-order-item-name {
            flex: 2;
        }
        
        .user-order-item-price {
            flex: 1;
            text-align: right;
            font-weight: bold;
            color: #e31837;
        }
        
        .user-order-info {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .user-order-info p {
            margin-bottom: 4px;
        }
        
        .user-order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.1rem;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 2px solid #eee;
            text-align: right;
        }
        
        .no-user-orders {
            text-align: center;
            padding: 30px 15px;
            color: #666;
        }
        
        .no-user-orders i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .user-id-info {
            background-color: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-id-label {
            font-weight: bold;
            color: #666;
        }
        
        .user-id-value {
            font-family: monospace;
            background-color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.8rem;
        }
        
        .admin-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 1200px;
            height: 100vh;
            background-color: white;
            z-index: 2000;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: none;
        }
        
        .admin-panel.active {
            transform: translateX(0);
            display: block;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }
        
        .panel-overlay.active {
            display: block;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .panel-header h2 {
            font-size: 1.5rem;
            margin: 0;
        }
        
        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .close-panel:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .panel-content {
            padding: 15px;
        }
        
        .admin-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .admin-tab {
            padding: 10px 18px;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            color: #666;
            font-weight: 500;
        }
        
        .admin-tab:hover {
            color: #e31837;
            background-color: #fff5f5;
        }
        
        .admin-tab.active {
            color: #e31837;
            border-bottom-color: #e31837;
            font-weight: bold;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .order-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .filter-btn:hover {
            background-color: #e0e0e0;
        }
        
        .filter-btn.active {
            background-color: #e31837;
            color: white;
        }
        
        .orders-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            min-height: 250px;
        }
        
        .admin-order-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #ffcc00;
            transition: all 0.3s;
        }
        
        .admin-order-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .order-id {
            font-weight: bold;
            color: #333;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }
        
        .order-time {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }
        
        .order-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .status-new {
            background-color: #ffebee;
            color: #e31837;
        }
        
        .status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .order-details {
            margin-bottom: 12px;
        }
        
        .order-items {
            margin-bottom: 8px;
        }
        
        .order-item-detail {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.85rem;
        }
        
        .order-total {
            font-weight: bold;
            color: #e31837;
            font-size: 1.1rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #eee;
        }
        
        .customer-info {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .customer-info p {
            margin-bottom: 4px;
        }
        
        .screenshot-container {
            margin-top: 12px;
        }
        
        .screenshot-container img {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .screenshot-container img:hover {
            transform: scale(1.02);
        }
        
        .no-orders {
            text-align: center;
            padding: 30px 15px;
            color: #666;
            grid-column: 1 / -1;
            width: 100%;
        }
        
        .no-orders i {
            font-size: 3rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .admin-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background-color: #333;
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .admin-btn:hover {
            background-color: #555;
            transform: scale(1.03);
        }
        
        .new-order-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: #e31837;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .modal-image {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2.5rem;
            cursor: pointer;
        }
        
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .password-modal.active {
            display: flex;
        }
        
        .password-box {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .password-box h3 {
            color: #e31837;
            margin-bottom: 15px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .password-input {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #e31837;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .password-btn {
            background-color: #e31837;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        
        .password-btn:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        .password-error {
            color: #e31837;
            margin-top: 12px;
            font-weight: bold;
            display: none;
            font-size: 0.9rem;
        }
        
        .meal-page-container {
            display: none;
        }
        
        .meal-page-container.active {
            display: block;
        }
        
        .meal-management {
            margin-top: 15px;
        }
        
        .meal-list {
            margin-bottom: 20px;
        }
        
        .meal-list-item {
            background-color: #f9f9f9;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #e31837;
        }
        
        .meal-list-item-info {
            flex: 1;
            font-size: 0.85rem;
        }
        
        .meal-list-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .edit-btn {
            background-color: #ffcc00;
            color: #333;
        }
        
        .edit-btn:hover {
            background-color: #e6b800;
        }
        
        .delete-btn {
            background-color: #e31837;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #c8102e;
        }
        
        .add-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .add-btn:hover {
            background-color: #3d8b40;
        }
        
        .meal-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 180px;
        }
        
        .option-groups-management {
            margin-top: 20px;
        }
        
        .option-group-item {
            background-color: #f0f0f0;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #4CAF50;
        }
        
        .option-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .option-group-title {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
        }
        
        .option-items-list {
            margin-top: 8px;
            padding-left: 15px;
        }
        
        .option-item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .option-item-list-item:last-child {
            border-bottom: none;
        }
        
        .no-meals-message {
            text-align: center;
            padding: 25px 15px;
            color: #666;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        
        .no-meals-message i {
            font-size: 2.5rem;
            color: #ddd;
            margin-bottom: 12px;
        }
        
        .fixed-items-management {
            margin-top: 15px;
            padding: 12px;
            background-color: #f0f0f0;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .fixed-item-list {
            margin-top: 8px;
        }
        
        .fixed-item-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #ddd;
            font-size: 0.85rem;
        }
        
        .fixed-item-list-item:last-child {
            border-bottom: none;
        }
        
        .status-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }
        
        .status-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .status-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 25px;
        }
        
        .status-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .status-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .status-slider:before {
            transform: translateX(24px);
        }
        
        .status-label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-right: 12px;
        }
        
        .status-active {
            color: #4CAF50;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .status-inactive {
            color: #f44336;
            font-weight: bold;
            font-size: 0.85rem;
        }
        
        .meal-card.inactive {
            opacity: 0.6;
            border-left: 4px solid #ccc;
            position: relative;
        }
        
        .meal-card.inactive:after {
            content: "已下架";
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #f44336;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .meal-card.inactive:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            cursor: not-allowed;
        }
        
        .meal-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .meal-filter-btn {
            padding: 6px 12px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .meal-filter-btn:hover {
            background-color: #e0e0e0;
        }
        
        .meal-filter-btn.active {
            background-color: #e31837;
            color: white;
        }
        
        .sort-order-container {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .sort-order-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 0.85rem;
        }
        
        .sort-order-buttons {
            display: flex;
            gap: 4px;
        }
        
        .sort-order-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .sort-order-btn:hover {
            background-color: #f0f0f0;
            border-color: #e31837;
            color: #e31837;
        }
        
        .sort-order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sort-order-btn:disabled:hover {
            background-color: white;
            border-color: #ddd;
            color: inherit;
        }
        
        .order-display {
            font-size: 0.8rem;
            color: #666;
            background-color: #f0f0f0;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 4000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e31837;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            margin-top: 15px;
            font-size: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 实时更新指示器 */
        .realtime-indicator {
            position: fixed;
            top: 70px;
            right: 15px;
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 18px;
            font-size: 0.8rem;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            animation: fadeInOut 2s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .submit-status {
            text-align: center;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #666;
        }
        
        .compress-progress {
            margin-top: 8px;
            padding: 6px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #666;
            display: none;
        }
        
        .compress-progress.active {
            display: block;
        }
        
        .compress-progress span {
            font-weight: bold;
            color: #e31837;
        }
        
        .screenshot-preview-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .image-info {
            font-size: 0.75rem;
            color: #666;
            background-color: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 2px solid #4CAF50;
        }
        
        .edit-form-container {
            display: none;
            margin-top: 15px;
        }
        
        .edit-form-container.active {
            display: block;
        }
        
        .show {
            display: block !important;
        }
        
        .hide {
            display: none !important;
        }
        
        .quick-submit {
            position: relative;
            overflow: hidden;
        }
        
        .quick-submit:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .quick-submit:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            20% {
                transform: scale(25, 25);
                opacity: 0.3;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        .admin-search-container {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .admin-search-box {
            flex: 1;
            min-width: 220px;
            position: relative;
        }
        
        .admin-search-input {
            width: 100%;
            padding: 8px 35px 8px 12px;
            border: 1px solid #e31837;
            border-radius: 20px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .admin-search-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(227, 24, 55, 0.2);
        }
        
        .admin-search-btn {
            position: absolute;
            right: 4px;
            top: 4px;
            background-color: #e31837;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
        }
        
        .admin-search-btn:hover {
            background-color: #c8102e;
        }
        
        .admin-search-hint {
            font-size: 0.8rem;
            color: #666;
            background-color: #f9f9f9;
            padding: 5px 8px;
            border-radius: 6px;
            border-left: 3px solid #4CAF50;
        }
        
        .delivery-tag {
            display: inline-block;
            background-color: #e31837;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        .no-delivery-tag {
            display: inline-block;
            background-color: #666;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 4px;
            margin-bottom: 2px;
        }
        
        /* 修改：订单确认模态框样式 - 修复滚动问题 */
        .order-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .order-confirm-modal.active {
            display: flex;
        }
        
        .order-confirm-box {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            height: 85vh;
            max-height: 85vh;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .order-confirm-header {
            background: linear-gradient(135deg, #e31837 0%, #c8102e 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
        }
        
        .order-confirm-title {
            font-size: 1.3rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-confirm-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .order-confirm-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .order-confirm-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .order-confirm-item {
            margin-bottom: 0;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .order-confirm-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .order-confirm-item-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e31837;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-confirm-item-content {
            padding-left: 10px;
        }
        
        .order-confirm-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .order-confirm-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .order-confirm-option:last-child {
            border-bottom: none;
        }
        
        .order-confirm-total {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #eee;
            color: #333;
            flex-shrink: 0;
        }
        
        .order-confirm-buttons {
            display: flex;
            gap: 15px;
            padding: 15px 20px 20px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .order-confirm-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .order-confirm-btn.cancel {
            background-color: #f0f0f0;
            color: #666;
        }
        
        .order-confirm-btn.cancel:hover {
            background-color: #e0e0e0;
            transform: scale(1.02);
        }
        
        .order-confirm-btn.confirm {
            background-color: #e31837;
            color: white;
        }
        
        .order-confirm-btn.confirm:hover {
            background-color: #c8102e;
            transform: scale(1.02);
        }
        
        /* 新增：修复反馈截图样式 */
        .feedback-upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f1f8e9;
            margin-top: 8px;
            font-size: 0.85rem;
            position: relative;
            overflow: hidden;
        }
        
        .feedback-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .feedback-upload-area:hover {
            border-color: #2e7d32;
            background-color: #e8f5e9;
        }
        
        .feedback-upload-area i {
            font-size: 20px;
            color: #4CAF50;
            margin-bottom: 6px;
        }
        
        .feedback-preview {
            position: relative;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px;
            background-color: #f9f9f9;
            display: none;
        }
        
        .feedback-preview.show {
            display: block;
        }
        
        .feedback-preview img {
            width: 100%;
            border-radius: 4px;
            display: block;
            max-height: 120px;
            object-fit: contain;
        }
        
        .remove-feedback {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .feedback-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            margin-top: 8px;
            display: none;
        }
        
        .feedback-btn.show {
            display: flex;
        }
        
        .feedback-btn:hover {
            background-color: #3d8b40;
        }
        
        /* 新增：反馈截图容器样式 - 美化 */
        .feedback-screenshot-container {
            margin-top: 12px;
            padding: 10px;
            background-color: #e8f5e9;
            border-radius: 8px;
            border: 1px solid #4CAF50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .feedback-screenshot-container h4 {
            color: #2e7d32;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .feedback-thumbnail {
            width: 100%;
            border-radius: 6px;
            border: 1px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .feedback-thumbnail:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* 新增：订单反馈截图显示在顶部 - 优化显示大小 */
        .order-feedback-top {
            margin-top: 8px;
            margin-bottom: 12px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .order-feedback-top h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 优化：增大订单反馈截图显示大小 */
        .order-feedback-thumbnail {
            max-width: 100%; /* 改为100%宽度，根据容器自适应 */
            width: auto;
            max-height: 250px; /* 增大最大高度 */
            border-radius: 8px;
            border: 2px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: block;
            margin: 0 auto; /* 居中显示 */
        }
        
        .order-feedback-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        /* 新增：顾客订单页面中的反馈截图显示优化 */
        .user-order-feedback-container {
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border-radius: 10px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .user-order-feedback-container h4 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-feedback-thumbnail {
            max-width: 100%; /* 改为100%宽度，根据容器自适应 */
            width: auto;
            max-height: 300px; /* 增大最大高度 */
            border-radius: 8px;
            border: 2px solid #4CAF50;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: block;
            margin: 0 auto; /* 居中显示 */
        }
        
        .user-feedback-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
     
      /* 紧凑版宅急送粘贴识别区域 */
      .delivery-paste-area {
          border: 2px dashed #4CAF50;
          border-radius: 10px;
          padding: 15px;
          margin-bottom: 15px;
          background-color: #f9f9f9;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      
      .delivery-paste-area:hover {
          border-color: #2e7d32;
          background-color: #f1f8e9;
      }
      
      #pasteTextarea {
          width: 100%;
          min-height: 80px;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 6px;
          font-size: 0.9rem;
          resize: vertical;
          transition: all 0.3s;
          background-color: white;
          font-family: inherit;
      }
      
      #pasteTextarea:focus {
          outline: none;
          border-color: #4CAF50;
          box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
      }
      
      #pasteTextarea::placeholder {
          color: #999;
      }
      
      .recognize-btn {
          background-color: #4CAF50;
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 20px;
          cursor: pointer;
          font-size: 0.9rem;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          transition: all 0.3s;
          align-self: flex-start;
      }
      
      .recognize-btn:hover {
          background-color: #3d8b40;
          transform: scale(1.05);
      }
       
/* 简化识别结果样式 */
.recognize-result {
    margin-top: 10px;
    padding: 12px;
    background-color: #e8f5e9;
    border-radius: 6px;
    border-left: 3px solid #4CAF50;
    font-size: 0.9rem;
}

.recognize-result p {
    margin-bottom: 6px;
    line-height: 1.4;
}

.recognize-result strong {
    color: #2e7d32;
    display: inline-block;
    min-width: 50px;
}
   
       @keyframes slideIn {
           from {
               opacity: 0;
               transform: translateY(10px);
           }
           to {
               opacity: 1;
               transform: translateY(0);
           }
       }
       
       .recognize-result p {
           margin-bottom: 8px;
           line-height: 1.5;
       }
       
       .recognize-result strong {
           color: #2e7d32;
           display: inline-block;
           min-width: 60px;
       }
        
        /* 新增：编辑套餐中的插入按钮样式 */
        .insert-buttons {
            display: flex;
            gap: 8px;
            margin-left: 8px;
        }
        
        .insert-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s;
        }
        
        .insert-btn:hover {
            border-color: #e31837;
            background-color: #fff5f5;
            color: #e31837;
        }
        
        .insert-btn.up {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .insert-btn.down {
            border-color: #2196F3;
            color: #2196F3;
        }
        
        /* 其他样式保持不变... */
        @media (max-width: 768px) {
            .delivery-paste-area {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            #pasteTextarea {
                min-height: 70px;
                font-size: 0.85rem;
            }
            
            .recognize-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
                width: 100%;
                justify-content: center;
            }
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: row;
                flex-wrap: wrap;
            }
            
            .menu-section {
                flex: 100%;
                order: 1;
                margin-bottom: 15px;
            }
            
            .right-section {
                flex: 100%;
                order: 2;
                display: flex;
                flex-direction: column;
            }
            
            .delivery-form {
                order: 1;
                width: 100%;
            }
            
            .cart-section {
                order: 2;
                width: 100%;
                position: static;
                margin-top: 15px;
            }
            
            .logo {
                font-size: 1.8rem;
            }
            
            .meal-card {
                padding: 12px;
            }
            
            .store-selection {
                flex-direction: column;
            }
            
            .store-selection .form-group {
                min-width: 100%;
            }
            
            .info-method-selector {
                flex-direction: column;
            }
            
            .admin-panel {
                width: 100%;
            }
            
            .orders-container {
                grid-template-columns: 1fr;
            }
            
            .admin-btn span {
                display: none;
            }
            
            .admin-btn {
                padding: 12px;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                justify-content: center;
                font-size: 1rem;
            }
            
            .option-items {
                flex-direction: column;
            }
            
            .option-item {
                min-width: 100%;
                justify-content: space-between;
            }
            
            .password-box {
                padding: 20px;
                width: 95%;
            }
            
            .meal-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            
            .meal-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .meal-list-item-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .option-group-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .header-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .header-btn {
                width: 180px;
                justify-content: center;
            }
            
            .sort-order-container {
                flex-wrap: wrap;
            }
            
            .search-container {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .pickup-type {
                flex-direction: column;
            }
            
            .pickup-type label {
                width: 100%;
            }
            
            .realtime-indicator {
                top: 60px;
                right: 10px;
                font-size: 0.75rem;
                padding: 5px 10px;
            }
            
            .admin-search-container {
                flex-direction: column;
            }
            
            .admin-search-box {
                min-width: 100%;
            }
            
            /* 移动端进一步压缩购物车 */
            .cart-items {
                max-height: 150px;
            }
            
            .cart-item {
                padding: 6px 0;
                font-size: 0.8rem;
            }
            
            .cart-section {
                padding: 12px;
            }
            
            /* 移动端订单确认模态框 */
            .order-confirm-box {
                width: 95%;
                height: 90vh;
                max-height: 90vh;
            }
            
            .order-confirm-buttons {
                flex-direction: column;
            }
            
            .order-confirm-body {
                padding: 15px;
                gap: 15px;
            }
            
            .order-confirm-item-title {
                font-size: 1rem;
            }
            
            /* 移动端优化反馈截图显示 */
            .order-feedback-thumbnail {
                max-height: 200px; /* 移动端适当减小 */
            }
            
            .user-feedback-thumbnail {
                max-height: 200px; /* 移动端适当减小 */
            }
            
            .order-feedback-top {
                padding: 12px;
            }
            
            .user-order-feedback-container {
                padding: 12px;
            }
            
            /* 移动端优化宅急送识别区域 */
            .delivery-paste-area {
                padding: 10px;
            }
            
            .insert-buttons {
                flex-direction: column;
                gap: 4px;
            }
        }
        /* 让整个配送表单更紧凑 */
        .manual-fields {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-input, textarea {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .form-label {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        /* 确保在桌面端保持左右布局 */
        @media (min-width: 769px) {
            .main-content {
                flex-direction: row;
            }
            
            .menu-section {
                flex: 3;
                order: 1;
            }
            
            .right-section {
                flex: 1;
                order: 2;
                display: flex;
                flex-direction: column;
            }
            
            .delivery-form {
                order: 1;
            }
			
        }
    </style>
</head>
<body>
    <!-- 全局加载动画 -->
    <div class="loading-overlay" id="globalLoading">
        <div>
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">处理中...</div>
        </div>
    </div>
    
    <!-- 实时更新指示器 -->
    <div class="realtime-indicator" id="realtimeIndicator" style="display: none;">
        <i class="fas fa-sync-alt fa-spin"></i>
        <span>实时更新中...</span>
    </div>
    
    <!-- 订单确认模态框 -->
    <div class="order-confirm-modal" id="orderConfirmModal">
        <div class="order-confirm-box">
            <div class="order-confirm-header">
                <h2 class="order-confirm-title">
                    <i class="fas fa-clipboard-check"></i>
                    确认订单信息
                </h2>
                <button class="order-confirm-close" id="orderConfirmClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="order-confirm-body order-confirm-compact" id="orderConfirmBody">
                <!-- 订单详情将通过JavaScript动态填充 -->
            </div>
            
            <div class="order-confirm-buttons">
                <button class="order-confirm-btn cancel" id="orderConfirmCancel">
                    <i class="fas fa-times"></i>
                    取消
                </button>
                <button class="order-confirm-btn confirm" id="orderConfirmSubmit">
                    <i class="fas fa-check"></i>
                    确认提交
                </button>
            </div>
        </div>
    </div>
    
    <header>
        <div class="container">
            <div class="logo">
                <i class="fas fa-utensils"></i>
                <h1>肯德基自助点餐系统</h1>
                <i class="fas fa-hamburger"></i>
            </div>
            <p>宅急送免配送费 | 多人餐团餐优惠 | 外送到家</p>
            <div class="header-info">
                <div class="info-item">
                    <i class="fas fa-shipping-fast"></i>
                    <span>宅急送免配送费</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-users"></i>
                    <span>多人餐团餐优惠</span>
                </div>
                <div class="info-item">
                    <i class="fas fa-store"></i>
                    <span>到店自提</span>
                </div>
            </div>

            <div class="header-buttons">
                <button class="header-btn" id="viewOrdersBtn">
                    <i class="fas fa-clipboard-list"></i>
                    查看我的订单
                </button>
                <button class="header-btn" id="viewHomeBtn" style="display: none;">
                    <i class="fas fa-home"></i>
                    返回首页
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 首页 -->
        <div id="homePage" class="meal-page-container active">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="mealSearchInput" placeholder="搜索套餐：输入标签、价格、套餐名称或编号...">
                    <button class="search-btn" id="mealSearchBtn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="search-hint">
                    <i class="fas fa-lightbulb"></i>
                    提示：可以输入标签（如"自提"、"宅急送"）、价格（如"89.9"）、套餐名称或套餐编号进行搜索
                </div>
            </div>

            <div class="nav-menu">
                <h2 class="nav-title">
                    <i class="fas fa-utensils"></i>
                    选择您想要的套餐
                </h2>
                <div class="instructions">
                    <p><strong>下单步骤：</strong></p>
                    <ol>
                        <li>选择您想要的套餐</li>
                        <li>在套餐中选择具体的汉堡、小吃和饮品（点击选项，使用+/-按钮调整数量）</li>
                        <li>确保每个选项组的选择数量符合要求（会有提示）</li>
                        <li>点击"加入购物车"按钮</li>
                        <li>在右侧配送信息底部确认订单并选择配送方式</li>
                        <li>提交订单完成购买</li>
                        <li>提交后可以点击上方"查看我的订单"查看订单状态</li>
                    </ol>
                </div>
            </div>

            <div class="meal-grid" id="mealGrid">
            </div>

            <div class="no-meals-message" id="noMealsMessage" style="display: none;">
                <i class="fas fa-utensils"></i>
                <h3>暂无套餐</h3>
                <p>请联系管理员添加套餐</p>
            </div>
        </div>

        <!-- 套餐详情页 -->
        <div id="mealDetailPage" class="meal-page-container">
        </div>

        <!-- 我的订单页 -->
        <div id="myOrdersPage" class="meal-page-container">
            <a href="#" class="back-btn" onclick="showPage('homePage')">
                <i class="fas fa-arrow-left"></i>
                返回套餐列表
            </a>

            <div class="my-orders-section">
                <h2 class="section-title">
                    <i class="fas fa-clipboard-list"></i>
                    我的订单
                </h2>

                <div class="user-id-info">
                    <div class="user-id-label">您的用户标识符：</div>
                    <div class="user-id-value" id="currentUserIdDisplay"></div>
                </div>

                <div class="orders-search">
                    <div class="search-box">
                        <input type="text" class="search-input" id="orderSearchInput" placeholder="输入订单号搜索...">
                        <button class="search-btn" id="orderSearchBtn">搜索</button>
                    </div>

                    <div class="order-filter-tabs">
                        <button class="order-filter-tab active" data-order-filter="all">全部订单</button>
                        <button class="order-filter-tab" data-order-filter="new">新订单</button>
                        <button class="order-filter-tab" data-order-filter="processing">处理中</button>
                        <button class="order-filter-tab" data-order-filter="completed">已完成</button>
                    </div>
                </div>

                <div id="myOrdersContainer">
                </div>

                <div class="no-user-orders" id="noUserOrdersMessage">
                    <i class="fas fa-box-open"></i>
                    <h3>暂无订单</h3>
                    <p>您还没有提交过订单，快去下单吧！</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>© 2026 肯德基自助点餐系统 | 宅急送免配送费 | 商品特殊售出不退不换</p>
        </div>
    </div>

    <!-- 后台管理按钮 -->
    <button class="admin-btn" id="adminBtn">
        <i class="fas fa-user-shield"></i>
        <span>后台管理</span>
        <div class="new-order-badge" id="newOrderBadge" style="display: none;">0</div>
    </button>

    <!-- 密码验证模态框 -->
    <div class="password-modal" id="passwordModal">
        <div class="password-box">
            <h3><i class="fas fa-lock"></i> 管理员登录</h3>
            <input type="password" class="password-input" id="adminPassword" placeholder="请输入管理员密码" maxlength="6">
            <div class="password-error" id="passwordError">密码错误，请重新输入！</div>
            <button class="password-btn" id="submitPassword">确认</button>
        </div>
    </div>

    <!-- 管理员面板遮罩 -->
    <div class="panel-overlay" id="panelOverlay"></div>
    
    <!-- 管理员面板 -->
    <div class="admin-panel" id="adminPanel">
        <div class="panel-header">
            <h2><i class="fas fa-clipboard-list"></i> 系统管理后台</h2>
            <button class="close-panel" id="closePanel">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="panel-content">
            <div class="admin-tabs">
                <button class="admin-tab active" data-tab="orders">订单管理</button>
                <button class="admin-tab" data-tab="meals">套餐管理</button>
                <button class="admin-tab" data-tab="addMeal">添加套餐</button>
            </div>

            <div id="ordersTab" class="admin-tab-content active">
                <div class="order-filters">
                    <button class="filter-btn active" data-filter="all">全部订单</button>
                    <button class="filter-btn" data-filter="new">新订单</button>
                    <button class="filter-btn" data-filter="processing">处理中</button>
                    <button class="filter-btn" data-filter="completed">已完成</button>
                    <button class="filter-btn" id="clearAllOrders">清空所有订单</button>
                    <button class="filter-btn" id="syncDataBtn">同步数据</button>
                </div>

                <div class="orders-container" id="ordersContainer">
                    <div class="no-orders" id="noOrdersMessage">
                        <i class="fas fa-box-open"></i>
                        <h3>暂无订单</h3>
                        <p>当顾客提交订单后，订单将显示在这里</p>
                    </div>
                </div>
            </div>

            <div id="mealsTab" class="admin-tab-content">
                <!-- 搜索区域 -->
                <div class="admin-search-container">
                    <div class="admin-search-box">
                        <input type="text" class="admin-search-input" id="adminMealSearchInput" placeholder="搜索套餐：输入套餐名称、标签、价格或ID...">
                        <button class="admin-search-btn" id="adminMealSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="admin-search-hint">
                        <i class="fas fa-lightbulb"></i>
                        可以输入套餐名称、标签、价格或ID进行搜索
                    </div>
                </div>
                
                <div class="meal-filters">
                    <button class="meal-filter-btn active" data-meal-filter="all">全部套餐</button>
                    <button class="meal-filter-btn" data-meal-filter="active">已上架</button>
                    <button class="meal-filter-btn" data-meal-filter="inactive">已下架</button>
                    <button class="meal-filter-btn" data-meal-filter="delivery">支持宅急送</button>
                    <button class="meal-filter-btn" data-meal-filter="no-delivery">仅自提</button>
                </div>

                <!-- 套餐列表区域 -->
                <div id="mealListSection">
                    <div class="meal-list" id="mealList">
                    </div>
                    <div class="no-meals-message" id="noMealsAdminMessage">
                        <i class="fas fa-utensils"></i>
                        <h3>暂无套餐</h3>
                        <p>点击"添加套餐"标签创建新套餐</p>
                    </div>
                </div>

                <!-- 编辑套餐表单区域 -->
                <div class="edit-form-container" id="editMealFormContainer">
                    <h3 class="section-title" id="editMealTitle">
                        <i class="fas fa-edit"></i>
                        编辑套餐
                    </h3>

                    <div class="meal-form">
                        <input type="hidden" id="currentMealId" value="">

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">套餐名称 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="mealName" placeholder="例如：【12-8】自提/宅急送12件套89.9元" required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">套餐价格 <span class="required">*</span></label>
                                <input type="number" class="form-input" id="mealPrice" placeholder="例如：89.9" min="0" step="0.01" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">排序顺序 <span class="required">*</span></label>
                                <input type="number" class="form-input" id="mealOrder" placeholder="数字越小越靠前，例如：1" min="0" step="1" value="9999">
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i> 数字越小显示越靠前，默认9999（最后）
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">套餐标签 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="mealTags" placeholder="用逗号分隔，例如：自提/宅急送,3人餐,12件套" required>
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i> 标签将显示在套餐卡片上，用逗号分隔多个标签
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">套餐描述 <span class="required">*</span></label>
                                <input type="text" class="form-input" id="mealDescription" placeholder="例如：适合3人享用，自提/宅急送都可用" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">套餐状态</label>
                                <div class="status-label">
                                    <label class="status-toggle">
                                        <input type="checkbox" id="mealActive" checked>
                                        <span class="status-slider"></span>
                                    </label>
                                    <span id="statusText" class="status-active">上架</span>
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i> 上架的套餐会在用户端显示，下架的套餐不会显示
                                </div>
                            </div>
                        </div>
                        
                        <!-- 新增：是否支持宅急送 -->
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">是否支持宅急送</label>
                                <div class="status-label">
                                    <label class="status-toggle">
                                        <input type="checkbox" id="mealSupportDelivery" checked>
                                        <span class="status-slider"></span>
                                    </label>
                                    <span id="supportDeliveryText" class="status-active">支持</span>
                                </div>
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i> 支持的套餐可以选择宅急送配送，不支持的套餐只能到店自提
                                </div>
                            </div>
                        </div>

                        <h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
                            <i class="fas fa-list"></i>
                            选项组管理
                        </h4>

                        <div class="option-groups-management" id="optionGroupsManagement">
                        </div>

                        <button class="add-btn action-btn" id="addOptionGroupBtn">
                            <i class="fas fa-plus"></i> 添加选项组
                        </button>

                        <h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
                            <i class="fas fa-th-list"></i>
                            固定搭配管理（可选）
                        </h4>

                        <div class="fixed-items-management" id="fixedItemsManagement">
                        </div>

                        <button class="add-btn action-btn" id="addFixedItemBtn">
                            <i class="fas fa-plus"></i> 添加固定搭配项
                        </button>

                        <div style="margin-top: 20px; display: flex; gap: 12px;">
                            <button class="add-btn action-btn" id="saveMealBtn" style="padding: 10px 25px;">
                                <i class="fas fa-save"></i> 保存套餐
                            </button>
                            <button class="filter-btn" id="cancelEditBtn" style="padding: 10px 25px;">
                                <i class="fas fa-arrow-left"></i> 返回列表
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="addMealTab" class="admin-tab-content">
                <h3 class="section-title" id="addMealTitle">
                    <i class="fas fa-plus-circle"></i>
                    添加新套餐
                </h3>

                <div class="meal-form" id="addMealForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">套餐名称 <span class="required">*</span></label>
                            <input type="text" class="form-input" id="newMealName" placeholder="例如：【12-8】自提/宅急送12件套89.9元" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">套餐价格 <span class="required">*</span></label>
                            <input type="number" class="form-input" id="newMealPrice" placeholder="例如：89.9" min="0" step="0.01" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">排序顺序 <span class="required">*</span></label>
                                <input type="number" class="form-input" id="newMealOrder" placeholder="数字越小越靠前，例如：1" min="0" step="1" value="9999">
                            <div class="form-hint">
                                <i class="fas fa-lightbulb"></i> 数字越小显示越靠前，默认9999（最后）
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">套餐标签 <span class="required">*</span></label>
                            <input type="text" class="form-input" id="newMealTags" placeholder="用逗号分隔，例如：自提/宅急送,3人餐,12件套" required>
                            <div class="form-hint">
                                <i class="fas fa-lightbulb"></i> 标签将显示在套餐卡片上，用逗号分隔多个标签
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">套餐描述 <span class="required">*</span></label>
                            <input type="text" class="form-input" id="newMealDescription" placeholder="例如：适合3人享用，自提/宅急送都可用" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">套餐状态</label>
                            <div class="status-label">
                                <label class="status-toggle">
                                    <input type="checkbox" id="newMealActive" checked>
                                    <span class="status-slider"></span>
                                </label>
                                <span id="newStatusText" class="status-active">上架</span>
                            </div>
                            <div class="form-hint">
                                <i class="fas fa-lightbulb"></i> 上架的套餐会在用户端显示，下架的套餐不会显示
                            </div>
                        </div>
                    </div>
                    
                    <!-- 新增：是否支持宅急送 -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">是否支持宅急送</label>
                            <div class="status-label">
                                <label class="status-toggle">
                                    <input type="checkbox" id="newMealSupportDelivery" checked>
                                    <span class="status-slider"></span>
                                </label>
                                <span id="newSupportDeliveryText" class="status-active">支持</span>
                            </div>
                            <div class="form-hint">
                                <i class="fas fa-lightbulb"></i> 支持的套餐可以选择宅急送配送，不支持的套餐只能到店自提
                            </div>
                        </div>
                    </div>

                    <h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
                        <i class="fas fa-list"></i>
                        选项组管理
                    </h4>

                    <div class="option-groups-management" id="newOptionGroupsManagement">
                    </div>

                    <button class="add-btn action-btn" id="newAddOptionGroupBtn">
                        <i class="fas fa-plus"></i> 添加选项组
                    </button>

                    <h4 class="section-title" style="margin-top: 20px; font-size: 1.2rem;">
                        <i class="fas fa-th-list"></i>
                        固定搭配管理（可选）
                    </h4>

                    <div class="fixed-items-management" id="newFixedItemsManagement">
                    </div>

                    <button class="add-btn action-btn" id="newAddFixedItemBtn">
                        <i class="fas fa-plus"></i> 添加固定搭配项
                    </button>

                    <div style="margin-top: 20px;">
                        <button class="add-btn action-btn" id="saveNewMealBtn" style="padding: 10px 25px; width: 100%;">
                            <i class="fas fa-plus-circle"></i> 添加新套餐
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片预览模态框 -->
    <div class="image-modal" id="imageModal">
        <button class="close-modal" id="closeModal">
            <i class="fas fa-times"></i>
        </button>
        <img class="modal-image" id="modalImage" src="" alt="预览图片">
    </div>

    <script>
        // ==================== Supabase 配置 ====================
        const SUPABASE_URL = 'https://ljijvuguvllradywpwht.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqaWp2dWd1dmxscmFkeXdwd2h0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MDI0MzUsImV4cCI6MjA4NDQ3ODQzNX0.hX02D8f2LaLtBLLBVw2AIzwivKSH-JP0TTI1J3bVmwM';
        
        let supabaseClient = null;

        // ==================== 数据结构 ====================
        let meals = [];
        let cart = [];
        let orders = [];
        let newOrdersCount = 0;
        const ADMIN_PASSWORD = "200104";
        
        let adminPollingInterval = null;
        let globalPollingInterval = null;
        let isAdminPanelOpen = false;
        let lastOrderUpdateTime = 0;
        let lastUserOrderUpdateTime = Date.now();
        let lastGlobalCheckTime = Date.now();

        let currentUserId = localStorage.getItem('kfcUserId');

        if (!currentUserId) {
            currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('kfcUserId', currentUserId);
        }

        // ==================== 全局加载状态管理 ====================
        let isLoading = false;
        
        function showLoading(text = '处理中...') {
            if (!isLoading) {
                isLoading = true;
                const loadingOverlay = document.getElementById('globalLoading');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = text;
                loadingOverlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        }
        
        function hideLoading() {
            if (isLoading) {
                isLoading = false;
                const loadingOverlay = document.getElementById('globalLoading');
                loadingOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }
        
        function showRealtimeIndicator(message = '实时更新中...') {
            const indicator = document.getElementById('realtimeIndicator');
            const indicatorSpan = indicator.querySelector('span');
            indicatorSpan.textContent = message;
            indicator.style.display = 'flex';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        // ==================== Supabase 数据操作类 ====================
        class SupabaseData {
            static async loadMeals() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return [];
                }
                
                try {
                    const { data, error } = await supabase
                        .from('meals')
                        .select('*')
                        .order('order', { ascending: true })
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    return data.map(item => ({
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        tags: item.tags || [],
                        description: item.description,
                        order: item.order || 9999,
                        active: item.active !== false,
                        supportDelivery: item.support_delivery !== false,
                        optionGroups: item.option_groups || [],
                        fixedItems: item.fixed_items || [],
                        createdAt: item.created_at ? new Date(item.created_at).getTime() : Date.now(),
                        updatedAt: item.updated_at ? new Date(item.updated_at).getTime() : Date.now(),
                        objectId: item.id
                    }));
                } catch (error) {
                    console.error('加载套餐数据失败:', error);
                    return [];
                }
            }

            static async saveMeal(meal) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const mealData = {
                        id: meal.id,
                        name: meal.name,
                        price: meal.price,
                        tags: meal.tags,
                        description: meal.description,
                        order: meal.order || 9999,
                        active: meal.active !== false,
                        support_delivery: meal.supportDelivery !== false,
                        option_groups: meal.optionGroups || [],
                        fixed_items: meal.fixedItems || [],
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    
                    if (meal.objectId) {
                        const { data, error } = await supabase
                            .from('meals')
                            .update(mealData)
                            .eq('id', meal.id)
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    } else {
                        mealData.created_at = new Date().toISOString();
                        
                        const { data, error } = await supabase
                            .from('meals')
                            .insert([mealData])
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    }

                    const createdAt = result.created_at ? new Date(result.created_at).getTime() : Date.now();
                    const updatedAt = result.updated_at ? new Date(result.updated_at).getTime() : Date.now();

                    return {
                        id: result.id,
                        name: result.name,
                        price: result.price,
                        tags: result.tags,
                        description: result.description,
                        order: result.order || 9999,
                        active: result.active !== false,
                        supportDelivery: result.support_delivery !== false,
                        optionGroups: result.option_groups || [],
                        fixedItems: result.fixed_items || [],
                        createdAt: createdAt,
                        updatedAt: updatedAt,
                        objectId: result.id
                    };
                } catch (error) {
                    console.error('保存套餐失败:', error);
                    throw error;
                }
            }

            static async deleteMeal(mealId) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const { error } = await supabase
                        .from('meals')
                        .delete()
                        .eq('id', mealId);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('删除套餐失败:', error);
                    throw error;
                }
            }

            static async loadOrders() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return [];
                }
                
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    return data.map(item => ({
                        id: item.id,
                        timestamp: item.timestamp,
                        status: item.status || 'new',
                        cart: item.cart || [],
                        deliveryInfo: item.delivery_info,
                        orderNote: item.order_note || '',
                        deliveryType: item.delivery_type,
                        totalPrice: item.total_price,
                        hasScreenshot: item.has_screenshot || false,
                        screenshotData: item.screenshot_data,
                        feedbackScreenshotData: item.feedback_screenshot_data || null,
                        userId: item.user_id,
                        createdAt: item.created_at ? new Date(item.created_at).getTime() : Date.now(),
                        updatedAt: item.updated_at ? new Date(item.updated_at).getTime() : Date.now(),
                        objectId: item.id
                    }));
                } catch (error) {
                    console.error('加载订单数据失败:', error);
                    return [];
                }
            }

            static async saveOrder(order) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const orderData = {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        delivery_info: order.deliveryInfo,
                        order_note: order.orderNote || '',
                        delivery_type: order.deliveryType,
                        total_price: order.totalPrice,
                        user_id: order.userId,
                        has_screenshot: order.hasScreenshot || false,
                        screenshot_data: order.screenshotData,
                        feedback_screenshot_data: order.feedbackScreenshotData || null,
                        updated_at: new Date().toISOString()
                    };

                    let result;
                    
                    if (order.objectId) {
                        const { data, error } = await supabase
                            .from('orders')
                            .update(orderData)
                            .eq('id', order.id)
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    } else {
                        orderData.created_at = new Date().toISOString();
                        
                        const { data, error } = await supabase
                            .from('orders')
                            .insert([orderData])
                            .select();
                        
                        if (error) throw error;
                        result = data[0];
                    }

                    const createdAt = result.created_at ? new Date(result.created_at).getTime() : Date.now();
                    const updatedAt = result.updated_at ? new Date(result.updated_at).getTime() : Date.now();

                    return {
                        id: result.id,
                        timestamp: result.timestamp,
                        status: result.status || 'new',
                        cart: result.cart,
                        deliveryInfo: result.delivery_info,
                        orderNote: result.order_note || '',
                        deliveryType: result.delivery_type,
                        totalPrice: result.total_price,
                        hasScreenshot: result.has_screenshot || false,
                        screenshotData: result.screenshot_data,
                        feedbackScreenshotData: result.feedback_screenshot_data || null,
                        userId: result.user_id,
                        createdAt: createdAt,
                        updatedAt: updatedAt,
                        objectId: result.id
                    };
                } catch (error) {
                    console.error('保存订单失败:', error);
                    throw error;
                }
            }

            static async deleteOrder(orderId) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const { error } = await supabase
                        .from('orders')
                        .delete()
                        .eq('id', orderId);
                    
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('删除订单失败:', error);
                    throw error;
                }
            }

            static async loadNewOrdersCount() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return 0;
                }
                
                try {
                    const { data, error } = await supabase
                        .from('counters')
                        .select('count')
                        .eq('type', 'newOrdersCount')
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            const { data: newData, error: insertError } = await supabase
                                .from('counters')
                                .insert([{ type: 'newOrdersCount', count: 0 }])
                                .select()
                                .single();
                            
                            if (insertError) throw insertError;
                            return newData.count || 0;
                        }
                        throw error;
                    }
                    
                    return data.count || 0;
                } catch (error) {
                    console.error('加载新订单计数失败:', error);
                    return 0;
                }
            }

            static async updateNewOrdersCount(count) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const { data, error } = await supabase
                        .from('counters')
                        .update({ count: count, updated_at: new Date().toISOString() })
                        .eq('type', 'newOrdersCount')
                        .select();
                    
                    if (error) {
                        const { data: insertData, error: insertError } = await supabase
                            .from('counters')
                            .insert([{ type: 'newOrdersCount', count: count }])
                            .select();
                        
                        if (insertError) throw insertError;
                        return insertData[0].count;
                    }
                    
                    console.log('新订单计数更新成功:', count);
                    return data[0].count;
                } catch (error) {
                    console.error('更新新订单计数失败:', error);
                    throw error;
                }
            }

            static async initializeTables() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return false;
                }
                
                try {
                    const { data, error } = await supabase
                        .from('meals')
                        .select('id', { count: 'exact', head: true });
                    
                    console.log('Supabase 连接成功');
                    return true;
                } catch (error) {
                    console.log('Supabase 初始化:', error);
                    return false;
                }
            }
            
            static async checkForNewOrders(sinceTime, userId = null) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return [];
                }
                
                try {
                    let query = supabase
                        .from('orders')
                        .select('*')
                        .gte('created_at', new Date(sinceTime).toISOString())
                        .order('created_at', { ascending: false });
                    
                    if (userId) {
                        query = query.eq('user_id', userId);
                    }
                    
                    const { data, error } = await query;
                    
                    if (error) throw error;
                    
                    return data.map(item => ({
                        id: item.id,
                        timestamp: item.timestamp,
                        status: item.status || 'new',
                        cart: item.cart || [],
                        deliveryInfo: item.delivery_info,
                        orderNote: item.order_note || '',
                        deliveryType: item.delivery_type,
                        totalPrice: item.total_price,
                        hasScreenshot: item.has_screenshot || false,
                        screenshotData: item.screenshot_data,
                        feedbackScreenshotData: item.feedback_screenshot_data || null,
                        userId: item.user_id,
                        createdAt: item.created_at ? new Date(item.created_at).getTime() : Date.now(),
                        updatedAt: item.updated_at ? new Date(item.updated_at).getTime() : Date.now(),
                        objectId: item.id
                    }));
                } catch (error) {
                    console.error('检查新订单失败:', error);
                    return [];
                }
            }
            
            static async checkNewOrdersCountOnly() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return 0;
                }
                
                try {
                    const count = await this.loadNewOrdersCount();
                    return count;
                } catch (error) {
                    console.error('检查新订单计数失败:', error);
                    return 0;
                }
            }
            
            static async quickSaveOrder(order) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        deliveryInfo: order.deliveryInfo,
                        orderNote: order.orderNote || '',
                        deliveryType: order.deliveryType,
                        totalPrice: order.totalPrice,
                        hasScreenshot: order.hasScreenshot || false,
                        screenshotData: order.screenshotData,
                        feedbackScreenshotData: order.feedbackScreenshotData || null,
                        userId: order.userId,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        objectId: 'local_' + order.id
                    };
                }
                
                try {
                    const orderData = {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        delivery_info: order.deliveryInfo,
                        order_note: order.orderNote || '',
                        delivery_type: order.deliveryType,
                        total_price: order.totalPrice,
                        user_id: order.userId,
                        has_screenshot: order.hasScreenshot || false,
                        screenshot_data: order.screenshotData,
                        feedback_screenshot_data: order.feedbackScreenshotData || null,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };

                    supabase
                        .from('orders')
                        .insert([orderData])
                        .then(({ error }) => {
                            if (error) {
                                console.error('订单快速保存失败:', error);
                            } else {
                                console.log('订单快速保存成功:', order.id);
                            }
                        });

                    return {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        deliveryInfo: order.deliveryInfo,
                        orderNote: order.orderNote || '',
                        deliveryType: order.deliveryType,
                        totalPrice: order.totalPrice,
                        hasScreenshot: order.hasScreenshot || false,
                        screenshotData: order.screenshotData,
                        feedbackScreenshotData: order.feedbackScreenshotData || null,
                        userId: order.userId,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        objectId: 'pending_' + order.id
                    };
                } catch (error) {
                    console.error('快速保存订单失败:', error);
                    return {
                        id: order.id,
                        timestamp: order.timestamp,
                        status: order.status || 'new',
                        cart: order.cart,
                        deliveryInfo: order.deliveryInfo,
                        orderNote: order.orderNote || '',
                        deliveryType: order.deliveryType,
                        totalPrice: order.totalPrice,
                        hasScreenshot: order.hasScreenshot || false,
                        screenshotData: order.screenshotData,
                        feedbackScreenshotData: order.feedbackScreenshotData || null,
                        userId: order.userId,
                        createdAt: Date.now(),
                        updatedAt: Date.now(),
                        objectId: 'local_' + order.id
                    };
                }
            }
            
            static async checkForOrderUpdates(sinceTime, userId) {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    return [];
                }
                
                try {
                    const { data, error } = await supabase
                        .from('orders')
                        .select('*')
                        .gte('updated_at', new Date(sinceTime).toISOString())
                        .eq('user_id', userId)
                        .order('updated_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    return data.map(item => ({
                        id: item.id,
                        timestamp: item.timestamp,
                        status: item.status || 'new',
                        cart: item.cart || [],
                        deliveryInfo: item.delivery_info,
                        orderNote: item.order_note || '',
                        deliveryType: item.delivery_type,
                        totalPrice: item.total_price,
                        hasScreenshot: item.has_screenshot || false,
                        screenshotData: item.screenshot_data,
                        feedbackScreenshotData: item.feedback_screenshot_data || null,
                        userId: item.user_id,
                        createdAt: item.created_at ? new Date(item.created_at).getTime() : Date.now(),
                        updatedAt: item.updated_at ? new Date(item.updated_at).getTime() : Date.now(),
                        objectId: item.id
                    }));
                } catch (error) {
                    console.error('检查订单更新失败:', error);
                    return [];
                }
            }
            
            static async clearAllOrders() {
                const supabase = supabaseClient;
                if (!supabase) {
                    console.error('Supabase 客户端未初始化');
                    throw new Error('Supabase 客户端未初始化');
                }
                
                try {
                    const { error } = await supabase
                        .from('orders')
                        .delete()
                        .neq('id', 'dummy');
                    
                    if (error) throw error;
                    
                    await this.updateNewOrdersCount(0);
                    
                    return true;
                } catch (error) {
                    console.error('清空订单失败:', error);
                    throw error;
                }
            }
        }

        // ==================== 优化的图片压缩函数 ====================
        async function compressImageFast(file, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve, reject) => {
                // 如果文件小于100KB，直接返回原文件
                if (file.size < 100 * 1024) {
                    resolve(file);
                    return;
                }
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function(event) {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // 计算新尺寸
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // 转换为压缩后的图片
                        canvas.toBlob(function(blob) {
                            // 如果压缩后反而更大，返回原文件
                            if (blob.size >= file.size) {
                                resolve(file);
                            } else {
                                resolve(blob);
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

// ==================== 地址信息自动识别函数 ====================
// ==================== 综合地址信息自动识别函数 ====================
function recognizeDeliveryInfo(text) {
    // 初始化结果
    const result = {
        name: '',
        phone: '',
        address: '',
        success: false
    };

    console.log('原始输入:', text); // 调试用
    
    // 1. 标准化文本
    let processedText = text
        .replace(/：/g, ':') // 全角冒号转半角
        .replace(/\r\n/g, '\n') // 统一换行符
        .replace(/\r/g, '\n')
        .trim();
    
    console.log('标准化后:', processedText);
    
    // 2. 判断是否为带标签的格式化文本
    const hasLabels = /(收件人|姓名|手机|电话|所在地区|详细地址)[:\s]/.test(processedText);
    const hasMultipleLines = processedText.includes('\n') && processedText.split('\n').length >= 2;
    
    // 策略1：如果有多行且有标签，使用标签识别法
    if (hasMultipleLines && hasLabels) {
        console.log('使用标签识别法');
        return recognizeWithLabels(processedText);
    }
    
    // 策略2：如果是单行或没有标签，使用智能分割法
    console.log('使用智能分割法');
    return recognizeWithSmartSplit(processedText);
}

// ==================== 标签识别法（针对格式化文本） ====================
function recognizeWithLabels(text) {
    const result = {
        name: '',
        phone: '',
        address: '',
        success: false
    };
    
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    
    console.log('标签识别 - 分割行:', lines);
    
    // 定义一个临时变量来存储地区信息
    let areaPart = '';
    let addressPart = '';
    
    // 逐行处理
    lines.forEach(line => {
        const lowerLine = line.toLowerCase();
        
        // 姓名行
        if (/收件人[:\s]|姓名[:\s]|收货人[:\s]/.test(lowerLine) && !result.name) {
            const nameMatch = line.match(/(?:收件人[:：\s]?|姓名[:：\s]?|收货人[:：\s]?)?([\u4e00-\u9fa5]+)/);
            if (nameMatch && nameMatch[1]) {
                result.name = nameMatch[1];
                console.log('标签识别 - 找到姓名:', result.name);
            }
        }
        
        // 手机号行
        if (/手机[:\s]|电话[:\s]|联系方式[:\s]/.test(lowerLine) && !result.phone) {
            const phoneMatch = line.match(/(1[3-9]\d{9})/);
            if (phoneMatch) {
                result.phone = phoneMatch[0];
                console.log('标签识别 - 找到手机:', result.phone);
            }
        }
        
        // 所在地区行
        if (/所在地区[:\s]|地区[:\s]/.test(lowerLine)) {
            const areaMatch = line.match(/(?:所在地区[:：\s]?|地区[:：\s]?)?(.+)/);
            if (areaMatch && areaMatch[1]) {
                areaPart = areaMatch[1].trim();
                console.log('标签识别 - 找到地区:', areaPart);
            }
        }
        
        // 详细地址行
        if (/详细地址[:\s]|地址[:\s]/.test(lowerLine)) {
            const addressMatch = line.match(/(?:详细地址[:：\s]?|地址[:：\s]?)?(.+)/);
            if (addressMatch && addressMatch[1]) {
                addressPart = addressMatch[1].trim();
                console.log('标签识别 - 找到地址:', addressPart);
            }
        }
    });
    
    // 合并地区信息
    if (areaPart && addressPart) {
        result.address = areaPart + addressPart;
    } else if (areaPart) {
        result.address = areaPart;
    } else if (addressPart) {
        result.address = addressPart;
    }
    
    // 如果标签法没找到姓名，尝试其他方法
    if (!result.name) {
        // 尝试找2-4个汉字的行作为姓名
        for (let line of lines) {
            const simpleNameMatch = line.match(/^([\u4e00-\u9fa5]{2,4})$/);
            if (simpleNameMatch && !line.includes('手机') && !line.includes('电话') && !line.includes('地址')) {
                result.name = simpleNameMatch[1];
                console.log('标签识别 - 补充姓名:', result.name);
                break;
            }
        }
    }
    
    // 如果标签法没找到手机号，搜索所有行
    if (!result.phone) {
        for (let line of lines) {
            const phoneMatch = line.match(/(1[3-9]\d{9})/);
            if (phoneMatch) {
                result.phone = phoneMatch[0];
                console.log('标签识别 - 补充手机:', result.phone);
                break;
            }
        }
    }
    
    // 如果地址为空，组合所有不包含姓名和电话的行
    if (!result.address || result.address.length < 5) {
        let addressParts = [];
        for (let line of lines) {
            // 排除姓名、电话行和标签行
            if (!line.includes(result.name) && !line.match(/(1[3-9]\d{9})/) &&
                !line.includes('收件人') && !line.includes('姓名') && 
                !line.includes('手机') && !line.includes('电话') &&
                !line.includes('所在地区') && !line.includes('详细地址')) {
                addressParts.push(line);
            }
        }
        if (addressParts.length > 0) {
            result.address = addressParts.join('');
            console.log('标签识别 - 补充地址:', result.address);
        }
    }
    
    // 清理地址
    if (result.address) {
        result.address = result.address
            .replace(/^[，。,.、;；\s]+|[，。,.、;；\s]+$/g, '')
            .replace(/\s+/g, '');
    }
    
    // 判断成功条件
    result.success = result.phone && result.address && result.name;
    
    console.log('标签识别 - 最终结果:', result);
    return result;
}

// ==================== 智能分割法（针对连续文本） ====================
// ==================== 综合地址信息自动识别函数 ====================
function recognizeDeliveryInfo(text) {
    // 初始化结果
    const result = {
        name: '',
        phone: '',
        address: '',
        success: false
    };

    console.log('原始输入:', text); // 调试用
    
    // 1. 标准化文本
    let processedText = text
        .replace(/：/g, ':') // 全角冒号转半角
        .replace(/\r\n/g, '\n') // 统一换行符
        .replace(/\r/g, '\n')
        .trim();
    
    console.log('标准化后:', processedText);
    
    // 2. 判断是否为带标签的格式化文本
    const hasLabels = /(收件人|姓名|手机|电话|所在地区|详细地址)[:\s]/.test(processedText);
    const hasMultipleLines = processedText.includes('\n') && processedText.split('\n').length >= 2;
    
    // 策略1：如果有多行且有标签，使用标签识别法
    if (hasMultipleLines && hasLabels) {
        console.log('使用标签识别法');
        return recognizeWithLabels(processedText);
    }
    
    // 策略2：如果是单行或没有标签，使用智能分割法
    console.log('使用智能分割法');
    return recognizeWithSmartSplit(processedText);
}

// ==================== 标签识别法（针对格式化文本） ====================
function recognizeWithLabels(text) {
    const result = {
        name: '',
        phone: '',
        address: '',
        success: false
    };
    
    const lines = text.split('\n').map(line => line.trim()).filter(line => line);
    
    console.log('标签识别 - 分割行:', lines);
    
    // 定义标签关键词（用于排除）
    const labelKeywords = ['收件人', '姓名', '收货人', '手机', '电话', '联系方式', '所在地区', '详细地址', '地址'];
    
    // 定义一个临时变量来存储地区信息
    let areaPart = '';
    let addressPart = '';
    
    // 逐行处理
    lines.forEach(line => {
        const lowerLine = line.toLowerCase();
        
        // 姓名行 - 优化：确保不会将标签本身识别为姓名
        if (/收件人[:\s]|姓名[:\s]|收货人[:\s]/.test(lowerLine) && !result.name) {
            // 使用更精确的正则，匹配标签后的内容
            const nameMatch = line.match(/(?:收件人[:：\s]+|姓名[:：\s]+|收货人[:：\s]+)([\u4e00-\u9fa5]{2,4})/);
            if (nameMatch && nameMatch[1]) {
                // 检查提取的内容是否包含标签关键词
                const extractedName = nameMatch[1];
                const isLabel = labelKeywords.some(keyword => extractedName.includes(keyword));
                
                if (!isLabel) {
                    result.name = extractedName;
                    console.log('标签识别 - 找到姓名:', result.name);
                } else {
                    console.log('标签识别 - 忽略标签作为姓名:', extractedName);
                }
            }
        }
        
        // 手机号行
        if (/手机[:\s]|电话[:\s]|联系方式[:\s]/.test(lowerLine) && !result.phone) {
            const phoneMatch = line.match(/(1[3-9]\d{9})/);
            if (phoneMatch) {
                result.phone = phoneMatch[0];
                console.log('标签识别 - 找到手机:', result.phone);
            }
        }
        
        // 所在地区行
        if (/所在地区[:\s]|地区[:\s]/.test(lowerLine)) {
            const areaMatch = line.match(/(?:所在地区[:：\s]+|地区[:：\s]+)(.+)/);
            if (areaMatch && areaMatch[1]) {
                areaPart = areaMatch[1].trim();
                console.log('标签识别 - 找到地区:', areaPart);
            }
        }
        
        // 详细地址行
        if (/详细地址[:\s]|地址[:\s]/.test(lowerLine)) {
            const addressMatch = line.match(/(?:详细地址[:：\s]+|地址[:：\s]+)(.+)/);
            if (addressMatch && addressMatch[1]) {
                addressPart = addressMatch[1].trim();
                console.log('标签识别 - 找到地址:', addressPart);
            }
        }
    });
    
    // 合并地区信息
    if (areaPart && addressPart) {
        result.address = areaPart + addressPart;
    } else if (areaPart) {
        result.address = areaPart;
    } else if (addressPart) {
        result.address = addressPart;
    }
    
    // 如果标签法没找到姓名，尝试其他方法
    if (!result.name) {
        // 尝试找2-4个汉字的行作为姓名
        for (let line of lines) {
            // 排除包含标签关键词的行
            const hasLabelInLine = labelKeywords.some(keyword => line.includes(keyword));
            if (hasLabelInLine) continue;
            
            const simpleNameMatch = line.match(/^([\u4e00-\u9fa5]{2,4})$/);
            if (simpleNameMatch) {
                result.name = simpleNameMatch[1];
                console.log('标签识别 - 补充姓名:', result.name);
                break;
            }
        }
    }
    
    // 如果标签法没找到手机号，搜索所有行
    if (!result.phone) {
        for (let line of lines) {
            const phoneMatch = line.match(/(1[3-9]\d{9})/);
            if (phoneMatch) {
                result.phone = phoneMatch[0];
                console.log('标签识别 - 补充手机:', result.phone);
                break;
            }
        }
    }
    
    // 如果地址为空，组合所有不包含姓名和电话的行
    if (!result.address || result.address.length < 5) {
        let addressParts = [];
        for (let line of lines) {
            // 排除姓名、电话行和标签行
            const hasLabelInLine = labelKeywords.some(keyword => line.includes(keyword));
            const hasPhoneInLine = /1[3-9]\d{9}/.test(line);
            const hasNameInLine = result.name && line.includes(result.name);
            
            if (!hasLabelInLine && !hasPhoneInLine && !hasNameInLine) {
                addressParts.push(line);
            }
        }
        if (addressParts.length > 0) {
            result.address = addressParts.join('');
            console.log('标签识别 - 补充地址:', result.address);
        }
    }
    
    // 清理地址
    if (result.address) {
        result.address = result.address
            .replace(/^[，。,.、;；\s]+|[，。,.、;；\s]+$/g, '')
            .replace(/\s+/g, '');
    }
    
    // 判断成功条件
    result.success = result.phone && result.address && result.name;
    
    console.log('标签识别 - 最终结果:', result);
    return result;
}

// ==================== 智能分割法（针对连续文本） ====================
function recognizeWithSmartSplit(text) {
    const result = {
        name: '',
        phone: '',
        address: '',
        success: false
    };
    
    console.log('智能分割 - 输入文本:', text);
    
    // 定义标签关键词（用于排除）
    const labelKeywords = ['收件人', '姓名', '收货人', '手机', '电话', '联系方式', '所在地区', '详细地址', '地址'];
    
    // 1. 先提取手机号（最明确的）
    const phoneRegex = /1[3-9]\d{9}/g;
    const phoneMatches = text.match(phoneRegex);
    if (phoneMatches && phoneMatches.length > 0) {
        result.phone = phoneMatches[0];
        // 从文本中移除手机号
        text = text.replace(result.phone, '');
        console.log('智能分割 - 提取手机:', result.phone, '剩余文本:', text);
    }
    
    // 2. 按常见分隔符分割
    const separators = /[,，、;；\n]/;
    const parts = text.split(separators).map(part => part.trim()).filter(part => part);
    
    console.log('智能分割 - 分割后部分:', parts);
    
    // 3. 分析每个部分
    for (let part of parts) {
        if (!part) continue;
        
        console.log('智能分割 - 分析部分:', part);
        
        // 检查是否是姓名（2-4个汉字）
        if (part.length >= 2 && part.length <= 4) {
            // 检查是否包含标签关键词
            const isLabel = labelKeywords.some(keyword => part.includes(keyword));
            if (isLabel) {
                console.log('智能分割 - 忽略标签部分:', part);
                // 将标签部分添加到地址（去掉标签关键词）
                const cleanedPart = part.replace(/收件人[:：\s]*|姓名[:：\s]*|收货人[:：\s]*/gi, '');
                if (cleanedPart) {
                    if (result.address) {
                        result.address += cleanedPart;
                    } else {
                        result.address = cleanedPart;
                    }
                }
                continue;
            }
            
            // 常见姓氏
            const commonSurnames = ['李', '王', '张', '刘', '陈', '杨', '赵', '黄', '周', '吴', '徐', '孙', '胡', '朱', '高', '林',
                                   '何', '郭', '马', '罗', '梁', '宋', '郑', '谢', '韩', '唐', '冯', '于', '董', '萧', '程', '曹',
                                   '袁', '邓', '许', '傅', '沈', '曾', '彭', '吕', '苏', '卢', '蒋', '蔡', '贾', '丁', '魏', '薛',
                                   '叶', '阎', '余', '潘', '杜', '戴', '夏', '钟', '汪', '田', '任', '姜', '范', '方', '石', '姚',
                                   '谭', '廖', '邹', '熊', '金', '陆', '郝', '孔', '白', '崔', '康', '毛', '邱', '秦', '江', '史',
                                   '顾', '侯', '邵', '孟', '龙', '万', '段', '漕', '钱', '汤', '尹', '黎', '易', '常', '武', '乔',
                                   '贺', '赖', '龚', '文'];
            
            const firstChar = part.charAt(0);
            const isName = commonSurnames.includes(firstChar) || 
                          part.includes('先生') || part.includes('女士') || 
                          part.includes('小姐') || part.includes('师傅');
            
            // 检查是否包含地址关键词（不是地址）
            const addressKeywords = ['省', '市', '区', '县', '街道', '镇', '乡', '村', 
                                    '路', '街', '道', '巷', '弄', '号', '栋', '单元', 
                                    '楼', '层', '室', '小区', '花园', '广场', '大厦', 
                                    '公寓', '校区', '宿舍', '大学', '学院', '学校'];
            
            const hasAddressKeyword = addressKeywords.some(keyword => part.includes(keyword));
            
            if (isName && !hasAddressKeyword && !result.name) {
                result.name = part;
                console.log('智能分割 - 识别为姓名:', part);
                continue;
            }
        }
        
        // 剩余的部分都当作地址
        if (part && !result.address.includes(part)) {
            // 检查是否包含标签，如果包含则清理
            const hasLabel = labelKeywords.some(keyword => part.includes(keyword));
            if (hasLabel) {
                // 清理标签
                const cleanedPart = part.replace(/收件人[:：\s]*|姓名[:：\s]*|收货人[:：\s]*|手机[:：\s]*|电话[:：\s]*|联系方式[:：\s]*|所在地区[:：\s]*|详细地址[:：\s]*|地址[:：\s]*/gi, '');
                if (cleanedPart) {
                    if (result.address) {
                        result.address += cleanedPart;
                    } else {
                        result.address = cleanedPart;
                    }
                    console.log('智能分割 - 清理标签后添加到地址:', cleanedPart);
                }
            } else {
                if (result.address) {
                    result.address += part;
                } else {
                    result.address = part;
                }
                console.log('智能分割 - 添加到地址:', part, '当前地址:', result.address);
            }
        }
    }
    
    // 4. 如果还没有找到姓名，尝试其他方法
    if (!result.name) {
        // 尝试匹配"姓+先生/女士"模式
        const namePattern = /([\u4e00-\u9fa5]{1,3})(先生|女士|小姐|师傅)/;
        const nameMatch = text.match(namePattern);
        if (nameMatch) {
            result.name = nameMatch[1] + nameMatch[2];
            console.log('智能分割 - 补充姓名(带称呼):', result.name);
        } else {
            // 尝试匹配单独的2-3个汉字（排除标签）
            const chinesePattern = /[\u4e00-\u9fa5]{2,3}/g;
            const chineseMatches = text.match(chinesePattern);
            if (chineseMatches && chineseMatches.length > 0) {
                // 过滤掉标签关键词
                const filteredMatches = chineseMatches.filter(match => {
                    return !labelKeywords.some(keyword => match.includes(keyword));
                });
                
                if (filteredMatches.length > 0) {
                    // 取第一个匹配的汉字序列作为姓名
                    result.name = filteredMatches[0];
                    console.log('智能分割 - 补充姓名(纯汉字):', result.name);
                }
            }
        }
    }
    
    // 5. 如果地址过长，可能是包含了姓名或电话
    if (result.address) {
        // 从地址中移除已识别的姓名
        if (result.name && result.address.includes(result.name)) {
            result.address = result.address.replace(result.name, '');
        }
        
        // 从地址中移除手机号（如果还有）
        if (result.phone && result.address.includes(result.phone)) {
            result.address = result.address.replace(result.phone, '');
        }
    }
    
    // 6. 清理地址
    if (result.address) {
        result.address = result.address
            .replace(/^[，。,.、;；\s]+|[，。,.、;；\s]+$/g, '')
            .replace(/\s+/g, '');
    }
    
    // 7. 判断是否成功
    result.success = result.phone && result.address;
    
    // 特殊情况：如果地址包含特定关键词，即使没有姓名也认为成功
    if (result.phone && result.address && !result.name) {
        // 尝试从地址中提取可能的姓名（如"刘先生"在地址中）
        const nameInAddress = result.address.match(/([\u4e00-\u9fa5]{2,4})(先生|女士|小姐|师傅)/);
        if (nameInAddress) {
            result.name = nameInAddress[1] + nameInAddress[2];
            result.address = result.address.replace(result.name, '');
            console.log('智能分割 - 从地址提取姓名:', result.name);
        }
        result.success = true;
    }
    
    console.log('智能分割 - 最终结果:', result);
    return result;
}
        // ==================== 页面初始化 ====================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                showLoading('正在加载数据...');

                if (!supabaseClient && window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase 客户端已初始化');
                }

                if (supabaseClient) {
                    await SupabaseData.initializeTables();
                }
                
                await loadAllDataFromSupabase();

                initHomePage();
                initAdminPanel();
                initMealManagement();
                initNewMealManagement();
                updateCartDisplay();
                updateOrderBadge();
                initImagePreview();
                initPasswordVerification();
                initStatusToggle();
                initMyOrdersPage();
                initHeaderButtons();
                initSearchFunction();
                initOrderConfirmModal();

                document.getElementById('currentUserIdDisplay').textContent = currentUserId.substring(0, 12) + '...';

                checkUrlParams();

                showNotification('页面加载完成', 'success');
                hideLoading();

                console.log('页面初始化完成，数据已从Supabase加载');
                
                startGlobalPolling();
            } catch (error) {
                console.error('页面初始化失败:', error);
                showNotification('页面初始化失败，使用本地缓存数据', 'error');
                hideLoading();

                loadFromLocalCache();

                initHomePage();
                initAdminPanel();
                initMealManagement();
                initNewMealManagement();
                updateCartDisplay();
                updateOrderBadge();
                initImagePreview();
                initPasswordVerification();
                initStatusToggle();
                initMyOrdersPage();
                initHeaderButtons();
                initSearchFunction();
                initOrderConfirmModal();
                
                startGlobalPolling();
            }
        });

        // ==================== 数据加载函数 ====================
        async function loadAllDataFromSupabase() {
            try {
                const [mealsData, ordersData, countData] = await Promise.all([
                    SupabaseData.loadMeals(),
                    SupabaseData.loadOrders(),
                    SupabaseData.loadNewOrdersCount()
                ]);

                meals = mealsData;
                orders = ordersData;
                newOrdersCount = countData;

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
                    id: m.id,
                    name: m.name,
                    price: m.price,
                    tags: m.tags,
                    description: m.description,
                    order: m.order,
                    active: m.active,
                    supportDelivery: m.supportDelivery
                }))));
                
                localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
                    id: o.id,
                    timestamp: o.timestamp,
                    status: o.status,
                    totalPrice: o.totalPrice,
                    userId: o.userId
                }))));
                
                localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

                console.log('数据加载完成:', {
                    套餐数: meals.length,
                    订单数: orders.length,
                    新订单计数: newOrdersCount
                });
            } catch (error) {
                console.error('加载数据失败:', error);
                throw error;
            }
        }

        function loadFromLocalCache() {
            const mealsCache = localStorage.getItem('kfcMealsCache');
            const ordersCache = localStorage.getItem('kfcOrdersCache');
            const countCache = localStorage.getItem('newOrdersCountCache');

            if (mealsCache) {
                try {
                    const parsedMeals = JSON.parse(mealsCache);
                    meals = parsedMeals.map(meal => ({
                        ...meal,
                        supportDelivery: meal.supportDelivery !== false
                    }));
                } catch (e) {
                    meals = [];
                }
            }

            if (ordersCache) {
                try {
                    orders = JSON.parse(ordersCache);
                } catch (e) {
                    orders = [];
                }
            }

            if (countCache) {
                try {
                    newOrdersCount = parseInt(countCache) || 0;
                } catch (e) {
                    newOrdersCount = 0;
                }
            }
        }

        // ==================== 订单确认模态框初始化 ====================
        function initOrderConfirmModal() {
            const orderConfirmModal = document.getElementById('orderConfirmModal');
            const orderConfirmClose = document.getElementById('orderConfirmClose');
            const orderConfirmCancel = document.getElementById('orderConfirmCancel');
            const orderConfirmSubmit = document.getElementById('orderConfirmSubmit');

            orderConfirmClose.addEventListener('click', function() {
                orderConfirmModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            });

            orderConfirmCancel.addEventListener('click', function() {
                orderConfirmModal.classList.remove('active');
                document.body.style.overflow = 'auto';
            });

            orderConfirmModal.addEventListener('click', function(e) {
                if (e.target === orderConfirmModal) {
                    orderConfirmModal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        }

        // ==================== 美化订单确认信息 ====================
        function showOrderConfirm(orderData) {
            const orderConfirmModal = document.getElementById('orderConfirmModal');
            const orderConfirmBody = document.getElementById('orderConfirmBody');
            const orderConfirmSubmit = document.getElementById('orderConfirmSubmit');

            document.body.style.overflow = 'hidden';

            let totalPrice = 0;
            cart.forEach(item => {
                totalPrice += item.totalPrice;
            });

            let itemsHTML = '';
            cart.forEach((item, index) => {
                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                const optionText = Object.keys(optionCount).map(option => {
                    const count = optionCount[option];
                    return `${option}${count > 1 ? ` ×${count}` : ''}`;
                }).join(', ');

                itemsHTML += `
                    <div class="order-confirm-option">
                        <span>${item.name} (${optionText})</span>
                        <span>¥${item.totalPrice.toFixed(2)}</span>
                    </div>
                `;
            });

            let deliveryInfoHTML = '';
            const infoLines = orderData.deliveryInfo.split('\n');
            infoLines.forEach(line => {
                if (line.trim()) {
                    deliveryInfoHTML += `<div>${line}</div>`;
                }
            });

            const orderConfirmHTML = `
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-shopping-cart"></i>
                        订单详情
                    </div>
                    <div class="order-confirm-item-content">
                        <div class="order-confirm-options">
                            ${itemsHTML}
                        </div>
                    </div>
                </div>
                
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-truck"></i>
                        配送信息
                    </div>
                    <div class="order-confirm-item-content">
                        ${deliveryInfoHTML}
                        ${orderData.orderNote ? `<div><strong>备注：</strong>${orderData.orderNote}</div>` : ''}
                    </div>
                </div>
                
                <div class="order-confirm-item">
                    <div class="order-confirm-item-title">
                        <i class="fas fa-clock"></i>
                        订单时间
                    </div>
                    <div class="order-confirm-item-content">
                        ${orderData.timestamp}
                    </div>
                </div>
                
                <div class="order-confirm-total">
                    订单总计：<span style="font-size:1.1em; color: #e31837;">¥${totalPrice.toFixed(2)}</span>
                </div>
                
                <div class="highlight" style="margin-top: 10px; padding: 6px; font-size: 0.8rem;">
                    <i class="fas fa-info-circle"></i>
                    提交订单后，您可以在"查看我的订单"页面查看订单状态
                </div>
            `;

            orderConfirmBody.innerHTML = orderConfirmHTML;

            orderConfirmSubmit.onclick = function() {
                orderConfirmModal.classList.remove('active');
                document.body.style.overflow = 'auto';
                setTimeout(() => {
                    completeOrderSubmission(orderData);
                }, 300);
            };

            orderConfirmModal.classList.add('active');
        }

        // ==================== 全局轮询函数 ====================
        function startGlobalPolling() {
            if (globalPollingInterval) {
                clearInterval(globalPollingInterval);
            }
            
            globalPollingInterval = setInterval(async () => {
                try {
                    const newCount = await SupabaseData.checkNewOrdersCountOnly();
                    if (newCount !== newOrdersCount) {
                        newOrdersCount = newCount;
                        updateOrderBadge();
                        
                        showRealtimeIndicator('检测到新订单！');
                        
                        console.log('全局轮询检测到新订单，数量：', newOrdersCount);
                        
                        if (isAdminPanelOpen) {
                            const activeFilterBtn = document.querySelector('.filter-btn.active');
                            const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                            await renderOrders(activeFilter);
                        }
                    }
                    
                    if (document.getElementById('myOrdersPage').classList.contains('active')) {
                        const updatedOrders = await SupabaseData.checkForOrderUpdates(lastUserOrderUpdateTime - 3000, currentUserId);
                        if (updatedOrders.length > 0) {
                            lastUserOrderUpdateTime = Date.now();
                            
                            updatedOrders.forEach(updatedOrder => {
                                const existingIndex = orders.findIndex(o => o.id === updatedOrder.id);
                                if (existingIndex !== -1) {
                                    orders[existingIndex].status = updatedOrder.status;
                                    orders[existingIndex].feedbackScreenshotData = updatedOrder.feedbackScreenshotData;
                                    orders[existingIndex].updatedAt = updatedOrder.updatedAt;
                                }
                            });
                            
                            showRealtimeIndicator(`您的订单有更新`);
                            
                            const activeFilterTab = document.querySelector('.order-filter-tab.active');
                            const activeFilter = activeFilterTab ? activeFilterTab.dataset.orderFilter : 'all';
                            renderUserOrders(activeFilter);
                        }
                    }
                    
                    lastGlobalCheckTime = Date.now();
                } catch (error) {
                    console.warn('全局轮询检查新订单失败:', error);
                }
            }, 3000);
        }
        
        function stopGlobalPolling() {
            if (globalPollingInterval) {
                clearInterval(globalPollingInterval);
                globalPollingInterval = null;
            }
        }

        // ==================== 搜索功能初始化 ====================
        function initSearchFunction() {
            const mealSearchInput = document.getElementById('mealSearchInput');
            const mealSearchBtn = document.getElementById('mealSearchBtn');
            
            if (mealSearchInput && mealSearchBtn) {
                mealSearchBtn.addEventListener('click', function() {
                    searchMeals(mealSearchInput.value.trim());
                });
                
                mealSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchMeals(this.value.trim());
                    }
                });
            }
            
            const adminMealSearchInput = document.getElementById('adminMealSearchInput');
            const adminMealSearchBtn = document.getElementById('adminMealSearchBtn');
            
            if (adminMealSearchInput && adminMealSearchBtn) {
                adminMealSearchBtn.addEventListener('click', function() {
                    adminSearchMeals(adminMealSearchInput.value.trim());
                });
                
                adminMealSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adminSearchMeals(this.value.trim());
                    }
                });
            }
        }

        // ==================== 搜索套餐功能 ====================
        function searchMeals(searchTerm) {
            const mealGrid = document.getElementById('mealGrid');
            const noMealsMessage = document.getElementById('noMealsMessage');
            
            mealGrid.innerHTML = '';

            if (!searchTerm) {
                updateHomePage();
                return;
            }

            const activeMeals = meals.filter(meal => meal.active !== false);
            
            if (activeMeals.length === 0) {
                noMealsMessage.style.display = 'block';
                return;
            }

            noMealsMessage.style.display = 'none';

            const searchTermLower = searchTerm.toLowerCase();
            
            const filteredMeals = activeMeals.filter(meal => {
                if (meal.name.toLowerCase().includes(searchTermLower)) return true;
                if (meal.id.toLowerCase().includes(searchTermLower)) return true;
                if (meal.price.toString().includes(searchTerm)) return true;
                if (meal.tags && meal.tags.some(tag => tag.toLowerCase().includes(searchTermLower))) return true;
                if (meal.description && meal.description.toLowerCase().includes(searchTermLower)) return true;
                return false;
            });

            if (filteredMeals.length === 0) {
                mealGrid.innerHTML = `
                    <div class="no-meals-message">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关套餐</h3>
                        <p>没有找到与"${searchTerm}"相关的套餐</p>
                    </div>
                `;
                return;
            }

            filteredMeals.sort((a, b) => {
                const orderDiff = (a.order || 9999) - (b.order || 9999);
                if (orderDiff !== 0) return orderDiff;
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            filteredMeals.forEach(meal => {
                const mealCard = document.createElement('a');
                mealCard.href = '#';
                mealCard.className = 'meal-card';
                if (meal.active === false) {
                    mealCard.classList.add('inactive');
                }
                mealCard.onclick = function(e) {
                    e.preventDefault();
                    if (meal.active === false) return;
                    showMealDetail(meal.id);
                };

                mealCard.innerHTML = `
                    <div class="meal-header">
                        <h4 class="meal-name">${meal.name}</h4>
                        <div class="meal-price">¥${meal.price}</div>
                    </div>
                    <div class="meal-description">
                        ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                        ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'}
                        <p style="margin-top: 8px;">${meal.description}</p>
                    </div>
                `;

                mealGrid.appendChild(mealCard);
            });
        }

        // ==================== 管理员搜索套餐功能 ====================
        function adminSearchMeals(searchTerm) {
            const mealList = document.getElementById('mealList');
            const noMealsAdminMessage = document.getElementById('noMealsAdminMessage');
            
            mealList.innerHTML = '';

            if (!searchTerm) {
                const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                updateMealList(activeFilter);
                return;
            }

            const searchTermLower = searchTerm.toLowerCase();
            
            const filteredMeals = meals.filter(meal => {
                if (meal.name.toLowerCase().includes(searchTermLower)) return true;
                if (meal.id.toLowerCase().includes(searchTermLower)) return true;
                if (meal.price.toString().includes(searchTerm)) return true;
                if (meal.tags && meal.tags.some(tag => tag.toLowerCase().includes(searchTermLower))) return true;
                if (meal.description && meal.description.toLowerCase().includes(searchTermLower)) return true;
                return false;
            });

            if (filteredMeals.length === 0) {
                mealList.innerHTML = `
                    <div class="no-meals-message">
                        <i class="fas fa-search"></i>
                        <h3>未找到相关套餐</h3>
                        <p>没有找到与"${searchTerm}"相关的套餐</p>
                    </div>
                `;
                return;
            }

            filteredMeals.sort((a, b) => {
                const orderDiff = (a.order || 9999) - (b.order || 9999);
                if (orderDiff !== 0) return orderDiff;
                return (b.createdAt || 0) - (a.createdAt || 0);
            });

            filteredMeals.forEach(meal => {
                const mealItem = document.createElement('div');
                mealItem.className = 'meal-list-item';

                let totalOptions = 0;
                if (meal.optionGroups && meal.optionGroups.length > 0) {
                    meal.optionGroups.forEach(group => {
                        if (group.items) {
                            totalOptions += group.items.length;
                        }
                    });
                }

                let totalFixed = 0;
                if (meal.fixedItems && meal.fixedItems.length > 0) {
                    meal.fixedItems.forEach(item => {
                        totalFixed += item.quantity || 1;
                    });
                }

                const createdAt = meal.createdAt ? new Date(meal.createdAt).toLocaleString('zh-CN') : '未知时间';

                const sortControls = `
                    <div class="sort-order-container">
                        <label>排序:</label>
                        <input type="number" class="sort-order-input" data-meal-id="${meal.id}" value="${meal.order || 9999}" min="0" step="1">
                        <div class="sort-order-buttons">
                            <button class="sort-order-btn" data-action="move-up" data-meal-id="${meal.id}" title="上移"><i class="fas fa-arrow-up"></i></button>
                            <button class="sort-order-btn" data-action="move-down" data-meal-id="${meal.id}" title="下移"><i class="fas fa-arrow-down"></i></button>
                            <button class="sort-order-btn" data-action="apply-order" data-meal-id="${meal.id}" title="应用排序"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                `;

                mealItem.innerHTML = `
                    <div class="meal-list-item-info">
                        <h4>${meal.name} ${meal.active === false ? '<span class="status-inactive">(已下架)</span>' : '<span class="status-active">(已上架)</span>'}</h4>
                        <p><strong>价格:</strong> ¥${meal.price} | <strong>标签:</strong> ${meal.tags.join(', ')}</p>
                        <p><strong>描述:</strong> ${meal.description}</p>
                        <p><strong>配送:</strong> ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'} | 
                           <strong>创建时间:</strong> ${createdAt} | <strong>排序值:</strong> <span class="order-display">${meal.order || 9999}</span></p>
                        <p><strong>选项组:</strong> ${meal.optionGroups ? meal.optionGroups.length : 0} 个 | 
                           <strong>选项项:</strong> ${totalOptions} 个 | 
                           <strong>固定搭配:</strong> ${totalFixed} 项</p>
                    </div>
                    <div class="meal-list-item-actions">
                        <div class="status-label">
                            <label class="status-toggle">
                                <input type="checkbox" class="status-toggle-input" data-meal-id="${meal.id}" ${meal.active !== false ? 'checked' : ''}>
                                <span class="status-slider"></span>
                            </label>
                            <span class="${meal.active !== false ? 'status-active' : 'status-inactive'}">${meal.active !== false ? '上架' : '下架'}</span>
                        </div>
                        ${sortControls}
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn edit-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="action-btn delete-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;

                mealList.appendChild(mealItem);
            });

            document.querySelectorAll('.status-toggle-input').forEach(toggle => {
                toggle.addEventListener('change', async function() {
                    const mealId = this.dataset.mealId;
                    const isActive = this.checked;
                    await toggleMealStatus(mealId, isActive);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mealId = this.dataset.mealId;
                    editMeal(mealId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const mealId = this.dataset.mealId;
                    await deleteMeal(mealId);
                });
            });

            document.querySelectorAll('.sort-order-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const mealId = this.dataset.mealId;
                    const action = this.dataset.action;
                    await handleSortAction(action, mealId);
                });
            });

            document.querySelectorAll('.sort-order-input').forEach(input => {
                input.addEventListener('change', async function() {
                    const mealId = this.dataset.mealId;
                    const newOrder = parseInt(this.value) || 9999;
                    await updateMealOrder(mealId, newOrder);
                });
            });
        }

        // ==================== 首页功能 ====================
        function initHomePage() {
            updateHomePage();
        }

        function updateHomePage() {
            const mealGrid = document.getElementById('mealGrid');
            const noMealsMessage = document.getElementById('noMealsMessage');
            const mealSearchInput = document.getElementById('mealSearchInput');

            if (mealSearchInput && mealSearchInput.value.trim()) {
                searchMeals(mealSearchInput.value.trim());
                return;
            }

            mealGrid.innerHTML = '';

            const activeMeals = meals
                .filter(meal => meal.active !== false)
                .sort((a, b) => {
                    const orderDiff = (a.order || 9999) - (b.order || 9999);
                    if (orderDiff !== 0) return orderDiff;
                    return (b.createdAt || 0) - (a.createdAt || 0);
                });

            if (activeMeals.length === 0) {
                noMealsMessage.style.display = 'block';
                return;
            }

            noMealsMessage.style.display = 'none';

            activeMeals.forEach(meal => {
                const mealCard = document.createElement('a');
                mealCard.href = '#';
                mealCard.className = 'meal-card';
                if (meal.active === false) {
                    mealCard.classList.add('inactive');
                }
                mealCard.onclick = function(e) {
                    e.preventDefault();
                    if (meal.active === false) return;
                    showMealDetail(meal.id);
                };

                mealCard.innerHTML = `
                    <div class="meal-header">
                        <h4 class="meal-name">${meal.name}</h4>
                        <div class="meal-price">¥${meal.price}</div>
                    </div>
                    <div class="meal-description">
                        ${meal.tags.map(tag => `<span class="meal-tag">${tag}</span>`).join('')}
                        ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'}
                        <p style="margin-top: 8px;">${meal.description}</p>
                    </div>
                `;

                mealGrid.appendChild(mealCard);
            });
        }

        // ==================== 套餐详情页 ====================
        function showMealDetail(mealId) {
            const meal = meals.find(m => m.id === mealId);
            if (!meal) return;

            const mealDetailPage = document.getElementById('mealDetailPage');

            mealDetailPage.innerHTML = `
                <a href="#" class="back-btn" onclick="showPage('homePage')">
                    <i class="fas fa-arrow-left"></i>
                    返回套餐列表
                </a>
                
                <div class="main-content">
                    <div class="menu-section">
                        <h2 class="section-title">
                            <i class="fas fa-hamburger"></i>
                            ${meal.name}
                        </h2>
                        
                        <div class="highlight">
                            <i class="fas fa-info-circle"></i>
                            ${meal.supportDelivery === false ? '此套餐仅支持到店自提（堂食/打包）' : '此套餐支持宅急送配送和到店自提'}
                        </div>
                        
                        <div class="instructions">
                            <p><strong>套餐详情：</strong></p>
                            <ul>
                                <li>${meal.description}</li>
                                <li>请按照要求选择选项</li>
                                <li>提交订单后可在右上角"查看我的订单"查看订单状态</li>
                            </ul>
                        </div>
                        
                        <div class="meal-options" id="mealOptions">
                            ${generateOptionsHTML(meal)}
                        </div>
                        <button class="add-to-cart" data-meal-id="${meal.id}" data-meal-name="${meal.name}" data-meal-price="${meal.price}" disabled>
                            <i class="fas fa-cart-plus"></i>
                            加入购物车
                        </button>
                    </div>
                    
                    <div class="right-section">
                        <!-- 配送信息和购物车在一起 -->
                        <div class="delivery-form">
                            <h3 class="section-title">
                                <i class="fas fa-truck"></i>
                                配送信息
                            </h3>
                            
                            <div class="order-type">
                                ${meal.supportDelivery !== false ? `
                                <label>
                                    <input type="radio" name="deliveryType" value="delivery" checked>
                                    <span>宅急送（免配送费）</span>
                                </label>
                                ` : ''}
                                <label>
                                    <input type="radio" name="deliveryType" value="pickup" ${meal.supportDelivery === false ? 'checked' : ''}>
                                    <span>到店自提</span>
                                </label>
                            </div>
                            
                           ${meal.supportDelivery !== false ? `
                           <div class="delivery-fields" id="deliveryFields" ${meal.supportDelivery === false ? 'style="display:none;"' : ''}>
                               <div class="form-group">
                                   <label class="form-label">信息提供方式 <span class="required">*</span></label>
                                   <div class="info-method-selector">
                                       <label class="method-option">
                                           <input type="radio" name="deliveryMethod" value="manual">
                                           <span>手动填写</span>
                                       </label>
                                       <label class="method-option">
                                           <input type="radio" name="deliveryMethod" value="screenshot" checked>
                                           <span>上传截图</span>
                                       </label>
                                   </div>
                               </div>
                               
                               <div class="manual-fields hidden" id="manualFields">
                                   <!-- 粘贴识别区域 -->
                                   <div class="delivery-paste-area" id="deliveryPasteArea">
                                       <textarea id="pasteTextarea" placeholder="请在这里粘贴您的配送信息"></textarea>
                                       <button class="recognize-btn" id="recognizeBtn">
                                           <i class="fas fa-magic"></i>
                                           智能识别
                                       </button>
                                   </div>
                                   <div id="recognizeResult" style="display:none;"></div>
                                   
                                   <div class="form-group">
                                       <label class="form-label">收货人姓名 <span class="required">*</span></label>
                                       <input type="text" class="form-input" id="customerName" placeholder="请输入姓名" required>
                                   </div>
                                   
                                   <div class="form-group">
                                       <label class="form-label">联系电话 <span class="required">*</span></label>
                                       <input type="tel" class="form-input" id="customerPhone" placeholder="请输入手机号码" required>
                                   </div>
                                   
                                   <div class="form-group">
                                       <label class="form-label">配送地址 <span class="required">*</span></label>
                                       <input type="text" class="form-input" id="deliveryAddress" placeholder="请输入详细地址" required>
                                   </div>
                               </div>
                               
                               <div class="screenshot-fields" id="screenshotFields">
                                   <div class="form-group">
                                       <label class="form-label">上传配送信息截图 <span class="required">*</span></label>
                                       <div class="screenshot-upload-area" id="screenshotUploadArea">
                                           <i class="fas fa-cloud-upload-alt"></i>
                                           <p>点击或拖拽上传截图</p>
                                           <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 2MB，建议压缩后上传</p>
                                           <input type="file" id="storeScreenshot" accept="image/*" style="display: none;">
                                       </div>
                                       <div class="screenshot-preview hidden" id="screenshotPreview">
                                           <div class="screenshot-preview-container">
                                               <img id="previewImage" src="" alt="截图预览">
                                               <div class="image-info" id="imageInfo"></div>
                                           </div>
                                           <button type="button" class="remove-screenshot" id="removeScreenshot">
                                               <i class="fas fa-times"></i>
                                           </button>
                                       </div>
                                       <div class="compress-progress" id="compressProgress">
                                           <i class="fas fa-compress-alt"></i> 正在压缩图片... <span id="compressPercent">0%</span>
                                       </div>
                                       <div class="form-hint">
                                           <i class="fas fa-lightbulb"></i> 系统会自动压缩图片到合适大小，确保上传速度
                                       </div>
                                   </div>
                               </div>
                           </div>
                           ` : ''}
                            
                            <div class="pickup-fields ${meal.supportDelivery !== false ? 'hidden' : ''}" id="pickupFields" ${meal.supportDelivery === false ? 'style="display:block;"' : ''}>
                                <div class="form-group">
                                    <label class="form-label">自提方式 <span class="required">*</span></label>
                                    <div class="pickup-type">
                                        <label>
                                            <input type="radio" name="pickupType" value="堂食" checked>
                                            <span>堂食</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="pickupType" value="外带">
                                            <span>外带</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">门店信息提供方式 <span class="required">*</span></label>
                                    <div class="info-method-selector">
                                        <label class="method-option">
                                            <input type="radio" name="pickupMethod" value="text" checked>
                                            <span>手动填写</span>
                                        </label>
                                        <label class="method-option">
                                            <input type="radio" name="pickupMethod" value="screenshot">
                                            <span>上传截图</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="text-method-fields" id="textMethodFields">
                                    <div class="store-selection">
                                        <div class="form-group">
                                            <label class="form-label">自提城市 <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="pickupCityInput" placeholder="例如：北京市" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">自提门店 <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="pickupStoreInput" placeholder="例如：肯德基王府井店" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="screenshot-method-fields hidden" id="screenshotMethodFields">
                                    <div class="form-group">
                                        <label class="form-label">上传门店截图 <span class="required">*</span></label>
                                        <div class="screenshot-upload-area" id="pickupScreenshotUploadArea">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <p>点击或拖拽上传截图</p>
                                            <p class="upload-hint">支持 JPG、PNG 格式，大小不超过 2MB，建议压缩后上传</p>
                                            <input type="file" id="pickupStoreScreenshot" accept="image/*" style="display: none;">
                                        </div>
                                        <div class="screenshot-preview hidden" id="pickupScreenshotPreview">
                                            <div class="screenshot-preview-container">
                                                <img id="pickupPreviewImage" src="" alt="截图预览">
                                                <div class="image-info" id="pickupImageInfo"></div>
                                            </div>
                                            <button type="button" class="remove-screenshot" id="removePickupScreenshot">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <div class="compress-progress" id="pickupCompressProgress">
                                            <i class="fas fa-compress-alt"></i> 正在压缩图片... <span id="pickupCompressPercent">0%</span>
                                        </div>
                                        <div class="form-hint">
                                            <i class="fas fa-lightbulb"></i> 系统会自动压缩图片到合适大小，确保上传速度
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">订单备注</label>
                                <textarea class="form-input" id="orderNote" rows="2" placeholder="如有特殊要求请在此备注（例如：不吃辣，多要番茄酱等）"></textarea>
                            </div>
                            
                            <!-- 购物车在配送信息表单底部 -->
                            <div class="cart-section">
                                <h2 class="section-title">
                                    <i class="fas fa-shopping-cart"></i>
                                    购物车
                                </h2>
                                
                                <div class="cart-items" id="cartItems">
                                    <div class="empty-cart-message">购物车是空的，请选择套餐</div>
                                </div>
                                
                                <div class="cart-total">
                                    <span>总计：</span>
                                    <span class="total-price" id="totalPrice">¥0.00</span>
                                </div>
                                
                                <!-- 移除进度条，改为简单的状态提示 -->
                                <div class="submit-status" id="submitStatus"></div>
                                
                                <button class="checkout-btn quick-submit" id="checkoutBtn" disabled>
                                    <i class="fas fa-credit-card"></i>
                                    快速提交订单
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            initOptionSelection(mealDetailPage);
            initDeliveryTypeToggle(mealDetailPage);
            initDeliveryMethodToggle(mealDetailPage);
            initPasteRecognition(mealDetailPage);
            initPickupMethod(mealDetailPage);
            initCart(mealDetailPage);
            initCheckout(mealDetailPage);

            if (!meal.optionGroups || meal.optionGroups.length === 0) {
                const addToCartBtn = mealDetailPage.querySelector('.add-to-cart');
                if (addToCartBtn) {
                    addToCartBtn.disabled = false;
                    addToCartBtn.style.opacity = '1';
                    addToCartBtn.style.cursor = 'pointer';
                }
            }

            showPage('mealDetailPage');

            document.getElementById('viewOrdersBtn').style.display = 'none';
            document.getElementById('viewHomeBtn').style.display = 'flex';
        }

        function generateOptionsHTML(meal) {
            let html = '';

            if (meal.optionGroups && meal.optionGroups.length > 0) {
                meal.optionGroups.forEach((group, groupIndex) => {
                    const groupId = `group-${meal.id}-${groupIndex}`;
                    const repeat = group.repeat ? 'true' : 'false';
                    const maxPerItem = group.maxPerItem || (group.repeat ? 999 : 1);

                    html += `
                        <div class="option-group" data-group-id="${groupId}" data-min-select="${group.minSelect}" data-max-select="${group.maxSelect}" data-repeat="${repeat}" data-max-per-item="${maxPerItem}">
                            <div class="option-title">${group.title}</div>
                            <div class="option-rules">${group.rules}</div>
                            <div class="option-items">
                    `;

                    if (group.items && group.items.length > 0) {
                        group.items.forEach((item, itemIndex) => {
                            const itemId = `${groupId}-${itemIndex}`;
                            const addPrice = item.addPrice || 0;
                            const addPriceText = addPrice > 0 ? ` (+¥${addPrice})` : '';

                            html += `
                                <div class="option-item" data-item-id="${itemId}" data-name="${item.name}" data-add-price="${addPrice}">
                                    <span>${item.name}${addPriceText}</span>
                                    <div class="selection-counter">
                                        <button class="counter-btn decrement" disabled>-</button>
                                        <span class="counter-value">0</span>
                                        <button class="counter-btn increment">+</button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    html += `
                            </div>
                            <div class="selection-status invalid">已选择 0 份，还需选择 ${group.minSelect} 份</div>
                        </div>
                    `;
                });
            }

            if (meal.fixedItems && meal.fixedItems.length > 0) {
                html += `
                    <div class="fixed-combo-items">
                        <div class="option-title">固定搭配：</div>
                        <div class="option-rules">套餐包含固定搭配，无需选择</div>
                        <div class="fixed-combo-list">
                `;

                meal.fixedItems.forEach(item => {
                    html += `
                        <div class="fixed-combo-item">
                            <div class="fixed-combo-item-name">${item.name}</div>
                            <div class="fixed-combo-item-qty">×${item.quantity}</div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // ==================== 页面切换 ====================
        function showPage(pageId) {
            document.querySelectorAll('.meal-page-container').forEach(page => {
                page.classList.remove('active');
            });

            document.getElementById(pageId).classList.add('active');

            window.scrollTo(0, 0);

            if (pageId === 'homePage') {
                document.getElementById('viewOrdersBtn').style.display = 'flex';
                document.getElementById('viewHomeBtn').style.display = 'none';
            }
        }

        // ==================== 选项选择功能 ====================
        function initOptionSelection(container) {
            container.querySelectorAll('.counter-btn.increment').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const optionItem = this.closest('.option-item');
                    const counterValue = optionItem.querySelector('.counter-value');
                    const decrementBtn = optionItem.querySelector('.decrement');
                    const group = optionItem.closest('.option-group');

                    const maxSelect = parseInt(group.dataset.maxSelect) || Infinity;
                    const repeat = group.dataset.repeat === 'true';
                    const maxPerItem = parseInt(group.dataset.maxPerItem) || (repeat ? Infinity : 1);

                    let totalSelected = 0;
                    group.querySelectorAll('.counter-value').forEach(value => {
                        totalSelected += parseInt(value.textContent);
                    });

                    let currentSelected = parseInt(counterValue.textContent);

                    if (totalSelected >= maxSelect) {
                        showNotification(`该选项组最多只能选择${maxSelect}份`);
                        return;
                    }

                    if (currentSelected >= maxPerItem) {
                        showNotification(`该选项最多只能选择${maxPerItem}份`);
                        return;
                    }

                    currentSelected++;
                    counterValue.textContent = currentSelected;

                    decrementBtn.disabled = false;
                    optionItem.classList.add('selected');

                    updateGroupSelectionStatus(group);
                });
            });

            container.querySelectorAll('.counter-btn.decrement').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const optionItem = this.closest('.option-item');
                    const counterValue = optionItem.querySelector('.counter-value');

                    let currentSelected = parseInt(counterValue.textContent);

                    if (currentSelected > 0) {
                        currentSelected--;
                        counterValue.textContent = currentSelected;

                        this.disabled = currentSelected === 0;

                        if (currentSelected === 0) {
                            optionItem.classList.remove('selected');
                        }

                        const group = optionItem.closest('.option-group');
                        updateGroupSelectionStatus(group);
                    }
                });
            });

            container.querySelectorAll('.option-item').forEach(item => {
                if (!item.classList.contains('selected')) {
                    item.addEventListener('click', function() {
                        const incrementBtn = this.querySelector('.increment');
                        if (incrementBtn) {
                            incrementBtn.click();
                        }
                    });
                }
            });
        }

        function updateGroupSelectionStatus(group) {
            if (!group.dataset.minSelect) return;

            const minSelect = parseInt(group.dataset.minSelect);
            const maxSelect = parseInt(group.dataset.maxSelect);

            let totalSelected = 0;
            group.querySelectorAll('.counter-value').forEach(value => {
                totalSelected += parseInt(value.textContent);
            });

            const statusElement = group.querySelector('.selection-status');
            if (statusElement) {
                if (totalSelected >= minSelect && totalSelected <= maxSelect) {
                    statusElement.textContent = `已选择 ${totalSelected} 份，符合要求`;
                    statusElement.className = 'selection-status valid';
                } else if (totalSelected < minSelect) {
                    statusElement.textContent = `已选择 ${totalSelected} 份，还需选择 ${minSelect - totalSelected} 份`;
                    statusElement.className = 'selection-status invalid';
                } else {
                    statusElement.textContent = `已选择 ${totalSelected} 份，已超过最大 ${maxSelect} 份`;
                    statusElement.className = 'selection-status invalid';
                }
            }

            const mealContainer = group.closest('.meal-page-container');
            updateAddToCartButton(mealContainer);
        }

        function updateAddToCartButton(mealContainer) {
            const addToCartBtn = mealContainer.querySelector('.add-to-cart');
            if (!addToCartBtn) return;

            const optionGroups = mealContainer.querySelectorAll('.option-group');
            if (optionGroups.length === 0) {
                addToCartBtn.disabled = false;
                addToCartBtn.style.opacity = '1';
                addToCartBtn.style.cursor = 'pointer';
                return;
            }

            let isValid = true;

            optionGroups.forEach(group => {
                if (!group.dataset.minSelect) return;

                const minSelect = parseInt(group.dataset.minSelect);
                const maxSelect = parseInt(group.dataset.maxSelect);

                let totalSelected = 0;
                group.querySelectorAll('.counter-value').forEach(value => {
                    totalSelected += parseInt(value.textContent);
                });

                if (totalSelected < minSelect || totalSelected > maxSelect) {
                    isValid = false;
                }
            });

            if (isValid) {
                addToCartBtn.disabled = false;
                addToCartBtn.style.opacity = '1';
                addToCartBtn.style.cursor = 'pointer';
            } else {
                addToCartBtn.disabled = true;
                addToCartBtn.style.opacity = '0.6';
                addToCartBtn.style.cursor = 'not-allowed';
            }
        }

        // ==================== 配送方式切换 ====================
        function initDeliveryTypeToggle(container) {
            container.querySelectorAll('input[name="deliveryType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deliveryFields = container.querySelector('.delivery-fields');
                    const pickupFields = container.querySelector('.pickup-fields');

                    if (this.value === 'delivery') {
                        if (deliveryFields) deliveryFields.classList.remove('hidden');
                        if (pickupFields) pickupFields.classList.add('hidden');
                    } else {
                        if (deliveryFields) deliveryFields.classList.add('hidden');
                        if (pickupFields) pickupFields.classList.remove('hidden');
                    }
                });
            });
        }

        // ==================== 配送方式切换（手动填写/上传截图） ====================
        function initDeliveryMethodToggle(container) {
            container.querySelectorAll('input[name="deliveryMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const manualFields = container.querySelector('.manual-fields');
                    const screenshotFields = container.querySelector('.screenshot-fields');

                    if (this.value === 'manual') {
                        manualFields.classList.remove('hidden');
                        screenshotFields.classList.add('hidden');
                    } else {
                        screenshotFields.classList.remove('hidden');
                        manualFields.classList.add('hidden');
                    }
                });
            });
        }

        // ==================== 粘贴识别功能 ====================
        function initPasteRecognition(container) {
            const pasteTextarea = container.querySelector('#pasteTextarea');
            const recognizeBtn = container.querySelector('#recognizeBtn');
            const recognizeResult = container.querySelector('#recognizeResult');
            const customerName = container.querySelector('#customerName');
            const customerPhone = container.querySelector('#customerPhone');
            const deliveryAddress = container.querySelector('#deliveryAddress');
        
            if (!pasteTextarea || !recognizeBtn) return;
        
            // 粘贴时自动识别（延迟执行，确保粘贴完成）
            pasteTextarea.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const text = pasteTextarea.value;
                    if (text.trim()) {
                        autoRecognize(text);
                    }
                }, 50);
            });
        
            // 点击识别按钮
            recognizeBtn.addEventListener('click', function() {
                const text = pasteTextarea.value.trim();
                if (!text) {
                    showNotification('请先粘贴配送信息', 'error');
                    pasteTextarea.focus();
                    return;
                }
                
                autoRecognize(text);
            });
        
            // 输入时也可以触发识别（按回车键）
            pasteTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    recognizeBtn.click();
                }
            });
        
            function autoRecognize(text) {
                const result = recognizeDeliveryInfo(text);
                
                let resultHTML = '';
                if (result.success) {
                    resultHTML = `
                        <div class="recognize-result">
                            <p><strong>识别成功！</strong></p>
                            
                        </div>
                    `;
                    
                    // 自动填充表单
                    customerName.value = result.name;
                    customerPhone.value = result.phone;
                    deliveryAddress.value = result.address;
                    
                    // 添加应用按钮事件
                    setTimeout(() => {
                        const applyBtn = container.querySelector('#applyRecognition');
                        if (applyBtn) {
                            applyBtn.addEventListener('click', function() {
                                customerName.value = result.name;
                                customerPhone.value = result.phone;
                                deliveryAddress.value = result.address;
                                showNotification('识别结果已应用到表单', 'success');
                            });
                        }
                    }, 100);
                    
                } else {
                    resultHTML = `
                        <div class="recognize-result" style="border-left-color: #e31837; background-color: #ffebee;">
                            <p><strong>识别结果：</strong></p>
                            <p><strong>姓名：</strong>${result.name || '未识别到姓名'}</p>
                            <p><strong>电话：</strong>${result.phone || '未识别到电话'}</p>
                            <p><strong>地址：</strong>${result.address || '未识别到地址'}</p>
                            <p style="color: #e31837; margin-top: 8px; font-size: 0.8rem;">
                                <i class="fas fa-exclamation-triangle"></i> 请手动补充信息
                            </p>
                        </div>
                    `;
                    
                    // 部分填充表单
                    if (result.name) customerName.value = result.name;
                    if (result.phone) customerPhone.value = result.phone;
                    if (result.address) deliveryAddress.value = result.address;
                }
                
                recognizeResult.innerHTML = resultHTML;
                recognizeResult.style.display = 'block';
                
                // 滚动到识别结果
                recognizeResult.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        }
        // ==================== 自提方式处理 ====================
        function initPickupMethod(container) {
            container.querySelectorAll('input[name="pickupMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const textFields = container.querySelector('.text-method-fields');
                    const screenshotFields = container.querySelector('.screenshot-method-fields');

                    if (this.value === 'text') {
                        textFields.classList.remove('hidden');
                        screenshotFields.classList.add('hidden');
                    } else {
                        screenshotFields.classList.remove('hidden');
                        textFields.classList.add('hidden');
                    }
                });
            });

            // 宅急送截图上传
            const deliveryUploadArea = container.querySelector('#screenshotUploadArea');
            if (deliveryUploadArea) {
                const fileInput = deliveryUploadArea.querySelector('input[type="file"]');
                const previewContainer = deliveryUploadArea.parentElement.querySelector('.screenshot-preview');
                const previewImage = previewContainer ? previewContainer.querySelector('img') : null;
                const removeBtn = previewContainer ? previewContainer.querySelector('.remove-screenshot') : null;
                const compressProgress = container.querySelector('.compress-progress');
                const compressPercent = compressProgress ? compressProgress.querySelector('#compressPercent') : null;
                const imageInfo = container.querySelector('#imageInfo');

                if (deliveryUploadArea && fileInput && previewContainer && previewImage && removeBtn) {
                    deliveryUploadArea.addEventListener('click', function() {
                        fileInput.click();
                    });

                    deliveryUploadArea.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#e31837';
                        this.style.backgroundColor = '#fff5f5';
                    });

                    deliveryUploadArea.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = '#f9f9f9';
                    });

                    deliveryUploadArea.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = '#f9f9f9';

                        if (e.dataTransfer.files.length) {
                            handleFileSelect(e.dataTransfer.files[0], fileInput, previewContainer, previewImage, deliveryUploadArea, compressProgress, compressPercent, imageInfo);
                        }
                    });

                    fileInput.addEventListener('change', function(e) {
                        if (e.target.files.length) {
                            handleFileSelect(e.target.files[0], fileInput, previewContainer, previewImage, deliveryUploadArea, compressProgress, compressPercent, imageInfo);
                        }
                    });

                    removeBtn.addEventListener('click', function() {
                        fileInput.value = '';
                        previewContainer.classList.add('hidden');
                        deliveryUploadArea.style.display = 'block';
                        if (compressProgress) compressProgress.classList.remove('active');
                    });
                }
            }

            // 自提截图上传
            const pickupUploadArea = container.querySelector('#pickupScreenshotUploadArea');
            if (pickupUploadArea) {
                const pickupFileInput = pickupUploadArea.querySelector('input[type="file"]');
                const pickupPreviewContainer = pickupUploadArea.parentElement.querySelector('.screenshot-preview');
                const pickupPreviewImage = pickupPreviewContainer ? pickupPreviewContainer.querySelector('img') : null;
                const pickupRemoveBtn = pickupPreviewContainer ? pickupPreviewContainer.querySelector('.remove-screenshot') : null;
                const pickupCompressProgress = container.querySelector('#pickupCompressProgress');
                const pickupCompressPercent = pickupCompressProgress ? pickupCompressProgress.querySelector('#pickupCompressPercent') : null;
                const pickupImageInfo = container.querySelector('#pickupImageInfo');

                if (pickupUploadArea && pickupFileInput && pickupPreviewContainer && pickupPreviewImage && pickupRemoveBtn) {
                    pickupUploadArea.addEventListener('click', function() {
                        pickupFileInput.click();
                    });

                    pickupUploadArea.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#e31837';
                        this.style.backgroundColor = '#fff5f5';
                    });

                    pickupUploadArea.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = '#f9f9f9';
                    });

                    pickupUploadArea.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.style.borderColor = '#ddd';
                        this.style.backgroundColor = '#f9f9f9';

                        if (e.dataTransfer.files.length) {
                            handleFileSelect(e.dataTransfer.files[0], pickupFileInput, pickupPreviewContainer, pickupPreviewImage, pickupUploadArea, pickupCompressProgress, pickupCompressPercent, pickupImageInfo);
                        }
                    });

                    pickupFileInput.addEventListener('change', function(e) {
                        if (e.target.files.length) {
                            handleFileSelect(e.target.files[0], pickupFileInput, pickupPreviewContainer, pickupPreviewImage, pickupUploadArea, pickupCompressProgress, pickupCompressPercent, pickupImageInfo);
                        }
                    });

                    pickupRemoveBtn.addEventListener('click', function() {
                        pickupFileInput.value = '';
                        pickupPreviewContainer.classList.add('hidden');
                        pickupUploadArea.style.display = 'block';
                        if (pickupCompressProgress) pickupCompressProgress.classList.remove('active');
                    });
                }
            }

            async function handleFileSelect(file, fileInput, previewContainer, previewImage, uploadArea, compressProgress, compressPercent, imageInfo) {
                if (!file.type.match('image.*')) {
                    showNotification('请选择图片文件', 'error');
                    return;
                }

                if (compressProgress) {
                    compressProgress.classList.add('active');
                    if (compressPercent) compressPercent.textContent = '0%';
                }

                const compressedImage = await compressImageFast(file, 800, 0.7);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.remove('hidden');
                    uploadArea.style.display = 'none';
                    
                    if (imageInfo) {
                        const originalSize = (file.size / 1024).toFixed(2);
                        const compressedSize = (compressedImage.size / 1024).toFixed(2);
                        const compressionRatio = ((1 - compressedImage.size / file.size) * 100).toFixed(1);
                        imageInfo.innerHTML = `
                            原始大小: ${originalSize}KB<br>
                            压缩后: ${compressedSize}KB<br>
                            压缩率: ${compressionRatio}%
                        `;
                    }
                    
                    if (compressProgress) {
                        compressProgress.classList.remove('active');
                    }
                    
                    fileInput.files = dataURLtoBlob(e.target.result);
                };
                reader.readAsDataURL(compressedImage);
            }

            function dataURLtoBlob(dataURL) {
                const arr = dataURL.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                const blob = new Blob([u8arr], {type: mime});
                
                const file = new File([blob], "compressed_image.jpg", {type: mime});
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                return dataTransfer.files;
            }
        }

        // ==================== 购物车功能 ====================
        function initCart(container) {
            const addToCartBtn = container.querySelector('.add-to-cart');
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', function() {
                    const optionGroups = container.querySelectorAll('.option-group');

                    if (this.disabled && optionGroups.length > 0) {
                        showNotification('请先完成选项选择，确保每个选项组的选择数量符合要求');
                        return;
                    }

                    const mealId = this.dataset.mealId;
                    const mealName = this.dataset.mealName;
                    const mealPrice = parseFloat(this.dataset.mealPrice);

                    const meal = meals.find(m => m.id === mealId);
                    if (!meal) return;

                    const selectedOptions = [];
                    let additionalPrice = 0;

                    container.querySelectorAll('.option-group').forEach(group => {
                        group.querySelectorAll('.option-item').forEach(item => {
                            const counterValue = item.querySelector('.counter-value');
                            const count = parseInt(counterValue.textContent);

                            if (count > 0) {
                                const itemName = item.dataset.name || item.textContent;
                                const itemAddPrice = parseFloat(item.dataset.addPrice) || 0;

                                for (let i = 0; i < count; i++) {
                                    selectedOptions.push(itemName);
                                    additionalPrice += itemAddPrice;
                                }
                            }
                        });
                    });

                    if (meal.fixedItems && meal.fixedItems.length > 0) {
                        meal.fixedItems.forEach(item => {
                            for (let i = 0; i < item.quantity; i++) {
                                selectedOptions.push(item.name);
                            }
                        });
                    }

                    if (selectedOptions.length === 0) {
                        showNotification('该套餐没有任何项目，无法加入购物车');
                        return;
                    }

                    const totalPrice = mealPrice + additionalPrice;

                    const mealItem = {
                        id: mealId,
                        name: mealName,
                        basePrice: mealPrice,
                        additionalPrice: additionalPrice,
                        totalPrice: totalPrice,
                        options: [...selectedOptions],
                        supportDelivery: meal.supportDelivery
                    };

                    if (cart.length > 0) {
                        const firstMealDelivery = cart[0].supportDelivery;
                        if (firstMealDelivery !== meal.supportDelivery) {
                            showNotification('无法同时添加支持宅急送和不支持宅急送的套餐到购物车', 'error');
                            return;
                        }
                    }

                    cart.push(mealItem);

                    updateCartDisplay();

                    showNotification(`已添加 "${mealName}" 到购物车`, 'success');

                    resetOptions(container);
                });
            }
        }

        function resetOptions(container) {
            container.querySelectorAll('.option-group').forEach(group => {
                group.querySelectorAll('.option-item').forEach(item => {
                    const counterValue = item.querySelector('.counter-value');
                    const decrementBtn = item.querySelector('.decrement');

                    counterValue.textContent = '0';
                    if (decrementBtn) {
                        decrementBtn.disabled = true;
                    }
                    item.classList.remove('selected');
                });

                updateGroupSelectionStatus(group);
            });
        }

        function updateCartDisplay() {
            document.querySelectorAll('.cart-items').forEach(container => {
                container.innerHTML = '';

                let totalPrice = 0;

                if (cart.length === 0) {
                    container.innerHTML = '<div class="empty-cart-message">购物车是空的，请选择套餐</div>';
                } else {
                    cart.forEach((item, index) => {
                        const cartItemElement = document.createElement('div');
                        cartItemElement.className = 'cart-item';

                        const optionsHtml = item.options.map(option => `<div>• ${option}</div>`).join('');

                        cartItemElement.innerHTML = `
                            <div class="cart-item-name">
                                <div><strong>${item.name}</strong></div>
                                <div style="font-size:0.8rem; color:#666; margin-top:3px;">
                                    ${optionsHtml}
                                </div>
                            </div>
                            <div class="cart-item-price">¥${item.totalPrice.toFixed(2)}</div>
                            <button class="cart-item-remove" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </button>
                        `;

                        container.appendChild(cartItemElement);

                        totalPrice += item.totalPrice;

                        cartItemElement.querySelector('.cart-item-remove').addEventListener('click', function() {
                            const indexToRemove = parseInt(this.dataset.index);
                            cart.splice(indexToRemove, 1);
                            updateCartDisplay();
                            showNotification('已从购物车中移除商品');
                        });
                    });
                }

                const totalPriceElement = container.closest('.cart-section').querySelector('.total-price');
                const checkoutBtn = container.closest('.cart-section').querySelector('.checkout-btn');

                if (totalPriceElement) {
                    totalPriceElement.textContent = `¥${totalPrice.toFixed(2)}`;
                }

                if (checkoutBtn) {
                    checkoutBtn.disabled = cart.length === 0;
                }
            });
        }

        // ==================== 订单提交功能 ====================
        function initCheckout(container) {
            const checkoutBtn = container.querySelector('.checkout-btn');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', async function() {
                    if (checkoutBtn.disabled) return;
                    
                    const deliveryType = container.querySelector('input[name="deliveryType"]:checked').value;
                    const orderNote = container.querySelector('#orderNote') ? container.querySelector('#orderNote').value.trim() : '';

                    let deliveryInfo = '';
                    let hasScreenshot = false;
                    let screenshotData = null;
                    let pickupType = '';

                    if (deliveryType === 'delivery') {
                        const deliveryMethod = container.querySelector('input[name="deliveryMethod"]:checked').value;
                        
                        if (deliveryMethod === 'manual') {
                            const customerName = container.querySelector('#customerName') ? container.querySelector('#customerName').value.trim() : '';
                            const customerPhone = container.querySelector('#customerPhone') ? container.querySelector('#customerPhone').value.trim() : '';
                            const deliveryAddress = container.querySelector('#deliveryAddress') ? container.querySelector('#deliveryAddress').value.trim() : '';

                            if (!customerName) {
                                showNotification('请输入收货人姓名', 'error');
                                const nameInput = container.querySelector('#customerName');
                                if (nameInput) nameInput.focus();
                                return;
                            }

                            if (!customerPhone) {
                                showNotification('请输入联系电话', 'error');
                                const phoneInput = container.querySelector('#customerPhone');
                                if (phoneInput) phoneInput.focus();
                                return;
                            }

                            if (!deliveryAddress) {
                                showNotification('请输入配送地址', 'error');
                                const addressInput = container.querySelector('#deliveryAddress');
                                if (addressInput) addressInput.focus();
                                return;
                            }

                            deliveryInfo = `配送方式：宅急送\n信息提供：手动填写\n收货人：${customerName}\n联系电话：${customerPhone}\n配送地址：${deliveryAddress}`;
                        } else {
                            const screenshotInput = container.querySelector('#storeScreenshot');

                            if (!screenshotInput.files || !screenshotInput.files.length) {
                                showNotification('请上传配送信息截图', 'error');
                                return;
                            }

                            const submitStatus = document.getElementById('submitStatus');
                            submitStatus.textContent = '正在处理图片...';

                            try {
                                const file = screenshotInput.files[0];
                                const reader = new FileReader();

                                reader.onload = function(e) {
                                    screenshotData = e.target.result;
                                    hasScreenshot = true;

                                    deliveryInfo = `配送方式：宅急送\n信息提供：截图上传`;

                                    submitStatus.textContent = '图片处理完成';

                                    setTimeout(() => {
                                        submitStatus.textContent = '';
                                        prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
                                    }, 500);
                                };

                                reader.onerror = function() {
                                    submitStatus.textContent = '图片读取失败，请重试';
                                    showNotification('图片读取失败，请重试', 'error');
                                };

                                reader.readAsDataURL(file);
                            } catch (error) {
                                submitStatus.textContent = '图片处理失败';
                                showNotification('图片处理失败: ' + error.message, 'error');
                            }
                            return;
                        }
                    } else {
                        pickupType = container.querySelector('input[name="pickupType"]:checked').value;
                        const pickupMethod = container.querySelector('input[name="pickupMethod"]:checked').value;

                        if (pickupMethod === 'text') {
                            const pickupCity = container.querySelector('#pickupCityInput') ? container.querySelector('#pickupCityInput').value.trim() : '';
                            const pickupStore = container.querySelector('#pickupStoreInput') ? container.querySelector('#pickupStoreInput').value.trim() : '';

                            if (!pickupCity) {
                                showNotification('请输入自提城市', 'error');
                                const cityInput = container.querySelector('#pickupCityInput');
                                if (cityInput) cityInput.focus();
                                return;
                            }

                            if (!pickupStore) {
                                showNotification('请输入自提门店', 'error');
                                const storeInput = container.querySelector('#pickupStoreInput');
                                if (storeInput) storeInput.focus();
                                return;
                            }

                            deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n信息提供：手动填写\n自提城市：${pickupCity}\n自提门店：${pickupStore}`;
                        } else {
                            const screenshotInput = container.querySelector('#pickupStoreScreenshot');

                            if (!screenshotInput.files || !screenshotInput.files.length) {
                                showNotification('请上传门店截图', 'error');
                                return;
                            }

                            const submitStatus = document.getElementById('submitStatus');
                            submitStatus.textContent = '正在处理图片...';

                            try {
                                const file = screenshotInput.files[0];
                                const reader = new FileReader();

                                reader.onload = function(e) {
                                    screenshotData = e.target.result;
                                    hasScreenshot = true;

                                    deliveryInfo = `配送方式：到店自提\n自提方式：${pickupType}\n信息提供：截图上传`;

                                    submitStatus.textContent = '图片处理完成';

                                    setTimeout(() => {
                                        submitStatus.textContent = '';
                                        prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
                                    }, 500);
                                };

                                reader.onerror = function() {
                                    submitStatus.textContent = '图片读取失败，请重试';
                                    showNotification('图片读取失败，请重试', 'error');
                                };

                                reader.readAsDataURL(file);
                            } catch (error) {
                                submitStatus.textContent = '图片处理失败';
                                showNotification('图片处理失败: ' + error.message, 'error');
                            }
                            return;
                        }
                    }

                    prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType);
                });
            }
        }

        // 准备订单数据并显示确认模态框
        function prepareOrderData(deliveryType, orderNote, deliveryInfo, hasScreenshot, screenshotData, pickupType) {
            let totalPrice = 0;
            cart.forEach(item => {
                totalPrice += item.totalPrice;
            });

            const orderId = 'KFC' + Date.now().toString().slice(-6) + Math.floor(Math.random() * 100);
            const timestamp = new Date().toLocaleString('zh-CN');

            const orderData = {
                id: orderId,
                timestamp: timestamp,
                status: 'new',
                cart: JSON.parse(JSON.stringify(cart)),
                deliveryInfo: deliveryInfo,
                orderNote: orderNote,
                deliveryType: deliveryType,
                pickupType: pickupType || '',
                totalPrice: totalPrice,
                hasScreenshot: hasScreenshot,
                screenshotData: screenshotData,
                userId: currentUserId
            };

            showOrderConfirm(orderData);
        }

        // ==================== 完成订单提交 ====================
        async function completeOrderSubmission(orderData) {
            const checkoutBtn = document.querySelector('.checkout-btn');
            if (checkoutBtn.disabled) return;
            
            const submitStatus = document.getElementById('submitStatus');
            submitStatus.textContent = '正在提交订单...';

            checkoutBtn.disabled = true;
            checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 提交中...';
            
            try {
                const savedOrder = await SupabaseData.quickSaveOrder(orderData);
                console.log('订单快速提交成功:', savedOrder);

                savedOrder.objectId = savedOrder.objectId;
                orders.unshift(savedOrder);

                newOrdersCount++;
                
                setTimeout(async () => {
                    try {
                        await SupabaseData.updateNewOrdersCount(newOrdersCount);
                        console.log('新订单计数更新成功');
                    } catch (countError) {
                        console.warn('更新新订单计数失败，但不影响订单提交:', countError);
                    }
                }, 1000);

                localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
                    id: o.id,
                    timestamp: o.timestamp,
                    status: o.status,
                    totalPrice: o.totalPrice,
                    userId: o.userId
                }))));
                localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

                cart = [];
                updateCartDisplay();

                resetForm(document.querySelector('.meal-page-container.active'));

                updateOrderBadge();

                submitStatus.textContent = '订单提交成功！';

                setTimeout(() => {
                    submitStatus.textContent = '';
                    
                    showNotification('订单提交成功！', 'success');

                    showRealtimeIndicator('订单已提交！');

                    if (isAdminPanelOpen) {
                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                        renderOrders(activeFilter);
                    }

                    const successHTML = `
                        <div style="text-align: center; padding: 15px;">
                            <i class="fas fa-check-circle" style="font-size: 2.5rem; color: #4CAF50; margin-bottom: 10px;"></i>
                            <h3 style="color: #4CAF50; margin-bottom: 8px; font-size: 1.2rem;">订单提交成功！</h3>
                            <p style="margin-bottom: 10px; font-size: 0.9rem;">订单号：<strong>${orderData.id}</strong></p>
                            <p style="margin-bottom: 15px; font-size: 0.85rem;">我们已收到您的订单，请耐心等待处理</p>
                            <div style="display: flex; gap: 8px; justify-content: center; margin-top: 15px;">
                                <button id="viewOrderDetail" style="background-color: #e31837; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-clipboard-list"></i> 查看订单详情
                                </button>
                                <button id="backToHome" style="background-color: #f0f0f0; color: #333; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;">
                                    <i class="fas fa-home"></i> 返回首页
                                </button>
                            </div>
                        </div>
                    `;

                    const successModal = document.createElement('div');
                    successModal.className = 'order-confirm-modal active';
                    successModal.innerHTML = `
                        <div class="order-confirm-box" style="max-width: 350px; max-height: 400px;">
                            <div class="order-confirm-header" style="padding: 12px 15px;">
                                <h2 class="order-confirm-title" style="font-size: 1.1rem;">
                                    <i class="fas fa-check-circle"></i>
                                    提交成功
                                </h2>
                                <button class="order-confirm-close" onclick="this.closest('.order-confirm-modal').remove(); document.body.style.overflow='auto';">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="order-confirm-body" style="padding: 15px; max-height: 280px; overflow-y: auto;">
                                ${successHTML}
                            </div>
                        </div>
                    `;
                    
                    document.body.style.overflow = 'hidden';
                    
                    document.body.appendChild(successModal);
                    
                    successModal.querySelector('#viewOrderDetail').addEventListener('click', function() {
                        successModal.remove();
                        document.body.style.overflow = 'auto';
                        showMyOrdersPage();

                        const url = new URL(window.location);
                        url.searchParams.set('order', orderData.id);
                        window.history.pushState({}, '', url);

                        setTimeout(() => {
                            document.getElementById('orderSearchInput').value = orderData.id;
                            searchUserOrder(orderData.id);

                            const orderElements = document.querySelectorAll('.user-order-item');
                            orderElements.forEach(el => {
                                const orderIdElement = el.querySelector('.user-order-id');
                                if (orderIdElement && orderIdElement.textContent.includes(orderData.id)) {
                                    el.style.animation = 'highlightOrder 2s';
                                    el.scrollIntoView({
                                        behavior: 'smooth',
                                        block: 'center'
                                    });
                                }
                            });
                        }, 100);
                    });
                    
                    successModal.querySelector('#backToHome').addEventListener('click', function() {
                        successModal.remove();
                        document.body.style.overflow = 'auto';
                        showPage('homePage');
                    });

                }, 1000);

            } catch (error) {
                console.error('提交订单失败:', error);
                submitStatus.textContent = '';
                showNotification('订单提交失败：' + (error.message || '请检查网络连接'), 'error');
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> 快速提交订单';
                return;
            } finally {
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> 快速提交订单';
            }
        }

        const highlightStyle = document.createElement('style');
        highlightStyle.textContent = `
            @keyframes highlightOrder {
                0% { box-shadow: 0 0 0 0 rgba(227, 24, 55, 0.7); }
                70% { box-shadow: 0 0 0 10px rgba(227, 24, 55, 0); }
                100% { box-shadow: 0 0 0 0 rgba(227, 24, 55, 0); }
            }
        `;
        document.head.appendChild(highlightStyle);

        function resetForm(container) {
            container.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(input => {
                input.value = '';
            });

            const deliveryRadio = container.querySelector('input[name="deliveryType"][value="delivery"]');
            if (deliveryRadio) {
                deliveryRadio.checked = true;
                const deliveryFields = container.querySelector('.delivery-fields');
                const pickupFields = container.querySelector('.pickup-fields');
                if (deliveryFields) deliveryFields.classList.remove('hidden');
                if (pickupFields) pickupFields.classList.add('hidden');
            }

            const manualMethodRadio = container.querySelector('input[name="deliveryMethod"][value="manual"]');
            if (manualMethodRadio) {
                manualMethodRadio.checked = true;
                const manualFields = container.querySelector('.manual-fields');
                const screenshotFields = container.querySelector('.screenshot-fields');
                if (manualFields) manualFields.classList.remove('hidden');
                if (screenshotFields) screenshotFields.classList.add('hidden');
            }

            const textMethodRadio = container.querySelector('input[name="pickupMethod"][value="text"]');
            if (textMethodRadio) {
                textMethodRadio.checked = true;
                const textFields = container.querySelector('.text-method-fields');
                const screenshotFields = container.querySelector('.screenshot-method-fields');
                if (textFields) textFields.classList.remove('hidden');
                if (screenshotFields) screenshotFields.classList.add('hidden');
            }

            const screenshotInput = container.querySelector('#storeScreenshot');
            const previewContainer = container.querySelector('.screenshot-preview');
            const uploadArea = container.querySelector('.screenshot-upload-area');
            if (screenshotInput) {
                screenshotInput.value = '';
                if (previewContainer) previewContainer.classList.add('hidden');
                if (uploadArea) uploadArea.style.display = 'block';
            }

            const pickupScreenshotInput = container.querySelector('#pickupStoreScreenshot');
            const pickupPreviewContainer = container.querySelector('#pickupScreenshotPreview');
            const pickupUploadArea = container.querySelector('#pickupScreenshotUploadArea');
            if (pickupScreenshotInput) {
                pickupScreenshotInput.value = '';
                if (pickupPreviewContainer) pickupPreviewContainer.classList.add('hidden');
                if (pickupUploadArea) pickupUploadArea.style.display = 'block';
            }

            const recognizeResult = container.querySelector('#recognizeResult');
            if (recognizeResult) {
                recognizeResult.innerHTML = '';
                recognizeResult.style.display = 'none';
            }
        }

        // ==================== 我的订单页面 ====================
        function initHeaderButtons() {
            const viewOrdersBtn = document.getElementById('viewOrdersBtn');
            const viewHomeBtn = document.getElementById('viewHomeBtn');

            viewOrdersBtn.addEventListener('click', function() {
                showMyOrdersPage();
            });

            viewHomeBtn.addEventListener('click', function() {
                showPage('homePage');
                this.style.display = 'none';
                viewOrdersBtn.style.display = 'flex';
            });
        }

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order');

            if (orderId) {
                showMyOrdersPage();

                setTimeout(() => {
                    document.getElementById('orderSearchInput').value = orderId;
                    searchUserOrder(orderId);
                }, 100);
            }
        }

        function initMyOrdersPage() {
            const orderSearchBtn = document.getElementById('orderSearchBtn');
            const orderSearchInput = document.getElementById('orderSearchInput');

            orderSearchBtn.addEventListener('click', function() {
                const searchTerm = orderSearchInput.value.trim();
                if (searchTerm) {
                    searchUserOrder(searchTerm);
                } else {
                    renderUserOrders('all');
                }
            });

            orderSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    orderSearchBtn.click();
                }
            });

            document.querySelectorAll('.order-filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.order-filter-tab').forEach(t => {
                        t.classList.remove('active');
                    });

                    this.classList.add('active');

                    const filter = this.dataset.orderFilter;
                    renderUserOrders(filter);
                });
            });
        }

        function showMyOrdersPage() {
            showPage('myOrdersPage');
            renderUserOrders('all');

            document.getElementById('viewOrdersBtn').style.display = 'none';
            document.getElementById('viewHomeBtn').style.display = 'flex';
        }

        function renderUserOrders(filter = 'all') {
            const myOrdersContainer = document.getElementById('myOrdersContainer');
            const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

            myOrdersContainer.innerHTML = '';

            let userOrders = orders.filter(order => order.userId === currentUserId);

            if (filter !== 'all') {
                userOrders = userOrders.filter(order => order.status === filter);
            }

            userOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (userOrders.length === 0) {
                noUserOrdersMessage.style.display = 'block';
                return;
            }

            noUserOrdersMessage.style.display = 'none';

            userOrders.forEach(order => {
                const orderElement = createUserOrderElement(order);
                myOrdersContainer.appendChild(orderElement);
            });
        }

        // ==================== 创建用户订单元素 ====================
        function createUserOrderElement(order) {
            const orderElement = document.createElement('div');
            orderElement.className = 'user-order-item';

            let statusText, statusClass;
            switch (order.status) {
                case 'new':
                    statusText = '新订单';
                    statusClass = 'user-status-new';
                    break;
                case 'processing':
                    statusText = '处理中';
                    statusClass = 'user-status-processing';
                    break;
                case 'completed':
                    statusText = '已完成';
                    statusClass = 'user-status-completed';
                    break;
                default:
                    statusText = '新订单';
                    statusClass = 'user-status-new';
            }

            const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' : `到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

            let itemsHTML = '';
            order.cart.forEach((item, index) => {
                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                const optionText = Object.keys(optionCount).map(option => {
                    const count = optionCount[option];
                    return `${option}${count > 1 ? ` ×${count}` : ''}`;
                }).join(', ');

                itemsHTML += `<div class="user-order-item-detail">
                    <div class="user-order-item-name">
                        <div><strong>${item.name}</strong></div>
                        <div style="font-size:0.8rem; color:#666;">${optionText}</div>
                    </div>
                    <div class="user-order-item-price">¥${item.totalPrice.toFixed(2)}</div>
                </div>`;
            });

            const infoLines = order.deliveryInfo.split('\n');
            let deliveryHTML = '';
            infoLines.forEach(line => {
                if (line.trim()) {
                    deliveryHTML += `<p>${line}</p>`;
                }
            });

            let screenshotHTML = '';
            if (order.hasScreenshot && order.screenshotData) {
                screenshotHTML = `
                    <div class="screenshot-container">
                        <p><strong>门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
            }
            
            let feedbackTopHTML = '';
            if (order.feedbackScreenshotData) {
                feedbackTopHTML = `
                    <div class="user-order-feedback-container">
                        <h4><i class="fas fa-check-circle"></i> 订单反馈截图</h4>
                        <img src="${order.feedbackScreenshotData}" alt="订单反馈截图" class="user-feedback-thumbnail" data-order-id="${order.id}">
                        <p style="font-size:0.9rem; color:#2e7d32; margin-top: 8px; font-weight: bold; text-align: center;">
                            <i class="fas fa-info-circle"></i> 商家已上传反馈信息，点击图片可查看大图
                        </p>
                    </div>
                `;
            }

            orderElement.innerHTML = `
                <div class="user-order-header">
                    <div>
                        <div class="user-order-id">订单号：${order.id}</div>
                        <div class="user-order-time">${order.timestamp} | ${deliveryTypeText}</div>
                    </div>
                    <div class="user-order-status ${statusClass}">${statusText}</div>
                </div>
                
                ${feedbackTopHTML}
                
                <div class="user-order-items">
                    ${itemsHTML}
                </div>
                
                <div class="user-order-total">
                    总计：¥${order.totalPrice.toFixed(2)}
                </div>
                
                <div class="user-order-info">
                    ${deliveryHTML}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                </div>
            `;

            if (order.hasScreenshot && order.screenshotData) {
                const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
                if (screenshotImg) {
                    screenshotImg.addEventListener('click', function() {
                        showFullImage(order.screenshotData);
                    });
                }
            }
            
            if (order.feedbackScreenshotData) {
                const feedbackImg = orderElement.querySelector('.user-feedback-thumbnail');
                if (feedbackImg) {
                    feedbackImg.addEventListener('click', function() {
                        showFullImage(order.feedbackScreenshotData);
                    });
                }
            }

            return orderElement;
        }

        function searchUserOrder(searchTerm) {
            const myOrdersContainer = document.getElementById('myOrdersContainer');
            const noUserOrdersMessage = document.getElementById('noUserOrdersMessage');

            myOrdersContainer.innerHTML = '';

            const searchResults = orders.filter(order =>
                order.userId === currentUserId &&
                order.id.toLowerCase().includes(searchTerm.toLowerCase())
            );

            searchResults.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (searchResults.length === 0) {
                noUserOrdersMessage.style.display = 'block';
                noUserOrdersMessage.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>未找到相关订单</h3>
                    <p>没有找到订单号包含"${searchTerm}"的订单</p>
                `;
                return;
            }

            noUserOrdersMessage.style.display = 'none';

            searchResults.forEach(order => {
                const orderElement = createUserOrderElement(order);
                myOrdersContainer.appendChild(orderElement);
            });
        }

        // ==================== 后台管理 ====================
        function initPasswordVerification() {
            const passwordModal = document.getElementById('passwordModal');
            const adminPasswordInput = document.getElementById('adminPassword');
            const submitPasswordBtn = document.getElementById('submitPassword');
            const passwordError = document.getElementById('passwordError');

            submitPasswordBtn.addEventListener('click', function() {
                const enteredPassword = adminPasswordInput.value.trim();

                if (enteredPassword === ADMIN_PASSWORD) {
                    passwordModal.classList.remove('active');
                    adminPasswordInput.value = '';
                    passwordError.style.display = 'none';

                    openAdminPanel();
                } else {
                    passwordError.style.display = 'block';
                    adminPasswordInput.value = '';
                    adminPasswordInput.focus();

                    adminPasswordInput.style.animation = 'none';
                    setTimeout(() => {
                        adminPasswordInput.style.animation = 'shake 0.5s';
                    }, 10);
                }
            });

            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPasswordBtn.click();
                }
            });

            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% {transform: translateX(0);}
                    10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);}
                    20%, 40%, 60%, 80% {transform: translateX(5px);}
                }
            `;
            document.head.appendChild(style);
        }

        // ==================== 优化后的管理员面板实时更新 ====================
        async function openAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            const panelOverlay = document.getElementById('panelOverlay');

            adminPanel.classList.add('active');
            panelOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            isAdminPanelOpen = true;
            
            lastOrderUpdateTime = Date.now();

            updateOrderBadge();

            renderOrders('all');
            updateMealList('all');
            
            startAdminPolling();
            
            try {
                await forceSyncAllData();
            } catch (error) {
                console.error('打开管理员面板时同步数据失败:', error);
            }
        }
        
        function startAdminPolling() {
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
            }
            
            adminPollingInterval = setInterval(async () => {
                if (isAdminPanelOpen) {
                    try {
                        const newOrders = await SupabaseData.checkForNewOrders(lastOrderUpdateTime - 2000);
                        if (newOrders.length > 0) {
                            lastOrderUpdateTime = Date.now();
                            
                            newOrders.forEach(newOrder => {
                                const existingIndex = orders.findIndex(o => o.id === newOrder.id);
                                if (existingIndex === -1) {
                                    orders.unshift(newOrder);
                                } else {
                                    orders[existingIndex] = newOrder;
                                }
                            });
                            
                            showRealtimeIndicator(`有${newOrders.length}个新订单`);
                            
                            const activeFilterBtn = document.querySelector('.filter-btn.active');
                            const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                            renderOrders(activeFilter);
                            
                            updateOrderBadge();
                        }
                    } catch (error) {
                        console.warn('轮询更新失败:', error);
                    }
                } else {
                    clearInterval(adminPollingInterval);
                    adminPollingInterval = null;
                }
            }, 2000);
        }

        function initAdminPanel() {
            const adminBtn = document.getElementById('adminBtn');
            const closePanel = document.getElementById('closePanel');
            const panelOverlay = document.getElementById('panelOverlay');
            const adminPanel = document.getElementById('adminPanel');
            const clearAllOrders = document.getElementById('clearAllOrders');
            const syncDataBtn = document.getElementById('syncDataBtn');
            const adminTabs = document.querySelectorAll('.admin-tab');
            const adminMealSearchInput = document.getElementById('adminMealSearchInput');

            adminBtn.addEventListener('click', function() {
                const passwordModal = document.getElementById('passwordModal');
                const adminPasswordInput = document.getElementById('adminPassword');

                passwordModal.classList.add('active');
                adminPasswordInput.focus();
            });

            closePanel.addEventListener('click', function() {
                closeAdminPanel();
            });

            panelOverlay.addEventListener('click', function() {
                closeAdminPanel();
            });

            clearAllOrders.addEventListener('click', async function() {
                if (orders.length > 0 && confirm('确定要清空所有订单吗？此操作不可恢复！')) {
                    try {
                        showLoading('正在清空订单...');

                        await SupabaseData.clearAllOrders();

                        orders = [];
                        newOrdersCount = 0;

                        localStorage.setItem('newOrdersCountCache', '0');
                        localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

                        updateOrderBadge();
                        renderOrders('all');

                        hideLoading();
                        showNotification('已清空所有订单', 'success');
                    } catch (error) {
                        console.error('清空订单失败:', error);
                        hideLoading();
                        showNotification('清空失败，请检查网络连接', 'error');
                    }
                }
            });

            syncDataBtn.addEventListener('click', async function() {
                showLoading('正在同步数据...');
                await forceSyncAllData();
                hideLoading();
            });

            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;

                    adminTabs.forEach(t => t.classList.remove('active'));

                    this.classList.add('active');

                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });

                    document.getElementById(`${tabId}Tab`).classList.add('active');

                    if (tabId === 'meals') {
                        showMealList();
                    }
                    
                    if (tabId === 'meals' && adminMealSearchInput && adminMealSearchInput.value.trim()) {
                        adminSearchMeals(adminMealSearchInput.value.trim());
                    }
                });
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.id !== 'clearAllOrders' && btn.id !== 'syncDataBtn') {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.filter-btn').forEach(b => {
                            if (b.id !== 'clearAllOrders' && b.id !== 'syncDataBtn') {
                                b.classList.remove('active');
                            }
                        });

                        this.classList.add('active');

                        const filter = this.dataset.filter;
                        renderOrders(filter);
                    });
                }
            });
        }
        
        function closeAdminPanel() {
            const adminPanel = document.getElementById('adminPanel');
            const panelOverlay = document.getElementById('panelOverlay');
            
            adminPanel.classList.remove('active');
            panelOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
            
            isAdminPanelOpen = false;
            
            if (adminPollingInterval) {
                clearInterval(adminPollingInterval);
                adminPollingInterval = null;
            }
        }

        function renderOrders(filter = 'all') {
            const ordersContainer = document.getElementById('ordersContainer');
            const noOrdersMessage = document.getElementById('noOrdersMessage');

            const orderElements = ordersContainer.querySelectorAll('.admin-order-item');
            orderElements.forEach(el => el.remove());

            let filteredOrders = orders;
            if (filter !== 'all') {
                filteredOrders = orders.filter(order => order.status === filter);
            }

            if (filteredOrders.length === 0) {
                noOrdersMessage.style.display = 'block';
                return;
            }

            noOrdersMessage.style.display = 'none';

            filteredOrders.forEach(order => {
                const orderElement = createOrderElement(order);
                ordersContainer.appendChild(orderElement);
                initFeedbackUpload(order.id);
            });
        }

        // ==================== 创建订单元素 ====================
        function createOrderElement(order) {
            const orderElement = document.createElement('div');
            orderElement.className = 'admin-order-item';

            let statusText, statusClass;
            switch (order.status) {
                case 'new':
                    statusText = '新订单';
                    statusClass = 'status-new';
                    break;
                case 'processing':
                    statusText = '处理中';
                    statusClass = 'status-processing';
                    break;
                case 'completed':
                    statusText = '已完成';
                    statusClass = 'status-completed';
                    break;
                default:
                    statusText = '新订单';
                    statusClass = 'status-new';
            }

            const deliveryTypeText = order.deliveryType === 'delivery' ? '宅急送' : `到店自提${order.pickupType ? ` (${order.pickupType})` : ''}`;

            let itemsHTML = '';
            order.cart.forEach(item => {
                const optionCount = {};
                item.options.forEach(option => {
                    optionCount[option] = (optionCount[option] || 0) + 1;
                });

                const optionText = Object.keys(optionCount).map(option => {
                    const count = optionCount[option];
                    return `${option}${count > 1 ? ` ×${count}` : ''}`;
                }).join(', ');

                itemsHTML += `<div class="order-item-detail">
                    <div><strong>${item.name}</strong> - ¥${item.totalPrice.toFixed(2)}</div>
                    <div style="font-size:0.8rem; color:#666;">${optionText}</div>
                </div>`;
            });

            const infoLines = order.deliveryInfo.split('\n');
            let deliveryHTML = '';
            infoLines.forEach(line => {
                if (line.trim()) {
                    deliveryHTML += `<p>${line}</p>`;
                }
            });

            let screenshotHTML = '';
            if (order.hasScreenshot && order.screenshotData) {
                screenshotHTML = `
                    <div class="screenshot-container">
                        <p><strong>门店截图：</strong></p>
                        <img src="${order.screenshotData}" alt="门店截图" class="screenshot-thumbnail" data-order-id="${order.id}">
                    </div>
                `;
            }
            
            let feedbackHTML = '';
            if (order.feedbackScreenshotData) {
                feedbackHTML = `
                    <div class="feedback-screenshot-container">
                        <h4><i class="fas fa-check-circle"></i> 订单反馈截图（顾客可见）</h4>
                        <img src="${order.feedbackScreenshotData}" alt="订单反馈截图" class="feedback-thumbnail" data-order-id="${order.id}" style="max-height: 250px; object-fit: contain;">
                        <p style="font-size:0.9rem; color:#2e7d32; margin-top: 8px; font-weight: bold; text-align: center;">
                            <i class="fas fa-info-circle"></i> 已上传反馈给顾客，点击图片可查看大图
                        </p>
                    </div>
                `;
            }

            const userInfo = order.userId ? `<p><strong>用户ID：</strong>${order.userId.substring(0, 12)}...</p>` : '';

            const feedbackUploadHTML = `
                <div class="feedback-upload-area" id="feedbackUploadArea-${order.id}">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>点击上传订单反馈截图</p>
                    <p class="upload-hint">支持 JPG、PNG 格式，上传后顾客可以在"我的订单"页面查看</p>
                    <input type="file" id="feedbackScreenshot-${order.id}" accept="image/*">
                </div>
                <div class="feedback-preview" id="feedbackPreview-${order.id}">
                    <div class="screenshot-preview-container">
                        <img id="feedbackPreviewImage-${order.id}" src="" alt="反馈截图预览" style="max-height: 200px; object-fit: contain;">
                        <div class="image-info" id="feedbackImageInfo-${order.id}"></div>
                    </div>
                    <button type="button" class="remove-feedback" id="removeFeedback-${order.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button class="feedback-btn" id="uploadFeedbackBtn-${order.id}">
                    <i class="fas fa-upload"></i>
                    上传订单反馈截图
                </button>
            `;

            orderElement.innerHTML = `
                <div class="order-id">订单号：${order.id}</div>
                <div class="order-time">${order.timestamp} | ${deliveryTypeText}</div>
                <div class="order-status ${statusClass}">${statusText}</div>
                
                <div class="order-details">
                    <div class="order-items">
                        ${itemsHTML}
                    </div>
                    
                    <div class="order-total">
                        总计：¥${order.totalPrice.toFixed(2)}
                    </div>
                </div>
                
                <div class="customer-info">
                    ${deliveryHTML}
                    ${userInfo}
                    ${order.orderNote ? `<p><strong>备注：</strong>${order.orderNote}</p>` : ''}
                    ${screenshotHTML}
                    ${feedbackHTML}
                </div>
                
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">上传订单反馈截图给顾客</label>
                    ${feedbackUploadHTML}
                </div>
                
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    ${order.status === 'new' ? `<button class="filter-btn" style="padding: 5px 10px; font-size: 0.8rem;" data-action="process" data-order-id="${order.id}">标记为处理中</button>` : ''}
                    ${order.status === 'processing' ? `<button class="filter-btn" style="padding: 5px 10px; font-size: 0.8rem;" data-action="complete" data-order-id="${order.id}">标记为已完成</button>` : ''}
                    <button class="filter-btn" style="padding: 5px 10px; font-size: 0.8rem; background-color: #f44336; color: white;" data-action="delete" data-order-id="${order.id}">删除订单</button>
                </div>
            `;

            orderElement.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.dataset.action;
                    const orderId = this.dataset.orderId;
                    handleOrderAction(action, orderId);
                });
            });

            if (order.hasScreenshot && order.screenshotData) {
                const screenshotImg = orderElement.querySelector('.screenshot-thumbnail');
                if (screenshotImg) {
                    screenshotImg.addEventListener('click', function() {
                        showFullImage(order.screenshotData);
                    });
                }
            }
            
            if (order.feedbackScreenshotData) {
                const feedbackImg = orderElement.querySelector('.feedback-thumbnail');
                if (feedbackImg) {
                    feedbackImg.addEventListener('click', function() {
                        showFullImage(order.feedbackScreenshotData);
                    });
                }
            }

            return orderElement;
        }

        // ==================== 优化的反馈截图上传功能 ====================
        function initFeedbackUpload(orderId) {
            const uploadArea = document.getElementById(`feedbackUploadArea-${orderId}`);
            const fileInput = document.getElementById(`feedbackScreenshot-${orderId}`);
            const previewContainer = document.getElementById(`feedbackPreview-${orderId}`);
            const previewImage = document.getElementById(`feedbackPreviewImage-${orderId}`);
            const removeBtn = document.getElementById(`removeFeedback-${orderId}`);
            const uploadBtn = document.getElementById(`uploadFeedbackBtn-${orderId}`);

            if (!uploadArea || !fileInput) {
                console.warn(`找不到上传区域或文件输入，orderId: ${orderId}`);
                return;
            }

            if (previewContainer) previewContainer.style.display = 'none';
            if (uploadBtn) uploadBtn.style.display = 'none';

            fileInput.style.position = 'absolute';
            fileInput.style.top = '0';
            fileInput.style.left = '0';
            fileInput.style.width = '100%';
            fileInput.style.height = '100%';
            fileInput.style.opacity = '0';
            fileInput.style.cursor = 'pointer';
            
            fileInput.addEventListener('change', async function(e) {
                if (e.target.files.length) {
                    await handleFeedbackFileSelect(e.target.files[0], orderId);
                    if (uploadBtn) uploadBtn.style.display = 'flex';
                }
            });

            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    fileInput.value = '';
                    if (previewContainer) previewContainer.style.display = 'none';
                    if (uploadArea) uploadArea.style.display = 'block';
                    if (uploadBtn) uploadBtn.style.display = 'none';
                    if (previewImage) previewImage.src = '';
                    
                    const imageInfo = document.getElementById(`feedbackImageInfo-${orderId}`);
                    if (imageInfo) {
                        imageInfo.innerHTML = '';
                    }
                });
            }

            if (uploadBtn) {
                uploadBtn.addEventListener('click', async function() {
                    if (!previewImage || !previewImage.src) {
                        showNotification('请先选择反馈截图', 'error');
                        return;
                    }

                    try {
                        const orderIndex = orders.findIndex(o => o.id === orderId);
                        if (orderIndex === -1) return;

                        showLoading('正在上传反馈截图...');

                        const order = orders[orderIndex];
                        order.feedbackScreenshotData = previewImage.src;

                        const updatedOrder = await SupabaseData.saveOrder(order);
                        orders[orderIndex] = updatedOrder;

                        localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

                        hideLoading();
                        showNotification('订单反馈截图上传成功！顾客可以在"我的订单"页面查看', 'success');

                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                        renderOrders(activeFilter);

                        showRealtimeIndicator('订单反馈截图已上传');
                    } catch (error) {
                        console.error('上传反馈截图失败:', error);
                        hideLoading();
                        showNotification('上传失败，请检查网络连接', 'error');
                    }
                });
            }
        }

        // 优化的反馈截图处理函数
        async function handleFeedbackFileSelect(file, orderId) {
            if (!file.type.match('image.*')) {
                showNotification('请选择图片文件', 'error');
                return;
            }

            const previewContainer = document.getElementById(`feedbackPreview-${orderId}`);
            const previewImage = document.getElementById(`feedbackPreviewImage-${orderId}`);
            const uploadArea = document.getElementById(`feedbackUploadArea-${orderId}`);
            const imageInfo = document.getElementById(`feedbackImageInfo-${orderId}`);

            // 使用快速压缩函数
            const compressedImage = await compressImageFast(file, 600, 0.5);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (previewImage) previewImage.src = e.target.result;
                if (previewContainer) {
                    previewContainer.style.display = 'block';
                    previewContainer.classList.add('show');
                }
                if (uploadArea) uploadArea.style.display = 'none';
                
                if (imageInfo) {
                    const originalSize = (file.size / 1024).toFixed(2);
                    const compressedSize = (compressedImage.size / 1024).toFixed(2);
                    const compressionRatio = ((1 - compressedImage.size / file.size) * 100).toFixed(1);
                    imageInfo.innerHTML = `
                        原始大小: ${originalSize}KB<br>
                        压缩后: ${compressedSize}KB<br>
                        压缩率: ${compressionRatio}%
                    `;
                }
            };
            reader.readAsDataURL(compressedImage);
        }

        async function handleOrderAction(action, orderId) {
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) return;

            let confirmMessage = '';

            switch (action) {
                case 'process':
                    confirmMessage = `确认将订单 ${orderId} 标记为处理中吗？`;
                    break;
                case 'complete':
                    confirmMessage = `确认将订单 ${orderId} 标记为已完成吗？`;
                    break;
                case 'delete':
                    confirmMessage = `确认删除订单 ${orderId} 吗？`;
                    break;
            }

            if (confirm(confirmMessage)) {
                try {
                    const order = orders[orderIndex];

                    switch (action) {
                        case 'process':
                            order.status = 'processing';
                            break;
                        case 'complete':
                            order.status = 'completed';
                            break;
                        case 'delete':
                            await SupabaseData.deleteOrder(orderId);
                            orders.splice(orderIndex, 1);
                            break;
                    }

                    if (action !== 'delete') {
                        const updatedOrder = await SupabaseData.saveOrder(order);
                        orders[orderIndex] = updatedOrder;
                    }

                    localStorage.setItem('kfcOrdersCache', JSON.stringify(orders));

                    const activeFilterBtn = document.querySelector('.filter-btn.active');
                    const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';

                    renderOrders(activeFilter);

                    showNotification(`订单 ${orderId} 操作成功`, 'success');
                } catch (error) {
                    console.error('订单操作失败:', error);
                    showNotification('操作失败，请检查网络连接', 'error');
                }
            }
        }

        // ==================== 套餐管理 ====================
        function initStatusToggle() {
            const statusToggle = document.getElementById('mealActive');
            const statusText = document.getElementById('statusText');
            const supportDeliveryToggle = document.getElementById('mealSupportDelivery');
            const supportDeliveryText = document.getElementById('supportDeliveryText');

            if (statusToggle && statusText) {
                statusToggle.addEventListener('change', function() {
                    if (this.checked) {
                        statusText.textContent = '上架';
                        statusText.className = 'status-active';
                    } else {
                        statusText.textContent = '下架';
                        statusText.className = 'status-inactive';
                    }
                });
            }
            
            if (supportDeliveryToggle && supportDeliveryText) {
                supportDeliveryToggle.addEventListener('change', function() {
                    if (this.checked) {
                        supportDeliveryText.textContent = '支持';
                        supportDeliveryText.className = 'status-active';
                    } else {
                        supportDeliveryText.textContent = '不支持';
                        supportDeliveryText.className = 'status-inactive';
                    }
                });
            }
        }

        function initMealManagement() {
            updateMealList('all');

            document.querySelectorAll('.meal-filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.meal-filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });

                    this.classList.add('active');

                    const filter = this.dataset.mealFilter;
                    showMealList();
                    updateMealList(filter);
                });
            });

            document.getElementById('addOptionGroupBtn').addEventListener('click', function() {
                addOptionGroup();
            });

            document.getElementById('addFixedItemBtn').addEventListener('click', function() {
                addFixedItem();
            });

            document.getElementById('saveMealBtn').addEventListener('click', async function() {
                await saveMeal();
            });

            document.getElementById('cancelEditBtn').addEventListener('click', function() {
                showMealList();
            });

            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 's' &&
                    document.getElementById('editMealFormContainer').classList.contains('active')) {
                    e.preventDefault();
                    saveMeal();
                }

                if (e.key === 'Escape' && document.getElementById('editMealFormContainer').classList.contains('active')) {
                    showMealList();
                }
            });

            const statusToggle = document.getElementById('mealActive');
            if (statusToggle) {
                statusToggle.addEventListener('change', function() {
                    const statusText = document.getElementById('statusText');
                    if (this.checked) {
                        statusText.textContent = '上架';
                        statusText.className = 'status-active';
                    } else {
                        statusText.textContent = '下架';
                        statusText.className = 'status-inactive';
                    }
                });
            }
            
            const supportDeliveryToggle = document.getElementById('mealSupportDelivery');
            if (supportDeliveryToggle) {
                supportDeliveryToggle.addEventListener('change', function() {
                    const supportDeliveryText = document.getElementById('supportDeliveryText');
                    if (this.checked) {
                        supportDeliveryText.textContent = '支持';
                        supportDeliveryText.className = 'status-active';
                    } else {
                        supportDeliveryText.textContent = '不支持';
                        supportDeliveryText.className = 'status-inactive';
                    }
                });
            }

            if (document.querySelectorAll('.option-group-item').length === 0) {
                addOptionGroup();
            }
        }

        // 显示套餐列表
        function showMealList() {
            document.getElementById('mealListSection').style.display = 'block';
            document.getElementById('editMealFormContainer').style.display = 'none';
            
            const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
            updateMealList(activeFilter);
        }

        // 显示编辑表单
        function showEditForm() {
            document.getElementById('mealListSection').style.display = 'none';
            document.getElementById('editMealFormContainer').style.display = 'block';
        }

        // 更新套餐列表
        function updateMealList(filter = 'all') {
            const mealList = document.getElementById('mealList');
            const noMealsAdminMessage = document.getElementById('noMealsAdminMessage');
            const adminMealSearchInput = document.getElementById('adminMealSearchInput');

            if (adminMealSearchInput && adminMealSearchInput.value.trim()) {
                adminSearchMeals(adminMealSearchInput.value.trim());
                return;
            }

            mealList.innerHTML = '';

            let filteredMeals = meals;
            if (filter === 'active') {
                filteredMeals = meals.filter(meal => meal.active !== false);
            } else if (filter === 'inactive') {
                filteredMeals = meals.filter(meal => meal.active === false);
            } else if (filter === 'delivery') {
                filteredMeals = meals.filter(meal => meal.supportDelivery !== false);
            } else if (filter === 'no-delivery') {
                filteredMeals = meals.filter(meal => meal.supportDelivery === false);
            }

            filteredMeals.sort((a, b) => {
                const orderDiff = (a.order || 9999) - (b.order || 9999);
                if (orderDiff !== 0) return orderDiff;
                const aTime = a.createdAt || 0;
                const bTime = b.createdAt || 0;
                return bTime - aTime;
            });

            if (filteredMeals.length === 0) {
                noMealsAdminMessage.style.display = 'block';
                return;
            }

            noMealsAdminMessage.style.display = 'none';

            filteredMeals.forEach(meal => {
                const mealItem = document.createElement('div');
                mealItem.className = 'meal-list-item';

                let totalOptions = 0;
                if (meal.optionGroups && meal.optionGroups.length > 0) {
                    meal.optionGroups.forEach(group => {
                        if (group.items) {
                            totalOptions += group.items.length;
                        }
                    });
                }

                let totalFixed = 0;
                if (meal.fixedItems && meal.fixedItems.length > 0) {
                    meal.fixedItems.forEach(item => {
                        totalFixed += item.quantity || 1;
                    });
                }

                const createdAt = meal.createdAt ? new Date(meal.createdAt).toLocaleString('zh-CN') : '未知时间';

                const sortControls = `
                    <div class="sort-order-container">
                        <label>排序:</label>
                        <input type="number" class="sort-order-input" data-meal-id="${meal.id}" value="${meal.order || 9999}" min="0" step="1">
                        <div class="sort-order-buttons">
                            <button class="sort-order-btn" data-action="move-up" data-meal-id="${meal.id}" title="上移"><i class="fas fa-arrow-up"></i></button>
                            <button class="sort-order-btn" data-action="move-down" data-meal-id="${meal.id}" title="下移"><i class="fas fa-arrow-down"></i></button>
                            <button class="sort-order-btn" data-action="apply-order" data-meal-id="${meal.id}" title="应用排序"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                `;

                mealItem.innerHTML = `
                    <div class="meal-list-item-info">
                        <h4>${meal.name} ${meal.active === false ? '<span class="status-inactive">(已下架)</span>' : '<span class="status-active">(已上架)</span>'}</h4>
                        <p><strong>价格:</strong> ¥${meal.price} | <strong>标签:</strong> ${meal.tags.join(', ')}</p>
                        <p><strong>描述:</strong> ${meal.description}</p>
                        <p><strong>配送:</strong> ${meal.supportDelivery === false ? '<span class="no-delivery-tag">仅自提</span>' : '<span class="delivery-tag">可宅急送</span>'} | 
                           <strong>创建时间:</strong> ${createdAt} | <strong>排序值:</strong> <span class="order-display">${meal.order || 9999}</span></p>
                        <p><strong>选项组:</strong> ${meal.optionGroups ? meal.optionGroups.length : 0} 个 | 
                           <strong>选项项:</strong> ${totalOptions} 个 | 
                           <strong>固定搭配:</strong> ${totalFixed} 项</p>
                    </div>
                    <div class="meal-list-item-actions">
                        <div class="status-label">
                            <label class="status-toggle">
                                <input type="checkbox" class="status-toggle-input" data-meal-id="${meal.id}" ${meal.active !== false ? 'checked' : ''}>
                                <span class="status-slider"></span>
                            </label>
                            <span class="${meal.active !== false ? 'status-active' : 'status-inactive'}">${meal.active !== false ? '上架' : '下架'}</span>
                        </div>
                        ${sortControls}
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn edit-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="action-btn delete-btn" data-meal-id="${meal.id}">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `;

                mealList.appendChild(mealItem);
            });

            document.querySelectorAll('.status-toggle-input').forEach(toggle => {
                toggle.addEventListener('change', async function() {
                    const mealId = this.dataset.mealId;
                    const isActive = this.checked;
                    await toggleMealStatus(mealId, isActive);
                });
            });

            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mealId = this.dataset.mealId;
                    editMeal(mealId);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const mealId = this.dataset.mealId;
                    await deleteMeal(mealId);
                });
            });

            document.querySelectorAll('.sort-order-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const mealId = this.dataset.mealId;
                    const action = this.dataset.action;
                    await handleSortAction(action, mealId);
                });
            });

            document.querySelectorAll('.sort-order-input').forEach(input => {
                input.addEventListener('change', async function() {
                    const mealId = this.dataset.mealId;
                    const newOrder = parseInt(this.value) || 9999;
                    await updateMealOrder(mealId, newOrder);
                });
            });
        }

        // 处理排序操作
        async function handleSortAction(action, mealId) {
            const mealIndex = meals.findIndex(m => m.id === mealId);
            if (mealIndex === -1) return;

            const meal = meals[mealIndex];
            
            switch (action) {
                case 'move-up':
                    const newOrderUp = (meal.order || 9999) - 1;
                    await updateMealOrder(mealId, Math.max(0, newOrderUp));
                    break;
                    
                case 'move-down':
                    const newOrderDown = (meal.order || 9999) + 1;
                    await updateMealOrder(mealId, newOrderDown);
                    break;
                    
                case 'apply-order':
                    const input = document.querySelector(`.sort-order-input[data-meal-id="${mealId}"]`);
                    if (input) {
                        const newOrder = parseInt(input.value) || 9999;
                        await updateMealOrder(mealId, newOrder);
                    }
                    break;
            }
        }

        // 更新套餐排序
        async function updateMealOrder(mealId, newOrder) {
            const mealIndex = meals.findIndex(m => m.id === mealId);
            if (mealIndex === -1) return;

            const meal = meals[mealIndex];
            const oldOrder = meal.order || 9999;
            
            if (newOrder === oldOrder) return;

            try {
                meals[mealIndex].order = newOrder;
                meals[mealIndex].updatedAt = Date.now();

                const updatedMeal = await SupabaseData.saveMeal(meals[mealIndex]);
                meals[mealIndex] = updatedMeal;

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals));

                updateHomePage();

                const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                updateMealList(activeFilter);

                showNotification(`套餐"${meal.name}"排序已更新为 ${newOrder}`, 'success');
            } catch (error) {
                console.error('更新套餐排序失败:', error);
                showNotification('更新排序失败，请检查网络连接', 'error');
            }
        }

        // 切换套餐状态
        async function toggleMealStatus(mealId, isActive) {
            const mealIndex = meals.findIndex(m => m.id === mealId);
            if (mealIndex === -1) return;

            const meal = meals[mealIndex];
            const action = isActive ? '上架' : '下架';

            if (confirm(`确定要将套餐 "${meal.name}" ${action} 吗？${isActive ? '' : '下架后用户将无法看到此套餐。'}`)) {
                try {
                    meals[mealIndex].active = isActive;
                    meals[mealIndex].updatedAt = Date.now();

                    const updatedMeal = await SupabaseData.saveMeal(meals[mealIndex]);
                    meals[mealIndex] = updatedMeal;

                    localStorage.setItem('kfcMealsCache', JSON.stringify(meals));

                    updateHomePage();

                    const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                    updateMealList(activeFilter);

                    showNotification(`套餐"${meal.name}"已${action}`, 'success');
                } catch (error) {
                    console.error('更新套餐状态失败:', error);
                    showNotification('操作失败，请检查网络连接', 'error');

                    const toggle = document.querySelector(`.status-toggle-input[data-meal-id="${mealId}"]`);
                    if (toggle) {
                        toggle.checked = !isActive;
                    }
                }
            } else {
                const toggle = document.querySelector(`.status-toggle-input[data-meal-id="${mealId}"]`);
                if (toggle) {
                    toggle.checked = !isActive;
                }
            }
        }

        // 编辑套餐
        function editMeal(mealId) {
            const meal = meals.find(m => m.id === mealId);
            if (!meal) {
                showNotification('套餐不存在或已被删除', 'error');
                return;
            }

            document.getElementById('currentMealId').value = meal.id;
            document.getElementById('mealName').value = meal.name;
            document.getElementById('mealPrice').value = meal.price;
            document.getElementById('mealOrder').value = meal.order || 9999;
            document.getElementById('mealTags').value = meal.tags.join(', ');
            document.getElementById('mealDescription').value = meal.description;
            document.getElementById('mealActive').checked = meal.active !== false;
            document.getElementById('mealSupportDelivery').checked = meal.supportDelivery !== false;

            const statusText = document.getElementById('statusText');
            if (meal.active !== false) {
                statusText.textContent = '上架';
                statusText.className = 'status-active';
            } else {
                statusText.textContent = '下架';
                statusText.className = 'status-inactive';
            }
            
            const supportDeliveryText = document.getElementById('supportDeliveryText');
            if (meal.supportDelivery !== false) {
                supportDeliveryText.textContent = '支持';
                supportDeliveryText.className = 'status-active';
            } else {
                supportDeliveryText.textContent = '不支持';
                supportDeliveryText.className = 'status-inactive';
            }

            document.getElementById('editMealTitle').innerHTML = `<i class="fas fa-edit"></i> 编辑套餐：${meal.name.substring(0, 20)}${meal.name.length > 20 ? '...' : ''}`;

            document.getElementById('optionGroupsManagement').innerHTML = '';
            document.getElementById('fixedItemsManagement').innerHTML = '';

            if (meal.optionGroups && meal.optionGroups.length > 0) {
                meal.optionGroups.forEach((group, index) => {
                    const groupId = 'group-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

                    const optionGroup = document.createElement('div');
                    optionGroup.className = 'option-group-item';
                    optionGroup.innerHTML = `
                        <div class="option-group-header">
                            <div class="option-group-title">选项组 ${index + 1}</div>
                            <div>
                                <button class="action-btn add-btn add-option-item-btn" data-group-id="${groupId}">
                                    <i class="fas fa-plus"></i> 添加选项
                                </button>
                                <button class="action-btn delete-btn delete-option-group-btn" data-group-id="${groupId}">
                                    <i class="fas fa-trash"></i> 删除组
                                </button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">组标题 <span class="required">*</span></label>
                                <input type="text" class="form-input option-group-title-input" data-group-id="${groupId}" placeholder="例如：① 任选3份（可以重复选）" value="${group.title || '选项组' + (index + 1)}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">规则描述 <span class="required">*</span></label>
                                <input type="text" class="form-input option-group-rules-input" data-group-id="${groupId}" placeholder="例如：需要选择3份，可以重复选择相同选项" value="${group.rules || '请选择选项'}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">最少选择数量 <span class="required">*</span></label>
                                <input type="number" class="form-input option-group-min-input" data-group-id="${groupId}" placeholder="例如：3" min="0" value="${group.minSelect || 1}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最多选择数量 <span class="required">*</span></label>
                                <input type="number" class="form-input option-group-max-input" data-group-id="${groupId}" placeholder="例如：3" min="1" value="${group.maxSelect || 1}">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">是否可以重复选择</label>
                                <div style="margin-top: 6px;">
                                    <label style="display: flex; align-items: center; gap: 6px;">
                                        <input type="checkbox" class="option-group-repeat-input" data-group-id="${groupId}" ${group.repeat ? 'checked' : ''}>
                                        <span>可以重复选择相同选项</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">每个选项最多选择几份</label>
                                <input type="number" class="form-input option-group-max-per-item-input" data-group-id="${groupId}" placeholder="例如：2" min="1" value="${group.maxPerItem || (group.repeat ? 999 : 1)}">
                            </div>
                        </div>
                        <div class="option-items-list" id="option-items-${groupId}">
                        </div>
                    `;

                    document.getElementById('optionGroupsManagement').appendChild(optionGroup);

                    optionGroup.querySelector('.add-option-item-btn').addEventListener('click', function() {
                        addOptionItem(groupId);
                    });

                    optionGroup.querySelector('.delete-option-group-btn').addEventListener('click', function() {
                        deleteOptionGroup(groupId);
                    });

                    if (group.items && group.items.length > 0) {
                        group.items.forEach((item, itemIndex) => {
                            addOptionItemToGroup(groupId, item.name, item.addPrice || 0, itemIndex);
                        });
                    } else {
                        addOptionItemToGroup(groupId, '选项1', 0, 0);
                    }
                });
            } else {
                addOptionGroup();
            }

            if (meal.fixedItems && meal.fixedItems.length > 0) {
                meal.fixedItems.forEach((item, index) => {
                    addFixedItemWithData(item.name, item.quantity || 1);
                });
            }

            showEditForm();

            document.getElementById('editMealFormContainer').scrollIntoView({
                behavior: 'smooth'
            });
        }

        // ==================== 修改后的添加选项组函数（支持插入） ====================
        function addOptionGroup() {
            const optionGroupsManagement = document.getElementById('optionGroupsManagement');
            const groupId = 'group-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-group-item';
            optionGroup.innerHTML = `
                <div class="option-group-header">
                    <div class="option-group-title">选项组 ${optionGroupsManagement.children.length + 1}</div>
                    <div>
                        <button class="action-btn add-btn add-option-item-btn" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 添加选项
                        </button>
                        <button class="action-btn delete-btn delete-option-group-btn" data-group-id="${groupId}">
                            <i class="fas fa-trash"></i> 删除组
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">组标题 <span class="required">*</span></label>
                        <input type="text" class="form-input option-group-title-input" data-group-id="${groupId}" placeholder="例如：① 任选3份（可以重复选）" value="选项组 ${optionGroupsManagement.children.length + 1}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">规则描述 <span class="required">*</span></label>
                        <input type="text" class="form-input option-group-rules-input" data-group-id="${groupId}" placeholder="例如：需要选择3份，可以重复选择相同选项" value="请选择选项">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">最少选择数量 <span class="required">*</span></label>
                        <input type="number" class="form-input option-group-min-input" data-group-id="${groupId}" placeholder="例如：3" min="0" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">最多选择数量 <span class="required">*</span></label>
                        <input type="number" class="form-input option-group-max-input" data-group-id="${groupId}" placeholder="例如：3" min="1" value="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">是否可以重复选择</label>
                        <div style="margin-top: 6px;">
                            <label style="display: flex; align-items: center; gap: 6px;">
                                <input type="checkbox" class="option-group-repeat-input" data-group-id="${groupId}" checked>
                                <span>可以重复选择相同选项</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">每个选项最多选择几份</label>
                        <input type="number" class="form-input option-group-max-per-item-input" data-group-id="${groupId}" placeholder="例如：2" min="1" value="999">
                    </div>
                </div>
                <div class="option-items-list" id="option-items-${groupId}">
                </div>
            `;

            optionGroupsManagement.appendChild(optionGroup);

            optionGroup.querySelector('.add-option-item-btn').addEventListener('click', function() {
                addOptionItem(groupId);
            });

            optionGroup.querySelector('.delete-option-group-btn').addEventListener('click', function() {
                deleteOptionGroup(groupId);
            });

            addOptionItemToGroup(groupId, '选项1', 0, 0);
        }

        // ==================== 修改后的添加选项项函数（支持插入） ====================
        function addOptionItem(groupId, position = 'bottom') {
            addOptionItemToGroup(groupId, '新选项', 0, null, position);
        }

        // 辅助函数：添加选项项到指定组（支持指定位置）
        function addOptionItemToGroup(groupId, name, price, position = null, insertPosition = 'bottom') {
            const optionItemsList = document.getElementById(`option-items-${groupId}`);
            if (!optionItemsList) return;

            const itemId = Date.now() + Math.random();

            const optionItem = document.createElement('div');
            optionItem.className = 'option-item-list-item';
            optionItem.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <input type="text" class="form-input option-item-name-input" style="flex: 3;" placeholder="选项名称，例如：香辣鸡腿堡" value="${name || '选项'}">
                    <input type="number" class="form-input option-item-price-input" style="flex: 1;" placeholder="附加价格" min="0" step="0.01" value="${price || 0}">
                </div>
                <div style="display: flex; gap: 4px;">
                    <div class="insert-buttons">
                        <button class="insert-btn up" title="在上方插入">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="insert-btn down" title="在下方插入">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <button class="action-btn delete-btn delete-option-item-btn" data-item-id="${itemId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            // 根据插入位置添加
            if (position !== null && position >= 0 && position < optionItemsList.children.length) {
                if (insertPosition === 'top') {
                    optionItemsList.insertBefore(optionItem, optionItemsList.children[position]);
                } else {
                    if (position + 1 < optionItemsList.children.length) {
                        optionItemsList.insertBefore(optionItem, optionItemsList.children[position + 1]);
                    } else {
                        optionItemsList.appendChild(optionItem);
                    }
                }
            } else {
                optionItemsList.appendChild(optionItem);
            }

            // 添加上方插入按钮事件
            const insertUpBtn = optionItem.querySelector('.insert-btn.up');
            if (insertUpBtn) {
                insertUpBtn.addEventListener('click', function() {
                    const itemIndex = Array.from(optionItemsList.children).indexOf(optionItem);
                    addOptionItemToGroup(groupId, '新选项', 0, itemIndex, 'top');
                });
            }

            // 添加下方插入按钮事件
            const insertDownBtn = optionItem.querySelector('.insert-btn.down');
            if (insertDownBtn) {
                insertDownBtn.addEventListener('click', function() {
                    const itemIndex = Array.from(optionItemsList.children).indexOf(optionItem);
                    addOptionItemToGroup(groupId, '新选项', 0, itemIndex, 'bottom');
                });
            }

            optionItem.querySelector('.delete-option-item-btn').addEventListener('click', function() {
                deleteOptionItem(itemId);
            });
        }

        // 删除选项组
        function deleteOptionGroup(groupId) {
            const groupElement = document.querySelector(`.option-group-item [data-group-id="${groupId}"]`).closest('.option-group-item');
            if (groupElement) {
                groupElement.remove();
            }
        }

        // 删除选项项
        function deleteOptionItem(itemId) {
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`).closest('.option-item-list-item');
            if (itemElement) {
                itemElement.remove();
            }
        }

        // 添加固定搭配项
        function addFixedItem() {
            addFixedItemWithData('固定搭配项', 1);
        }

        // 辅助函数：添加带数据的固定搭配项
        function addFixedItemWithData(name, quantity) {
            const fixedItemsManagement = document.getElementById('fixedItemsManagement');
            if (!fixedItemsManagement) return;

            const fixedItem = document.createElement('div');
            fixedItem.className = 'fixed-item-list-item';
            fixedItem.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <input type="text" class="form-input fixed-item-name-input" style="flex: 3;" placeholder="固定搭配项名称，例如：可乐" value="${name || '固定搭配项'}">
                    <input type="number" class="form-input fixed-item-quantity-input" style="flex: 1;" placeholder="数量" min="1" value="${quantity || 1}">
                </div>
                <button class="action-btn delete-btn delete-fixed-item-btn">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            fixedItemsManagement.appendChild(fixedItem);

            fixedItem.querySelector('.delete-fixed-item-btn').addEventListener('click', function() {
                fixedItem.remove();
            });
        }

        // 删除套餐
        async function deleteMeal(mealId) {
            const mealIndex = meals.findIndex(m => m.id === mealId);
            if (mealIndex === -1) return;

            const meal = meals[mealIndex];

            if (!confirm(`确定要删除套餐 "${meal.name}" 吗？\n\n价格：¥${meal.price}\n标签：${meal.tags.join(', ')}\n\n此操作不可恢复！`)) {
                return;
            }

            let hasOrders = false;
            orders.forEach(order => {
                order.cart.forEach(item => {
                    if (item.id === mealId) {
                        hasOrders = true;
                    }
                });
            });

            if (hasOrders) {
                if (!confirm('警告：有订单包含此套餐。删除套餐不会删除相关订单，但会影响订单详情显示。\n\n确定要继续删除吗？')) {
                    return;
                }
            }

            try {
                await SupabaseData.deleteMeal(mealId);

                meals.splice(mealIndex, 1);

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals));

                updateHomePage();

                const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                updateMealList(activeFilter);

                showNotification(`套餐"${meal.name}"已删除`, 'success');
            } catch (error) {
                console.error('删除套餐失败:', error);
                showNotification('删除失败，请检查网络连接', 'error');
            }
        }

        // ==================== 保存套餐函数 ====================
        async function saveMeal() {
            const mealId = document.getElementById('currentMealId').value;
            const mealName = document.getElementById('mealName').value.trim();
            const mealPrice = parseFloat(document.getElementById('mealPrice').value);
            const mealOrder = parseInt(document.getElementById('mealOrder').value) || 9999;
            const mealTags = document.getElementById('mealTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const mealDescription = document.getElementById('mealDescription').value.trim();
            const mealActive = document.getElementById('mealActive').checked;
            const mealSupportDelivery = document.getElementById('mealSupportDelivery').checked;

            if (!mealName) {
                showNotification('请填写套餐名称', 'error');
                document.getElementById('mealName').focus();
                return;
            }

            if (isNaN(mealPrice) || mealPrice <= 0) {
                showNotification('请填写有效的套餐价格', 'error');
                document.getElementById('mealPrice').focus();
                return;
            }

            if (mealTags.length === 0) {
                showNotification('请至少填写一个套餐标签', 'error');
                document.getElementById('mealTags').focus();
                return;
            }

            if (!mealDescription) {
                showNotification('请填写套餐描述', 'error');
                document.getElementById('mealDescription').focus();
                return;
            }

            const optionGroups = [];
            document.querySelectorAll('#optionGroupsManagement .option-group-item').forEach((groupElement, index) => {
                const title = groupElement.querySelector('.option-group-title-input').value.trim();
                const rules = groupElement.querySelector('.option-group-rules-input').value.trim();
                const minSelect = parseInt(groupElement.querySelector('.option-group-min-input').value) || 1;
                const maxSelect = parseInt(groupElement.querySelector('.option-group-max-input').value) || 1;
                const repeat = groupElement.querySelector('.option-group-repeat-input').checked;
                const maxPerItem = parseInt(groupElement.querySelector('.option-group-max-per-item-input').value) || (repeat ? 999 : 1);

                if (!title) {
                    showNotification(`选项组 ${index + 1} 的标题不能为空`, 'error');
                    groupElement.querySelector('.option-group-title-input').focus();
                    throw new Error('选项组标题为空');
                }

                if (!rules) {
                    showNotification(`选项组 ${index + 1} 的规则描述不能为空`, 'error');
                    groupElement.querySelector('.option-group-rules-input').focus();
                    throw new Error('选项组规则为空');
                }

                if (minSelect < 0) {
                    showNotification(`选项组 ${index + 1} 的最少选择数量不能小于0`, 'error');
                    groupElement.querySelector('.option-group-min-input').focus();
                    throw new Error('最小选择数量无效');
                }

                if (maxSelect < minSelect) {
                    showNotification(`选项组 ${index + 1} 的最多选择数量不能小于最少选择数量`, 'error');
                    groupElement.querySelector('.option-group-max-input').focus();
                    throw new Error('最大选择数量无效');
                }

                const items = [];
                groupElement.querySelectorAll('.option-item-list-item').forEach(itemElement => {
                    const nameInput = itemElement.querySelector('.option-item-name-input');
                    const priceInput = itemElement.querySelector('.option-item-price-input');
                    
                    if (nameInput) {
                        const name = nameInput.value.trim();
                        const addPrice = priceInput ? parseFloat(priceInput.value) || 0 : 0;

                        if (name) {
                            items.push({
                                name,
                                addPrice
                            });
                        }
                    }
                });

                if (items.length === 0) {
                    showNotification(`选项组 ${index + 1} 至少需要一个选项项`, 'error');
                    throw new Error('选项组没有选项项');
                }

                optionGroups.push({
                    title,
                    rules,
                    minSelect,
                    maxSelect,
                    repeat,
                    maxPerItem,
                    items
                });
            });

            const fixedItems = [];
            document.querySelectorAll('#fixedItemsManagement .fixed-item-list-item').forEach((itemElement, index) => {
                const nameInput = itemElement.querySelector('.fixed-item-name-input');
                const quantityInput = itemElement.querySelector('.fixed-item-quantity-input');
                
                if (nameInput && quantityInput) {
                    const name = nameInput.value.trim();
                    const quantity = parseInt(quantityInput.value) || 1;

                    if (name) {
                        fixedItems.push({
                            name,
                            quantity
                        });
                    }
                }
            });

            let meal;
            const now = Date.now();

            try {
                if (mealId) {
                    meal = meals.find(m => m.id === mealId);
                    if (meal) {
                        meal.name = mealName;
                        meal.price = mealPrice;
                        meal.order = mealOrder;
                        meal.tags = mealTags;
                        meal.description = mealDescription;
                        meal.active = mealActive;
                        meal.supportDelivery = mealSupportDelivery;
                        meal.optionGroups = optionGroups;
                        meal.fixedItems = fixedItems;

                        const savedMeal = await SupabaseData.saveMeal(meal);

                        const mealIndex = meals.findIndex(m => m.id === mealId);
                        if (mealIndex !== -1) {
                            meals[mealIndex] = savedMeal;
                        }
                    }
                } else {
                    meal = {
                        id: 'meal-' + now + '-' + Math.random().toString(36).substr(2, 9),
                        name: mealName,
                        price: mealPrice,
                        order: mealOrder,
                        tags: mealTags,
                        description: mealDescription,
                        active: mealActive,
                        supportDelivery: mealSupportDelivery,
                        optionGroups: optionGroups,
                        fixedItems: fixedItems
                    };

                    const savedMeal = await SupabaseData.saveMeal(meal);
                    meals.push(savedMeal);
                }

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals));

                updateHomePage();

                const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                updateMealList(activeFilter);

                showMealList();

                showNotification(mealId ? '套餐已更新' : '套餐已添加', 'success');
            } catch (error) {
                console.error('保存套餐失败:', error);
                showNotification('保存失败，请检查网络连接', 'error');
            }
        }

        // ==================== 添加新套餐管理 ====================
        function initNewMealManagement() {
            const statusToggle = document.getElementById('newMealActive');
            const statusText = document.getElementById('newStatusText');
            const supportDeliveryToggle = document.getElementById('newMealSupportDelivery');
            const supportDeliveryText = document.getElementById('newSupportDeliveryText');

            if (statusToggle && statusText) {
                statusToggle.addEventListener('change', function() {
                    if (this.checked) {
                        statusText.textContent = '上架';
                        statusText.className = 'status-active';
                    } else {
                        statusText.textContent = '下架';
                        statusText.className = 'status-inactive';
                    }
                });
            }
            
            if (supportDeliveryToggle && supportDeliveryText) {
                supportDeliveryToggle.addEventListener('change', function() {
                    if (this.checked) {
                        supportDeliveryText.textContent = '支持';
                        supportDeliveryText.className = 'status-active';
                    } else {
                        supportDeliveryText.textContent = '不支持';
                        supportDeliveryText.className = 'status-inactive';
                    }
                });
            }

            document.getElementById('newAddOptionGroupBtn').addEventListener('click', function() {
                addNewOptionGroup();
            });

            document.getElementById('newAddFixedItemBtn').addEventListener('click', function() {
                addNewFixedItem();
            });

            document.getElementById('saveNewMealBtn').addEventListener('click', async function() {
                await saveNewMeal();
            });

            if (document.querySelectorAll('#newOptionGroupsManagement .option-group-item').length === 0) {
                addNewOptionGroup();
            }
        }

        // 添加新选项组
        function addNewOptionGroup() {
            const optionGroupsManagement = document.getElementById('newOptionGroupsManagement');
            const groupId = 'new-group-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            const optionGroup = document.createElement('div');
            optionGroup.className = 'option-group-item';
            optionGroup.innerHTML = `
                <div class="option-group-header">
                    <div class="option-group-title">选项组 ${optionGroupsManagement.children.length + 1}</div>
                    <div>
                        <button class="action-btn add-btn new-add-option-item-btn" data-group-id="${groupId}">
                            <i class="fas fa-plus"></i> 添加选项
                        </button>
                        <button class="action-btn delete-btn new-delete-option-group-btn" data-group-id="${groupId}">
                            <i class="fas fa-trash"></i> 删除组
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">组标题 <span class="required">*</span></label>
                        <input type="text" class="form-input new-option-group-title-input" data-group-id="${groupId}" placeholder="例如：① 任选3份（可以重复选）" value="选项组 ${optionGroupsManagement.children.length + 1}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">规则描述 <span class="required">*</span></label>
                        <input type="text" class="form-input new-option-group-rules-input" data-group-id="${groupId}" placeholder="例如：需要选择3份，可以重复选择相同选项" value="请选择选项">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">最少选择数量 <span class="required">*</span></label>
                        <input type="number" class="form-input new-option-group-min-input" data-group-id="${groupId}" placeholder="例如：3" min="0" value="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">最多选择数量 <span class="required">*</span></label>
                        <input type="number" class="form-input new-option-group-max-input" data-group-id="${groupId}" placeholder="例如：3" min="1" value="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">是否可以重复选择</label>
                        <div style="margin-top: 6px;">
                            <label style="display: flex; align-items: center; gap: 6px;">
                                <input type="checkbox" class="new-option-group-repeat-input" data-group-id="${groupId}" checked>
                                <span>可以重复选择相同选项</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">每个选项最多选择几份</label>
                        <input type="number" class="form-input new-option-group-max-per-item-input" data-group-id="${groupId}" placeholder="例如：2" min="1" value="999">
                    </div>
                </div>
                <div class="option-items-list" id="new-option-items-${groupId}">
                </div>
            `;

            optionGroupsManagement.appendChild(optionGroup);

            optionGroup.querySelector('.new-add-option-item-btn').addEventListener('click', function() {
                addNewOptionItem(groupId);
            });

            optionGroup.querySelector('.new-delete-option-group-btn').addEventListener('click', function() {
                deleteNewOptionGroup(groupId);
            });

            addNewOptionItemToGroup(groupId, '选项1', 0, 0);
        }

        // 添加新选项项
        function addNewOptionItem(groupId) {
            addNewOptionItemToGroup(groupId, '新选项', 0);
        }

        // 辅助函数：添加新选项项到指定组（支持插入）
        function addNewOptionItemToGroup(groupId, name, price, position = null) {
            const optionItemsList = document.getElementById(`new-option-items-${groupId}`);
            if (!optionItemsList) return;

            const itemId = Date.now() + Math.random();

            const optionItem = document.createElement('div');
            optionItem.className = 'option-item-list-item';
            optionItem.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <input type="text" class="form-input new-option-item-name-input" style="flex: 3;" placeholder="选项名称，例如：香辣鸡腿堡" value="${name || '选项'}">
                    <input type="number" class="form-input new-option-item-price-input" style="flex: 1;" placeholder="附加价格" min="0" step="0.01" value="${price || 0}">
                </div>
                <div style="display: flex; gap: 4px;">
                    <div class="insert-buttons">
                        <button class="insert-btn up" title="在上方插入">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="insert-btn down" title="在下方插入">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                    </div>
                    <button class="action-btn delete-btn new-delete-option-item-btn" data-item-id="${itemId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            if (position !== null && position >= 0 && position < optionItemsList.children.length) {
                optionItemsList.insertBefore(optionItem, optionItemsList.children[position]);
            } else {
                optionItemsList.appendChild(optionItem);
            }

            // 添加上方插入按钮事件
            const insertUpBtn = optionItem.querySelector('.insert-btn.up');
            if (insertUpBtn) {
                insertUpBtn.addEventListener('click', function() {
                    const itemIndex = Array.from(optionItemsList.children).indexOf(optionItem);
                    addNewOptionItemToGroup(groupId, '新选项', 0, itemIndex);
                });
            }

            // 添加下方插入按钮事件
            const insertDownBtn = optionItem.querySelector('.insert-btn.down');
            if (insertDownBtn) {
                insertDownBtn.addEventListener('click', function() {
                    const itemIndex = Array.from(optionItemsList.children).indexOf(optionItem);
                    addNewOptionItemToGroup(groupId, '新选项', 0, itemIndex + 1);
                });
            }

            optionItem.querySelector('.new-delete-option-item-btn').addEventListener('click', function() {
                deleteNewOptionItem(itemId);
            });
        }

        // 删除新选项组
        function deleteNewOptionGroup(groupId) {
            const groupElement = document.querySelector(`.option-group-item [data-group-id="${groupId}"]`).closest('.option-group-item');
            if (groupElement) {
                groupElement.remove();
            }
        }

        // 删除新选项项
        function deleteNewOptionItem(itemId) {
            const itemElement = document.querySelector(`[data-item-id="${itemId}"]`).closest('.option-item-list-item');
            if (itemElement) {
                itemElement.remove();
            }
        }

        // 添加新固定搭配项
        function addNewFixedItem() {
            addNewFixedItemWithData('固定搭配项', 1);
        }

        // 辅助函数：添加带数据的新固定搭配项
        function addNewFixedItemWithData(name, quantity) {
            const fixedItemsManagement = document.getElementById('newFixedItemsManagement');
            if (!fixedItemsManagement) return;

            const fixedItem = document.createElement('div');
            fixedItem.className = 'fixed-item-list-item';
            fixedItem.innerHTML = `
                <div style="display: flex; gap: 8px; width: 100%;">
                    <input type="text" class="form-input new-fixed-item-name-input" style="flex: 3;" placeholder="固定搭配项名称，例如：可乐" value="${name || '固定搭配项'}">
                    <input type="number" class="form-input new-fixed-item-quantity-input" style="flex: 1;" placeholder="数量" min="1" value="${quantity || 1}">
                </div>
                <button class="action-btn delete-btn new-delete-fixed-item-btn">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            fixedItemsManagement.appendChild(fixedItem);

            fixedItem.querySelector('.new-delete-fixed-item-btn').addEventListener('click', function() {
                fixedItem.remove();
            });
        }

        // ==================== 保存新套餐函数 ====================
        async function saveNewMeal() {
            const mealName = document.getElementById('newMealName').value.trim();
            const mealPrice = parseFloat(document.getElementById('newMealPrice').value);
            const mealOrder = parseInt(document.getElementById('newMealOrder').value) || 9999;
            const mealTags = document.getElementById('newMealTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const mealDescription = document.getElementById('newMealDescription').value.trim();
            const mealActive = document.getElementById('newMealActive').checked;
            const mealSupportDelivery = document.getElementById('newMealSupportDelivery').checked;

            if (!mealName) {
                showNotification('请填写套餐名称', 'error');
                document.getElementById('newMealName').focus();
                return;
            }

            if (isNaN(mealPrice) || mealPrice <= 0) {
                showNotification('请填写有效的套餐价格', 'error');
                document.getElementById('newMealPrice').focus();
                return;
            }

            if (mealTags.length === 0) {
                showNotification('请至少填写一个套餐标签', 'error');
                document.getElementById('newMealTags').focus();
                return;
            }

            if (!mealDescription) {
                showNotification('请填写套餐描述', 'error');
                document.getElementById('newMealDescription').focus();
                return;
            }

            const optionGroups = [];
            document.querySelectorAll('#newOptionGroupsManagement .option-group-item').forEach((groupElement, index) => {
                const title = groupElement.querySelector('.new-option-group-title-input').value.trim();
                const rules = groupElement.querySelector('.new-option-group-rules-input').value.trim();
                const minSelect = parseInt(groupElement.querySelector('.new-option-group-min-input').value) || 1;
                const maxSelect = parseInt(groupElement.querySelector('.new-option-group-max-input').value) || 1;
                const repeat = groupElement.querySelector('.new-option-group-repeat-input').checked;
                const maxPerItem = parseInt(groupElement.querySelector('.new-option-group-max-per-item-input').value) || (repeat ? 999 : 1);

                if (!title) {
                    showNotification(`选项组 ${index + 1} 的标题不能为空`, 'error');
                    groupElement.querySelector('.new-option-group-title-input').focus();
                    throw new Error('选项组标题为空');
                }

                if (!rules) {
                    showNotification(`选项组 ${index + 1} 的规则描述不能为空`, 'error');
                    groupElement.querySelector('.new-option-group-rules-input').focus();
                    throw new Error('选项组规则为空');
                }

                if (minSelect < 0) {
                    showNotification(`选项组 ${index + 1} 的最少选择数量不能小于0`, 'error');
                    groupElement.querySelector('.new-option-group-min-input').focus();
                    throw new Error('最小选择数量无效');
                }

                if (maxSelect < minSelect) {
                    showNotification(`选项组 ${index + 1} 的最多选择数量不能小于最少选择数量`, 'error');
                    groupElement.querySelector('.new-option-group-max-input').focus();
                    throw new Error('最大选择数量无效');
                }

                const items = [];
                groupElement.querySelectorAll('.option-item-list-item').forEach(itemElement => {
                    const nameInput = itemElement.querySelector('.new-option-item-name-input');
                    const priceInput = itemElement.querySelector('.new-option-item-price-input');
                    
                    if (nameInput) {
                        const name = nameInput.value.trim();
                        const addPrice = priceInput ? parseFloat(priceInput.value) || 0 : 0;

                        if (name) {
                            items.push({
                                name,
                                addPrice
                            });
                        }
                    }
                });

                if (items.length === 0) {
                    showNotification(`选项组 ${index + 1} 至少需要一个选项项`, 'error');
                    throw new Error('选项组没有选项项');
                }

                optionGroups.push({
                    title,
                    rules,
                    minSelect,
                    maxSelect,
                    repeat,
                    maxPerItem,
                    items
                });
            });

            const fixedItems = [];
            document.querySelectorAll('#newFixedItemsManagement .fixed-item-list-item').forEach((itemElement, index) => {
                const nameInput = itemElement.querySelector('.new-fixed-item-name-input');
                const quantityInput = itemElement.querySelector('.new-fixed-item-quantity-input');
                
                if (nameInput && quantityInput) {
                    const name = nameInput.value.trim();
                    const quantity = parseInt(quantityInput.value) || 1;

                    if (name) {
                        fixedItems.push({
                            name,
                            quantity
                        });
                    }
                }
            });

            const now = Date.now();
            const meal = {
                id: 'meal-' + now + '-' + Math.random().toString(36).substr(2, 9),
                name: mealName,
                price: mealPrice,
                order: mealOrder,
                tags: mealTags,
                description: mealDescription,
                active: mealActive,
                supportDelivery: mealSupportDelivery,
                optionGroups: optionGroups,
                fixedItems: fixedItems
            };

            try {
                const savedMeal = await SupabaseData.saveMeal(meal);
                meals.push(savedMeal);

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals));

                updateHomePage();

                const activeFilter = document.querySelector('.meal-filter-btn.active').dataset.mealFilter;
                updateMealList(activeFilter);

                document.getElementById('newMealName').value = '';
                document.getElementById('newMealPrice').value = '';
                document.getElementById('newMealOrder').value = '9999';
                document.getElementById('newMealTags').value = '';
                document.getElementById('newMealDescription').value = '';
                document.getElementById('newMealActive').checked = true;
                document.getElementById('newMealSupportDelivery').checked = true;
                
                const statusText = document.getElementById('newStatusText');
                statusText.textContent = '上架';
                statusText.className = 'status-active';
                
                const supportDeliveryText = document.getElementById('newSupportDeliveryText');
                supportDeliveryText.textContent = '支持';
                supportDeliveryText.className = 'status-active';

                document.getElementById('newOptionGroupsManagement').innerHTML = '';
                document.getElementById('newFixedItemsManagement').innerHTML = '';

                document.querySelector('.admin-tab[data-tab="meals"]').click();

                showNotification('套餐已添加', 'success');
            } catch (error) {
                console.error('添加套餐失败:', error);
                showNotification('添加失败，请检查网络连接', 'error');
            }
        }

        // ==================== 图片预览功能 ====================
        function initImagePreview() {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeModal = document.getElementById('closeModal');

            closeModal.addEventListener('click', function() {
                imageModal.classList.remove('active');
            });

            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.classList.remove('active');
                }
            });
        }

        function showFullImage(imageSrc) {
            const modalImage = document.getElementById('modalImage');
            const imageModal = document.getElementById('imageModal');

            modalImage.src = imageSrc;
            imageModal.classList.add('active');
        }

        // ==================== 新订单徽章 ====================
        function updateOrderBadge() {
            const badge = document.getElementById('newOrderBadge');
            if (newOrdersCount > 0) {
                badge.textContent = newOrdersCount > 9 ? '9+' : newOrdersCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ==================== 数据同步功能 ====================
        async function syncDataFromSupabase() {
            try {
                const [newMeals, newOrders, newCount] = await Promise.all([
                    SupabaseData.loadMeals(),
                    SupabaseData.loadOrders(),
                    SupabaseData.loadNewOrdersCount()
                ]);


                meals = newMeals;
                orders = newOrders;
                newOrdersCount = newCount;

                localStorage.setItem('kfcMealsCache', JSON.stringify(meals.map(m => ({
                    id: m.id,
                    name: m.name,
                    price: m.price,
                    tags: m.tags,
                    description: m.description,
                    order: m.order,
                    active: m.active,
                    supportDelivery: m.supportDelivery
                }))));
                
                localStorage.setItem('kfcOrdersCache', JSON.stringify(orders.map(o => ({
                    id: o.id,
                    timestamp: o.timestamp,
                    status: o.status,
                    totalPrice: o.totalPrice,
                    userId: o.userId
                }))));
                
                localStorage.setItem('newOrdersCountCache', newOrdersCount.toString());

                return true;
            } catch (error) {
                console.error('数据同步失败:', error);
                return false;
            }
        }

        async function forceSyncAllData() {
            try {
                const success = await syncDataFromSupabase();

                if (success) {
                    if (document.getElementById('homePage').classList.contains('active')) {
                        updateHomePage();
                    }

                    if (document.getElementById('myOrdersPage').classList.contains('active')) {
                        renderUserOrders('all');
                    }

                    if (document.getElementById('adminPanel').classList.contains('active')) {
                        const activeFilterBtn = document.querySelector('.filter-btn.active');
                        const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                        renderOrders(activeFilter);

                        const activeMealFilterBtn = document.querySelector('.meal-filter-btn.active');
                        const activeMealFilter = activeMealFilterBtn ? activeMealFilterBtn.dataset.mealFilter : 'all';
                        updateMealList(activeMealFilter);
                    }

                    showNotification('数据同步完成', 'success');
                } else {
                    showNotification('同步失败，请检查网络连接', 'error');
                }
            } catch (error) {
                console.error('强制同步失败:', error);
                showNotification('同步失败，请检查网络连接', 'error');
            }
        }

        // ==================== 离开页面提示功能 ====================
        window.addEventListener('beforeunload', function (e) {
            e.preventDefault();
            e.returnValue = '确定要离开页面吗？您的操作可能未保存。';
            return '确定要离开页面吗？您的操作可能未保存。';
        });

        // ==================== 通知功能 ====================
        function showNotification(message, type = 'info') {
            const existingNotification = document.querySelector('.custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = 'custom-notification';
            notification.style.cssText = `
                position: fixed;
                top: 15px;
                right: 15px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#e31837' : '#e31837'};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                z-index: 1000;
                font-weight: bold;
                animation: slideIn 0.3s ease;
                max-width: 350px;
                font-size: 0.85rem;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // 添加动画样式
        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyle);
    </script>
</body>
</html>
